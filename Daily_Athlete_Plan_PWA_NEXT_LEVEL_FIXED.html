
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Daily Athlete Plan — NEXT LEVEL (PWA)</title>
<meta name="theme-color" content="#000000" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-title" content="Daily Athlete Plan" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 256'%3E%3Crect width='256' height='256' rx='56' fill='white'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Times New Roman' font-size='140' font-weight='700'%3ED%3C/text%3E%3C/svg%3E" />
<style>
  :root { --text:#000; --muted:#2b2b2b; --soft:#e6e6e6; --bg:#fff; }
  html, body { height:100%; }
  * { box-sizing:border-box; }
  body { margin:0; font-family:"Times New Roman", Times, serif; color:var(--text); background:#fff; font-weight:700; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
  .container { max-width:960px; margin:0 auto; padding:16px; min-height:100dvh; padding-bottom:144px; background:#fff; }
  h1{font-size:28px;margin:0 0 6px;} h2{font-size:22px;margin:0 0 10px;} h3{font-size:20px;margin:0 0 8px;} p.muted{color:#2b2b2b;margin:0;font-size:15px;}
  .card{background:#fff;border:1px solid #e6e6e6;border-radius:12px;padding:16px;margin-bottom:16px;}
  .grid{display:grid;grid-gap:12px;} .grid-2{grid-template-columns:1fr 1fr;} .grid-3{grid-template-columns:1fr 1fr 1fr;} @media (max-width:760px){.grid-2,.grid-3{grid-template-columns:1fr;}}
  label{display:block;font-size:13px;margin-bottom:6px;color:#2b2b2b;}
  input,select,button,textarea{font-family:"Times New Roman", Times, serif;font-weight:700;color:#000;background:#fff;}
  input[type="number"],input[type="text"],select,textarea{width:100%;border:1px solid #e6e6e6;border-radius:10px;padding:10px 12px;font-size:16px;outline:none;background:#fff;}
  textarea{min-height:84px;resize:vertical;}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
  .btn{border:1px solid #e6e6e6;border-radius:12px;padding:10px 14px;background:#fff;cursor:pointer;}
  .btn:active{transform:translateY(1px);} .btn.primary{background:#000;color:#fff;border-color:#000;}
  .likert-row{border:1px solid #e6e6e6;border-radius:10px;padding:12px;background:#fff;}
  .likert-label{font-size:16px;margin-bottom:8px;white-space:normal;}
  .likert{display:flex;gap:6px;flex-wrap:wrap;}
  .likert button{width:44px;height:44px;border-radius:8px;border:1px solid #e6e6e6;background:#fff;font-size:16px;}
  .likert button.active{background:#000;color:#fff;border-color:#000;}
  .kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;} @media (max-width:560px){.kpi-grid{grid-template-columns:1fr 1fr;}}
  .kpi{border:1px solid #e6e6e6;border-radius:12px;padding:12px;text-align:center;background:#fff;}
  .kpi small{display:block;color:#2b2b2b;font-size:13px;margin-bottom:3px;}
  .pill{display:inline-block;font-size:12px;padding:4px 10px;border-radius:999px;border:1px solid #e6e6e6;color:#2b2b2b;background:#fff;}
  .verse{border-left:3px solid #e6e6e6;padding-left:10px;background:#fff;}
  .sticky{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid #e6e6e6;padding:12px 16px;}
  .sticky-inner{max-width:960px;margin:0 auto;display:grid;grid-template-columns:repeat(7,1fr);gap:8px;}
  @media (max-width:640px){.sticky-inner{grid-template-columns:1fr 1fr 1fr;}}
  .sticky .block{display:flex;flex-direction:column;} .sticky small{color:#2b2b2b;}
  .center-between{display:flex;align-items:center;justify-content:space-between;gap:8px;}
  .hide{display:none;} .mb-8{margin-bottom:8px;} ul{margin:0;padding-left:18px;}
  .note{color:#2b2b2b;font-size:12px;}
</style>
</head>
<body>
  <div class="container">
    <div class="center-between mb-8">
      <div>
        <h1>Daily Athlete Plan — NEXT LEVEL</h1>
        <p class="muted">Gym-goers • Bodybuilders • Athletes • PWA • Offline • Installable</p>
      </div>
      <div class="row">
        <button id="installBtn" class="btn primary hide" aria-label="Install app">Install App</button>
        <button id="exportBtn" class="btn" aria-label="Print or share">Print / Share</button>
        <button id="unitsBtn" class="btn" aria-label="Toggle units">Metric</button>
      </div>
    </div>

    <!-- === Profile === -->
    <div class="card">
      <div class="center-between mb-8">
        <h2>Profile</h2>
        <span id="readinessPill" class="pill">Readiness —</span>
      </div>
      <div class="grid grid-3">
        <div class="grid"><label for="sex">Sex</label><select id="sex"><option value="female">Female</option><option value="male">Male</option></select></div>
        <div class="grid"><label for="age">Age (years)</label><input id="age" type="number" value="24" /></div>
        <div class="grid"><label for="rhr">Resting HR (bpm)</label><input id="rhr" type="number" placeholder="Optional (50–75)" /></div>

        <div class="grid" id="heightUS"><label>Height (ft / in)</label><div class="row"><input id="heightFt" type="number" placeholder="ft" value="5" /><input id="heightIn" type="number" placeholder="in" value="6" /></div></div>
        <div class="grid hide" id="heightMetric"><label for="heightCm">Height (cm)</label><input id="heightCm" type="number" value="167.6" /></div>

        <div class="grid" id="weightUS"><label for="weightLb">Weight (lbs)</label><input id="weightLb" type="number" value="150" /></div>
        <div class="grid" id="goalWeightUS"><label for="goalWeightLb">Goal weight (lbs)</label><input id="goalWeightLb" type="number" value="145" /></div>

        <div class="grid hide" id="weightMetric"><label for="weightKg">Weight (kg)</label><input id="weightKg" type="number" value="68" /></div>
        <div class="grid hide" id="goalWeightMetric"><label for="goalWeightKg">Goal weight (kg)</label><input id="goalWeightKg" type="number" value="65.8" /></div>

        <div class="grid"><label for="activity">Activity level</label><select id="activity"><option value="sedentary">Sedentary</option><option value="light">Light (1–3 d/wk)</option><option value="moderate" selected>Moderate (3–5 d/wk)</option><option value="heavy">Heavy (6–7 d/wk)</option><option value="athlete">Athlete / 2-a-days</option></select></div>
        <div class="grid"><label for="sleepLast">Sleep last night (hours)</label><input id="sleepLast" type="number" step="0.1" value="7.0" /></div>
        <div class="grid"><label for="sessionType">Today's focus</label><select id="sessionType"><option value="hypertrophy" selected>Hypertrophy / Strength</option><option value="power">Power / Sprint / Skill</option><option value="endurance">Endurance / Conditioning</option><option value="recovery">Recovery / Mobility</option><option value="competition">Competition</option></select></div>
        <div class="grid"><label for="sessionMin">Session duration (min)</label><input id="sessionMin" type="number" value="60" /></div>
        <div class="grid" id="cycleWrap"><label for="cycle">Menstrual cycle phase</label><select id="cycle"><option value="menstruation">Menstruation</option><option value="follicular" selected>Follicular</option><option value="ovulatory">Ovulatory</option><option value="luteal">Luteal</option></select><span class="note">(shown only if Sex = Female)</span></div>
        <div class="grid">
          <label for="protEmphasis">Protein Emphasis</label>
          <select id="protEmphasis">
            <option value="normal">Normal</option>
            <option value="high" selected>High</option>
            <option value="very">Very High</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:12px;"><button id="copyBtn" class="btn">Copy Plan</button><button id="ideasBtn" class="btn">Meal Ideas</button></div>
    </div>

    <!-- === Mental Check-In === -->
    <div class="card">
      <h2>15-Question Mental Health Check-In (1 = Very Low • 5 = Very High)</h2>
      <div id="likertList" style="max-height:460px;overflow:auto;"></div>
      <p class="muted" style="margin-top:8px;">Reverse-scored: Stress, Anxiety, Soreness, Fatigue, Distractions.</p>
    </div>

    <div class="card"><h3>Today’s Plan</h3><div id="planBlocks"></div></div>

    <div class="card">
      <h3>Daily Macros (High-Protein Default)</h3>
      <p class="muted">Goal from goal weight: <b id="goalTag">MAINTAIN</b></p>
      <div class="grid grid-2">
        <div class="grid"><span class="muted">BMR</span><b id="bmr">— kcal</b></div>
        <div class="grid"><span class="muted">TDEE</span><b id="tdee">— kcal</b></div>
        <div class="grid"><span class="muted">Target kcal</span><b id="target">— kcal</b></div>
        <div class="grid"><span class="muted">Protein g/kg (cap 2.7)</span><b id="protModel">— g/kg</b></div>
      </div>
      <div class="kpi-grid" style="margin-top:8px;">
        <div class="kpi"><small>Protein</small><b id="gP">—g</b></div>
        <div class="kpi"><small>Carbs</small><b id="gC">—g</b></div>
        <div class="kpi"><small>Fats</small><b id="gF">—g</b></div>
        <div class="kpi"><small>Fiber (min)</small><b id="gFiber">—g</b></div>
      </div>
      <div id="ideas" class="hide" style="margin-top:10px;"></div>
      <p class="muted" style="margin-top:8px;" id="protNotes"></p>
    </div>

    <!-- === Women: Supplements by Cycle (educational) === -->
    <div class="card" id="cycleSuppCard">
      <h3>Supplement Considerations (Women)</h3>
      <div id="cycleSupp"></div>
      <p class="note">Educational only. Not medical advice.</p>
    </div>

    <div class="card">
      <h3>Cold Plunge</h3>
      <div class="grid grid-2">
        <div class="grid"><span class="muted">Recommend</span><b id="coldYesNo">—</b></div>
        <div class="grid"><span class="muted">Timing</span><b id="coldTiming">—</b></div>
      </div>
      <div id="coldExtra" class="grid hide" style="margin-top:6px;">
        <div class="grid"><span class="muted">Temperature</span><b id="coldTemp"></b></div>
        <div class="grid"><span class="muted">Duration</span><b id="coldDur"></b></div>
      </div>
      <div><span class="muted" id="coldWhy"></span></div>
    </div>

    <!-- === VO2 / Zones === -->
    <div class="card">
      <h3>VO₂ & Heart-Rate Zones</h3>
      <p class="muted">Targets based on age, optional Resting HR, and today’s goal. Zone 2 uses %HRR (preferred) or %HRmax fallback.</p>
      <div class="grid grid-2">
        <div class="grid"><span class="muted">HRmax (est.)</span><b id="hrMax">— bpm</b></div>
        <div class="grid"><span class="muted">HRrest</span><b id="hrRest">— bpm</b></div>
      </div>
      <div class="grid grid-3" id="zoneTable"></div>
      <div class="likert-row" id="zonePrescription"></div>
    </div>

    <div class="card">
      <h3>VO₂ Max Goal for Today</h3>
      <div class="grid grid-2">
        <div class="grid"><span class="muted">Estimated VO₂ max</span><b id="vo2max">— ml/kg/min</b></div>
        <div class="grid"><span class="muted">Classification</span><b id="vo2class">—</b></div>
      </div>
      <div class="likert-row" id="vo2target"></div>
      <p class="note">VO₂max ≈ 15.3 × (HRmax / HRrest). Enter Resting HR for best accuracy.</p>
    </div>

    <div class="card">
      <h3>Weekly Conditioning Targets</h3>
      <div class="grid grid-3">
        <div class="kpi"><small>Z2 minutes (goal)</small><b id="wkZ2Goal">—</b></div>
        <div class="kpi"><small>Z5 minutes (goal)</small><b id="wkZ5Goal">—</b></div>
        <div class="kpi"><small>Completed</small><b id="wkDone">—</b></div>
      </div>
      <div class="row" style="margin-top:8px;">
        <button id="addZ2" class="btn">+5 min Z2</button>
        <button id="addZ5" class="btn">+1 min Z5</button>
        <button id="resetWeek" class="btn">Reset Week</button>
      </div>
      <p class="note">Progress saves on this device. Adjusts goals by activity level and session choice.</p>
    </div>

    <div class="card">
      <h3>Tonight’s Sleep</h3>
      <div class="grid grid-2">
        <div class="grid"><span class="muted">Recommended duration</span><b style="font-size:28px;" id="sleepNeed">—</b><span class="muted">hours</span></div>
        <div class="grid"><span class="muted">Pre-sleep wind-down</span><ul><li id="sleepBreath">5–10 min downshift breathing</li><li>90 min before bed: hot shower/bath</li><li>Limit screens & caffeine late</li></ul></div>
      </div>
      <div class="likert-row" id="sleepDeepDive"></div>
    </div>

    <div class="card">
      <h3>Hydration & Electrolytes</h3>
      <p class="muted">Gallons (gal). Baseline + session add-on.</p>
      <div class="grid grid-2">
        <div class="grid"><span class="muted">Baseline water</span><b id="hBase">— gal</b></div>
        <div class="grid"><span class="muted">Session extra</span><b id="hExtra">— gal</b></div>
        <div class="grid"><span class="muted">Total today</span><b id="hTotal">— gal</b></div>
        <div class="grid"><span class="muted">Sodium target</span><b id="hNa">—</b></div>
      </div>
    </div>

    <div class="card"><h3>Breathing Session</h3><div id="breathBlock"></div></div>
    <div class="card"><h3>Self-Talk</h3><div id="selfTalk"></div></div>
    <div class="card"><h3>Daily Prayer</h3><div id="prayer"></div></div>

    <div class="card">
      <h3>Scripture for Today (NKJV)</h3>
      <div id="scripture" class="grid" style="grid-gap:10px;"></div>
      <p class="muted">Themes adapt to your check-in. You can merge unlimited verses via <code>window.NKJV_EXTRA</code>.</p>
    </div>
  </div>

  <div class="sticky" role="status" aria-live="polite">
    <div class="sticky-inner">
      <div class="block"><small>Target</small><b id="sumTarget">— kcal</b></div>
      <div class="block"><small>P/C/F</small><b id="sumPCF">—/—/— g</b></div>
      <div class="block"><small>Fiber</small><b id="sumFiber">— g</b></div>
      <div class="block"><small>Sleep</small><b id="sumSleep">— h</b></div>
      <div class="block"><small>Zone</small><b id="sumZone">—</b></div>
      <div class="block"><small>VO₂ Goal</small><b id="sumVo2">—</b></div>
      <div class="block"><small>Week</small><b id="sumWeek">—</b></div>
    </div>
  </div>

<script>
/***** PWA bootstrap *****/
(function setupPWA(){
  const svg = size => `<?xml version="1.0"?><svg xmlns='http://www.w3.org/2000/svg' width='${size}' height='${size}' viewBox='0 0 ${size} ${size}'><rect width='100%' height='100%' rx='${Math.round(size*0.22)}' fill='white'/><text x='50%' y='54%' font-family='Times New Roman' font-weight='700' font-size='${Math.round(size*0.62)}' text-anchor='middle'>D</text></svg>`;
  const makeIcon = size => URL.createObjectURL(new Blob([svg(size)], { type: 'image/svg+xml' }));
  const manifest = { name:'Daily Athlete Plan', short_name:'DAP', start_url:'.', display:'standalone', background_color:'#ffffff', theme_color:'#000000', icons:[ {src:makeIcon(192),sizes:'192x192',type:'image/svg+xml'}, {src:makeIcon(512),sizes:'512x512',type:'image/svg+xml'} ] };
  const manifestURL = URL.createObjectURL(new Blob([JSON.stringify(manifest)], { type:'application/json' }));
  const link=document.createElement('link'); link.rel='manifest'; link.href=manifestURL; document.head.appendChild(link);
  if('serviceWorker' in navigator){
    const swCode = `const CACHE='dap-next-clean-v1';self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE).then(c=>c.addAll([self.registration.scope])).then(()=>self.skipWaiting()))});self.addEventListener('activate',e=>{e.waitUntil(self.clients.claim())});self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(h=>h||fetch(e.request).then(res=>{const cp=res.clone();caches.open(CACHE).then(c=>{if(e.request.method==='GET'&&new URL(e.request.url).origin===location.origin)c.put(e.request,cp);});return res;})))})`;
    const swURL = URL.createObjectURL(new Blob([swCode], { type:'text/javascript' }));
    navigator.serviceWorker.register(swURL).catch(()=>{});
  }
  let deferredPrompt=null; const installBtn=document.getElementById('installBtn');
  window.addEventListener('beforeinstallprompt',(e)=>{e.preventDefault();deferredPrompt=e;installBtn.classList.remove('hide');});
  installBtn?.addEventListener('click',async()=>{if(!deferredPrompt)return;deferredPrompt.prompt();await deferredPrompt.userChoice;installBtn.classList.add('hide');deferredPrompt=null;});
})();
</script>

<script>
/***** Data + helpers *****/
const todayKey=new Date().toISOString().slice(0,10);
const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));
const kgFromLbs=lbs=>lbs*0.45359237; const lbsFromKg=kg=>kg/0.45359237; const cmFromFtIn=(ft,inch)=>((Number(ft)||0)*12+(Number(inch)||0))*2.54;
const ACTIVITY={sedentary:1.2,light:1.375,moderate:1.55,heavy:1.725,athlete:1.9};
function mifflin({sex,kg,cm,age}){const s=sex==='male'?5:-161;return 10*kg+6.25*cm-5*age+s;}
function inferGoal(currentLb,goalLb){const cut=currentLb*0.97,bulk=currentLb*1.03;return goalLb<=cut?'cut':goalLb>=bulk?'bulk':'maintain';}

/* Non-repeating picker */
function getBag(key){try{const raw=localStorage.getItem(key);if(!raw)return{date:todayKey,used:[]};const o=JSON.parse(raw);if(!o||o.date!==todayKey)return{date:todayKey,used:[]};return o;}catch{return{date:todayKey,used:[]};}}
function setBag(key,bag){try{localStorage.setItem(key,JSON.stringify(bag));}catch{}}
function nonRepeatingPick(key,arr,count){const bag=getBag(key);let pool=arr.map((v,i)=>({v,i})).filter(x=>!bag.used.includes(x.i));if(pool.length<count){bag.used=[];setBag(key,bag);} const bag2=getBag(key);let pool2=arr.map((v,i)=>({v,i})).filter(x=>!bag2.used.includes(x.i));for(let i=pool2.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[pool2[i],pool2[j]]=[pool2[j],pool2[i]];}const picks=pool2.slice(0,count);picks.forEach(p=>bag2.used.push(p.i));setBag(key,bag2);return picks.map(p=>p.v);} 

/***** Expanded content pools *****/
const NKJV_BASE={
  courage:[
    {ref:'Joshua 1:9',txt:'Be strong and of good courage; do not be afraid...'},
    {ref:'Deuteronomy 31:6',txt:'Be strong and of good courage... He will not leave you nor forsake you.'},
    {ref:'Psalm 27:1',txt:'The LORD is my light and my salvation; whom shall I fear?'},
    {ref:'Psalm 31:24',txt:'Be of good courage, and He shall strengthen your heart...'},
    {ref:'2 Timothy 1:7',txt:'For God has not given us a spirit of fear, but of power and of love and of a sound mind.'},
    {ref:'Isaiah 41:10',txt:'Fear not, for I am with you... I will strengthen you.'}
  ],
  focus:[
    {ref:'Colossians 3:23',txt:'Whatever you do, do it heartily, as to the Lord and not to men.'},
    {ref:'Proverbs 16:3',txt:'Commit your works to the LORD, and your thoughts will be established.'},
    {ref:'Proverbs 4:25',txt:'Let your eyes look straight ahead...'},
    {ref:'Philippians 3:14',txt:'I press toward the goal for the prize of the upward call...'},
    {ref:'James 1:5',txt:'If any of you lacks wisdom, let him ask of God...'},
    {ref:'Psalm 90:12',txt:'So teach us to number our days, that we may gain a heart of wisdom.'}
  ],
  peace:[
    {ref:'Philippians 4:6–7',txt:'Be anxious for nothing... and the peace of God...'},
    {ref:'John 14:27',txt:'Peace I leave with you, My peace I give to you...'},
    {ref:'Isaiah 26:3',txt:'You will keep him in perfect peace, whose mind is stayed on You...'},
    {ref:'Psalm 46:10',txt:'Be still, and know that I am God...'},
    {ref:'1 Peter 5:7',txt:'Casting all your care upon Him, for He cares for you.'}
  ],
  strength:[
    {ref:'Isaiah 40:31',txt:'Those who wait on the LORD shall renew their strength...'},
    {ref:'Psalm 18:32–33',txt:'It is God who arms me with strength...'},
    {ref:'Habakkuk 3:19',txt:'The LORD God is my strength...'},
    {ref:'Psalm 28:7',txt:'The LORD is my strength and my shield...'},
    {ref:'Ephesians 6:10',txt:'Be strong in the Lord and in the power of His might.'}
  ],
  endurance:[
    {ref:'Hebrews 12:1–2',txt:'...let us run with endurance the race that is set before us...'},
    {ref:'James 1:12',txt:'Blessed is the man who endures temptation...'},
    {ref:'Romans 5:3–4',txt:'Tribulation produces perseverance...'},
    {ref:'Romans 12:12',txt:'Rejoicing in hope, patient in tribulation, continuing steadfastly in prayer.'},
    {ref:'Galatians 6:9',txt:'Let us not grow weary while doing good... for in due season we shall reap...'}
  ],
  help:[
    {ref:'Psalm 46:1',txt:'God is our refuge and strength, a very present help in trouble.'},
    {ref:'Psalm 34:17',txt:'The righteous cry out, and the LORD hears...'},
    {ref:'Psalm 121:1–2',txt:'I will lift up my eyes to the hills—My help comes from the LORD.'},
    {ref:'Isaiah 41:13',txt:'For I, the LORD your God, will hold your right hand... Fear not, I will help you.'}
  ],
  hope:[
    {ref:'Lamentations 3:22–23',txt:'Through the LORD’s mercies we are not consumed...'},
    {ref:'Romans 15:13',txt:'Now may the God of hope fill you with all joy and peace...'},
    {ref:'Psalm 33:18',txt:'Behold, the eye of the LORD is on those who fear Him...'},
    {ref:'Jeremiah 29:11',txt:'For I know the thoughts that I think toward you... to give you a future and a hope.'}
  ],
  recovery:[
    {ref:'Matthew 11:28–29',txt:'Come to Me, all you who labor and are heavy laden...'},
    {ref:'Psalm 23:1–3',txt:'The LORD is my shepherd... He restores my soul...'},
    {ref:'3 John 2',txt:'Beloved, I pray that you may prosper in all things and be in health...'},
    {ref:'Psalm 147:3',txt:'He heals the brokenhearted and binds up their wounds.'}
  ],
  victory:[
    {ref:'1 Corinthians 9:24–25',txt:'Run in such a way that you may obtain it...'},
    {ref:'1 John 5:4',txt:'For whatever is born of God overcomes the world...'},
    {ref:'Romans 8:37',txt:'In all these things we are more than conquerors through Him who loved us.'},
    {ref:'Psalm 20:7',txt:'Some trust in chariots, and some in horses; but we will remember the name of the LORD our God.'}
  ]
};
const NKJV = (()=>{const extra=(window.NKJV_EXTRA||{}); const out={}; const themes=new Set([...Object.keys(NKJV_BASE),...Object.keys(extra)]); themes.forEach(t=>{out[t]=[...(NKJV_BASE[t]||[]),...((extra[t]||[]))];}); return out;})();

/* Breathing techniques expanded */
const BREATH={
  downshift:[
    {title:'Physiological Sighs',detail:'Nasal inhale; top-up sniff; long slow exhale.',duration:'5–10 min'},
    {title:'Resonant 5.5 bpm',detail:'In 4–5 s, out 6–7 s.',duration:'5–10 min'},
    {title:'4-7-8',detail:'In 4 • Hold 7 • Out 8.',duration:'4–8 min'},
    {title:'Extended Exhale 1:2',detail:'In 3 s • Out 6 s.',duration:'3–10 min'},
    {title:'Box 3-3-6-3',detail:'In 3 • Hold 3 • Out 6 • Hold 3.',duration:'4–8 min'},
    {title:'Guided Body Scan',detail:'Slow nasal breathing while scanning tension from head to toe.',duration:'6–12 min'}
  ],
  focus:[
    {title:'Box 4-4-4-4',detail:'In 4 • Hold 4 • Out 4 • Hold 4.',duration:'3–6 min'},
    {title:'Tactical 4/4',detail:'In 4 • Out 4.',duration:'3–10 min'},
    {title:'Nasal Tempo',detail:'Even cadence matched to metronome.',duration:'5–10 min'},
    {title:'Cadence Ramp',detail:'3 min steady • 1 min faster • repeat.',duration:'6–10 min'}
  ]
};

/* Meal ideas expanded (high-protein bias) */
const MEALS={
  breakfast:[
    'Greek yogurt (2%) + whey + berries + honey',
    'Eggs + egg whites + sourdough + fruit',
    'Overnight oats (milk) + chia + banana (+ whey)',
    'Protein pancakes + peanut butter + blueberries',
    'Cottage cheese bowl: pineapple + granola',
    'Smoked salmon + eggs + potato + spinach',
    'Turkey sausage egg bites + fruit',
    'Tofu scramble + black beans + avocado',
    'High-protein granola + milk + banana',
    'Quark or skyr + walnuts + honey'
  ],
  lunch:[
    'Chicken rice bowl (olive oil) + veggies',
    'Turkey sandwich + cheese + fruit',
    'Tuna pasta salad + spinach',
    'Beef burrito bowl + beans + salsa',
    'Shrimp quinoa bowl + avocado',
    'Lentil soup + whole grain toast + yogurt',
    'Grilled chicken Caesar (light) + fruit',
    'Soba noodles + edamame + sesame chicken',
    'Pita + hummus + chicken shawarma',
    'Greek salad + chicken + pita'
  ],
  dinner:[
    'Salmon + potatoes + salad (olive oil)',
    'Beef tacos (corn tortillas) + guac',
    'Stir-fry tofu/chicken + rice',
    'Pork tenderloin + rice pilaf + green beans',
    'Chicken parmesan + pasta + side salad',
    'Turkey chili + rice + side veggies',
    'Baked cod + couscous + asparagus',
    'Bison burger (no bun) + sweet potato + slaw',
    'Chicken stir-fry + udon',
    'Paneer tikka + basmati + cucumber salad'
  ],
  snack:[
    'Protein shake + banana',
    'Cottage cheese + crackers',
    'Trail mix (portion) + fruit',
    'String cheese + apple + almonds',
    'Greek yogurt + granola',
    'Beef jerky + orange',
    'Edamame + sea salt',
    'Hummus + carrots + turkey roll-ups',
    'Rice cakes + peanut butter + whey shake',
    'Chocolate milk (post-workout)'
  ]
};

/* Sex-specific self-talk pools */
const SELF_TALK={
  female:{
    boost:['I am capable, composed, and powerful.','My breath sets my rhythm; my rhythm sets my performance.','Strength and grace work together in me.','I finish what I start with great form.'],
    focus:['I aim my attention where it matters.','I keep my eyes where my feet need to go.','Precision over panic.'],
    calm:['Pressure reveals my poise.','I slow my breath and lead my body.','Calm first, then fast.'],
    grit:['Discipline over mood — I execute.','I can do hard things, well.']
  },
  male:{
    boost:['Calm focus and decisive action.','I do the hard things well.','I control my breathing, my tempo, my outcome.','Strong and precise from first rep to last.'],
    focus:['Laser on the next rep; nothing extra.','Simple, crisp, repeatable actions.','Form first, then force.'],
    calm:['My breath steadies my mind.','Relax everything not needed for this rep.'],
    grit:['Discipline over mood — I execute.','Finish strong: efficient, fast, relentless.']
  }
};

/* Rotating prayers */
const PRAYERS=[
  'Lord, grant me wisdom, steady breath, and strength to honor You in every choice today. Amen.',
  'Father, guide my steps, protect my mind from distraction, and help me serve others with joy. Amen.',
  'Jesus, shape my effort and attitude. Keep me humble in victory and teachable in struggle. Amen.',
  'God, quiet my anxiety, sharpen my focus, and fill me with courage to do what is right. Amen.',
  'Lord, thank You for this day. Help me to steward my body and gifts for Your glory. Amen.',
  'Father, renew my strength and guard my thoughts as I train and recover. Amen.'
];

/***** Elements *****/
const $=id=>document.getElementById(id);
const els={sex:$("sex"),age:$("age"),rhr:$("rhr"),heightUS:$("heightUS"),heightFt:$("heightFt"),heightIn:$("heightIn"),heightMetric:$("heightMetric"),heightCm:$("heightCm"),weightUS:$("weightUS"),weightLb:$("weightLb"),goalWeightUS:$("goalWeightUS"),goalWeightLb:$("goalWeightLb"),weightMetric:$("weightMetric"),weightKg:$("weightKg"),goalWeightMetric:$("goalWeightMetric"),goalWeightKg:$("goalWeightKg"),activity:$("activity"),sleepLast:$("sleepLast"),sessionType:$("sessionType"),sessionMin:$("sessionMin"),cycleWrap:$("cycleWrap"),cycle:$("cycle"),protEmphasis:$("protEmphasis"),unitsBtn:$("unitsBtn"),exportBtn:$("exportBtn"),copyBtn:$("copyBtn"),ideasBtn:$("ideasBtn"),goalTag:$("goalTag"),bmr:$("bmr"),tdee:$("tdee"),target:$("target"),protModel:$("protModel"),gP:$("gP"),gC:$("gC"),gF:$("gF"),gFiber:$("gFiber"),protNotes:$("protNotes"),sleepNeed:$("sleepNeed"),sleepBreath:$("sleepBreath"),hBase:$("hBase"),hExtra:$("hExtra"),hTotal:$("hTotal"),hNa:$("hNa"),coldYesNo:$("coldYesNo"),coldTiming:$("coldTiming"),coldExtra:$("coldExtra"),coldTemp:$("coldTemp"),coldDur:$("coldDur"),coldWhy:$("coldWhy"),sumTarget:$("sumTarget"),sumPCF:$("sumPCF"),sumFiber:$("sumFiber"),sumSleep:$("sumSleep"),sumZone:$("sumZone"),sumVo2:$("sumVo2"),sumWeek:$("sumWeek"),likertList:$("likertList"),ideas:$("ideas"),planBlocks:$("planBlocks"),readinessPill:$("readinessPill"),breathBlock:$("breathBlock"),scripture:$("scripture"),selfTalk:$("selfTalk"),prayer:$("prayer"),hrMax:$("hrMax"),hrRest:$("hrRest"),zoneTable:$("zoneTable"),zonePrescription:$("zonePrescription"),cycleSupp:$("cycleSupp"),cycleSuppCard:$("cycleSuppCard"),vo2max:$("vo2max"),vo2class:$("vo2class"),vo2target:$("vo2target"),wkZ2Goal:$("wkZ2Goal"),wkZ5Goal:$("wkZ5Goal"),wkDone:$("wkDone"),addZ2:$("addZ2"),addZ5:$("addZ5"),resetWeek:$("resetWeek") };

/***** Questions *****/
const QUESTIONS=[
  {id:'conf',label:'Confidence (1 = very low • 5 = very high)'},
  {id:'focus',label:'Focus on task (1 = scattered • 5 = locked in)'},
  {id:'motivation',label:'Motivation to train (1 = none • 5 = high)'},
  {id:'stress',label:'Stress (1 = none • 5 = very high; reverse-scored)',reverse:true},
  {id:'mood',label:'Mood (1 = poor • 5 = great)'},
  {id:'anxiety',label:'Performance anxiety (1 = calm • 5 = severe; reverse-scored)',reverse:true},
  {id:'readiness',label:'Overall readiness (1 = low • 5 = high)'},
  {id:'soreness',label:'Soreness (1 = none • 5 = severe; reverse-scored)',reverse:true},
  {id:'fatigue',label:'Fatigue (1 = fresh • 5 = exhausted; reverse-scored)',reverse:true},
  {id:'selftalk',label:'Self-talk quality (1 = negative • 5 = positive)'},
  {id:'purpose',label:'Clarity of goals (1 = unclear • 5 = crystal clear)'},
  {id:'distraction',label:'Distractions (1 = none • 5 = constant; reverse-scored)',reverse:true},
  {id:'support',label:'Support from others (1 = none • 5 = strong)'},
  {id:'calm',label:'Calm under pressure (1 = shaky • 5 = steady)'},
  {id:'drive',label:'Drive to push (1 = off • 5 = on)'}
];
let units='us'; let answers={}; QUESTIONS.forEach(q=>answers[q.id]=3);

/***** Calculators *****/
const sleepBase=sex=>sex==='female'?8.5:7.8;
function baselineProt(goal){ return goal==='cut'?2.1 : goal==='bulk'?1.8 : 2.0; }
function emphasisBump(emph){ return emph==='very'?0.5 : emph==='high'?0.25 : 0.0; }
function dynamicProtAdd({sleepHours,sessionMin,sessionType,soreness,goal}){ let add=0; if(sleepHours<7) add+=0.15; if(sessionMin>=75||['hypertrophy','endurance','competition','power'].includes(sessionType)) add+=0.10; if(soreness>=4) add+=0.10; if(goal==='cut') add+=0.10; return add; }
function fatPerKgDefault(){ return 0.9; }

/* VO2 helpers */
function estHRmax(age){ return Math.round(208 - 0.7*age); } // Tanaka
function zonesFromHR(age,rhr){ const HRmax=estHRmax(age); const useHRR = !!rhr && rhr>30 && rhr<110; const r = (pct)=> useHRR? Math.round(((HRmax - rhr)*pct + rhr)) : Math.round(HRmax*pct); const Z={ Z1:[r(0.5), r(0.6)], Z2:[r(0.6), r(0.7)], Z3:[r(0.7), r(0.8)], Z4:[r(0.8), r(0.9)], Z5:[r(0.9), r(1.0)] }; return {HRmax, useHRR, Z}; }
function estVO2max(HRmax, HRrest){ if(!HRmax || !HRrest) return null; return 15.3 * (HRmax / HRrest); } // Uth et al.

function vo2Class(sex,age,vo2){
  if(!vo2) return '—';
  const bands = sex==='male'
    ? [ {t:'Excellent',min:55}, {t:'Good',min:47}, {t:'Average',min:40}, {t:'Below Avg',min:0} ]
    : [ {t:'Excellent',min:50}, {t:'Good',min:43}, {t:'Average',min:36}, {t:'Below Avg',min:0} ];
  for(const b of bands) if(vo2>=b.min) return b.t;
  return '—';
}

function vo2TargetForDay(sessionType, Z){
  if(sessionType==='endurance'){
    return {label:'Z2 aerobic base', minutes:'30–45 (build to 60–90)', bpm: Z.Z2 };
  } else if(sessionType==='power'){
    return {label:'Z5 VO₂ intervals', minutes:'6–10 total at high effort', bpm: Z.Z5 };
  } else if(sessionType==='recovery'){
    return {label:'Z1–Z2 easy', minutes:'20–30', bpm: Z.Z2 };
  } else if(sessionType==='competition'){
    return {label:'Z1–Z2 + sport warm-ups', minutes:'as sport-specific', bpm: Z.Z2 };
  } else { // hypertrophy/strength
    return {label:'Z1–Z2 support', minutes:'15–20 warm-up/cool-down', bpm: Z.Z2 };
  }
}

/* Sleep deep-dive tips */
function sleepDeepDiveTips(){ return [
  'Aim ≥ 7 hours on average; some need more.',
  'Morning outdoor light; dim evenings; dark, cool bedroom (~63–68°F).',
  'Consistent schedule; limit late caffeine; minimize long naps.',
  'If awake >20–30 min, get out of bed briefly; keep bed for sleep.'
]; }

/***** Weekly conditioning tracker *****/
function getWeekKey(){ const now=new Date(); const y=now.getFullYear(); const first=new Date(y,0,1); const days=Math.floor((now-first)/86400000); const week=Math.ceil((days+first.getDay()+1)/7); return y+'-W'+week; }
function loadWeek(){ try{const raw=localStorage.getItem('dapWeek'); if(!raw) return {key:getWeekKey(), z2:0, z5:0}; const o=JSON.parse(raw)||{}; if(o.key!==getWeekKey()) return {key:getWeekKey(), z2:0, z5:0}; return o;}catch{return {key:getWeekKey(), z2:0, z5:0};} }
function saveWeek(o){ try{localStorage.setItem('dapWeek', JSON.stringify(o));}catch{} }
function weekGoals(activity, sessionType){
  let z2=120, z5=8;
  if(activity==='light'){ z2=90; z5=6; }
  if(activity==='moderate'){ z2=150; z5=10; }
  if(activity==='heavy'){ z2=180; z5=12; }
  if(activity==='athlete'){ z2=210; z5=15; }
  if(sessionType==='endurance') z2+=30;
  if(sessionType==='power') z5+=3;
  return {z2,z5};
}

/***** UI builders *****/
function buildLikert(){
  els.likertList.innerHTML='';
  QUESTIONS.forEach(q=>{
    const row=document.createElement('div'); row.className='likert-row';
    const label=document.createElement('div'); label.className='likert-label'; label.textContent=q.label;
    const group=document.createElement('div'); group.className='likert';
    [1,2,3,4,5].forEach(v=>{
      const b=document.createElement('button'); b.type='button'; b.textContent=v;
      b.setAttribute('aria-pressed', (answers[q.id]===v) ? 'true' : 'false');
      if(answers[q.id]===v) b.classList.add('active');
      b.addEventListener('click',()=>{ answers[q.id]=v; buildLikert(); compute(); saveState(); });
      group.appendChild(b);
    });
    row.appendChild(label); row.appendChild(group); els.likertList.appendChild(row);
  });
}

/* Cold plunge logic */
function coldPlungePlanner({sex,goal,sessionType,readiness,soreness,cycle}){
  const rec={recommend:false,rationale:'',timing:'',tempC:10,tempF:50,durationMin:0};
  const lowReadiness=readiness<3, highSoreness=soreness>=4, growth=(goal==='bulk'||sessionType==='hypertrophy');
  if(growth){ rec.recommend=highSoreness||lowReadiness; rec.rationale='Growth focus: avoid immediate post-lift cold; use for soreness/fatigue if needed.'; rec.timing='If used: 6–12+ h after lifting or next morning.'; rec.durationMin=rec.recommend?6:0; }
  else if(['competition','endurance','power'].includes(sessionType)){ rec.recommend=true; rec.rationale='Recovery/turnaround focus.'; rec.timing='Within 0–60 min post-session or later in day.'; rec.durationMin=6; }
  else if(sessionType==='recovery'){ rec.recommend=true; rec.rationale='Recovery day; short, moderate cold.'; rec.timing='Any time, earlier in day.'; rec.durationMin=5; }
  if(sex==='female'&&cycle==='luteal'){ rec.tempC=12; rec.tempF=54; if(rec.durationMin>0) rec.durationMin=Math.max(4,rec.durationMin-1); rec.rationale+=' Luteal: slightly warmer/shorter.'; }
  if(!rec.recommend) rec.durationMin=0; return rec;
}

/* Breathing plan */
function breathingPlanner({stress,anxiety,readiness,sleepDebt}){
  const needDown=(readiness<3||stress>=4||anxiety>=4||sleepDebt>1);
  const bagKey='breath-'+todayKey+'-'+(needDown?'down':'focus');
  const picks=nonRepeatingPick(bagKey,needDown?BREATH.downshift:BREATH.focus,3);
  const focus=needDown?'Downshift':'Up-regulate / Focus';
  return{focus,items:picks};
}

/* Scripture plan */
function scripturePlanner(ctx){
  const picks=[];
  const add=(theme,count)=>{ if(!NKJV[theme])return; const key='script-'+todayKey+'-'+theme; picks.push(...nonRepeatingPick(key,NKJV[theme],count)); };
  const {stress,anxiety,moodLow,confidenceLow,distractionHigh,supportLow,driveLow,readinessHigh,competitionDay,recoveryDay,purposeLow,calmLow,fatigueHigh}=ctx;
  if(competitionDay)add('victory',2);
  if(readinessHigh)add('strength',1);
  if(confidenceLow)add('courage',1);
  if(stress||anxiety)add('peace',1);
  if(moodLow||fatigueHigh)add('recovery',1);
  if(purposeLow||distractionHigh)add('focus',1);
  if(supportLow)add('help',1);
  if(driveLow)add('endurance',1);
  if(!picks.length)add('hope',1);
  return picks.slice(0,6);
}

/* Self-talk */
function selfTalkPlanner(sex,answers){
  const bank=SELF_TALK[sex]; const out=[];
  const low=(k)=>Number(answers[k]||3)<=2; const high=(k)=>Number(answers[k]||3)>=4;
  if(low('conf')) out.push(bank.boost[0]);
  if(high('distraction')) out.push(bank.focus[0]);
  if(high('stress')||high('anxiety')) out.push(bank.calm[0]);
  if(low('drive')) out.push(bank.grit[0]);
  if(out.length<3) out.push(bank.boost[1]||bank.focus[1]);
  if(out.length<3) out.push(bank.focus[2]||bank.calm[1]);
  return out.slice(0,3);
}

/* Day plan */
function dayPlan({goal,sessionType,readiness,soreness,sleepDebt}){
  const blocks=[];
  if(readiness<2.5||sleepDebt>1.5){
    blocks.push({label:'Training',text:'Easy day: technique + mobility + Zone 2 (15–25 min). Optional light accessories.'});
  }else if(soreness>=4){
    blocks.push({label:'Training',text:'Reduce volume 25–40%. Keep intensity moderate. Emphasize long rest and form.'});
  }else{
    let txt='Proceed as planned.';
    if(goal==='cut'&&sessionType==='hypertrophy')txt='Quality reps; 8–15 reps; avoid failure on first sets.';
    if(goal==='bulk'&&sessionType==='hypertrophy')txt='Add a back-off set or +5–10% accessory volume.';
    if(sessionType==='endurance')txt='Main set steady; finish with 4–6 strides.';
    if(sessionType==='power')txt='Full recovery between sets; crisp, fast reps.';
    if(sessionType==='recovery')txt='Mobility, easy aerobic 15–30 min, light tissue work.';
    if(sessionType==='competition')txt='Warm-up progression + taper volume; post-comp refuel and brief cold if desired.';
    blocks.push({label:'Training',text:txt});
  }
  if(goal==='cut')blocks.push({label:'Nutrition',text:'Front-load protein (≥35–45 g breakfast). Distribute protein 3–5 meals. Carbs near training.'});
  else if(goal==='bulk')blocks.push({label:'Nutrition',text:'Add one carb feeding around training. Ensure +300–400 kcal and ≥1.8 g/kg protein.'});
  else blocks.push({label:'Nutrition',text:'Even protein distribution. Carbs pre/post-session. Fats moderate.'});
  if(readiness<3||soreness>=4)blocks.push({label:'Recovery',text:'10–20 min mobility; optional cold per guidance; 10 min breathing; evening walk.'});
  else blocks.push({label:'Recovery',text:'5–10 min mobility and cooldown. Walk after dinner.'});
  if(sleepDebt>0.5)blocks.push({label:'Sleep',text:'Earlier wind-down tonight. Optional 20 min nap before 3 pm.'});
  else blocks.push({label:'Sleep',text:'Consistent schedule; protect 90-min pre-bed routine.'});
  return blocks;
}

/* Meals UI */
function renderMealIdeas(p,c,f){
  const P=Math.max(0,Math.round(p*0.93));
  const C=Math.max(0,Math.round(c*0.93));
  const F=Math.max(0,Math.round(f*0.93));
  const part=(pp,cc,ff,r)=>({P:Math.round(pp*r),C:Math.round(cc*r),F:Math.round(ff*r)});
  const B=part(P,C,F,.25),L=part(P,C,F,.30),D=part(P,C,F,.35),S=part(P,C,F,.10);
  const picks={
    breakfast:nonRepeatingPick('meal-breakfast-'+todayKey,MEALS.breakfast,4),
    lunch:nonRepeatingPick('meal-lunch-'+todayKey,MEALS.lunch,4),
    dinner:nonRepeatingPick('meal-dinner-'+todayKey,MEALS.dinner,4),
    snack:nonRepeatingPick('meal-snack-'+todayKey,MEALS.snack,4)
  };
  els.ideas.innerHTML='';
  const sections=[{t:'Breakfast',m:B,list:picks.breakfast},{t:'Lunch',m:L,list:picks.lunch},{t:'Dinner',m:D,list:picks.dinner},{t:'Snack',m:S,list:picks.snack}];
  sections.forEach(sec=>{
    const box=document.createElement('div');box.className='likert-row';box.style.marginBottom='8px';
    const h=document.createElement('div');h.textContent=sec.t;h.style.marginBottom='4px';
    const t=document.createElement('div');t.style.color='#2b2b2b';t.style.fontSize='13px';t.textContent=`Target ≈ P${sec.m.P}/C${sec.m.C}/F${sec.m.F} g`;
    const ul=document.createElement('ul');sec.list.forEach(it=>{const li=document.createElement('li');li.textContent=it;ul.appendChild(li);});
    box.appendChild(h);box.appendChild(t);box.appendChild(ul);els.ideas.appendChild(box);
  });
  els.ideas.classList.remove('hide');
}

/* Women supplements (non-medical) */
function cycleSupplements(cycle){
  const rec={
    menstruation:['Iron-rich foods; consider iron only if clinician advises','Omega-3 (fish) for cramps/inflammation','Magnesium glycinate 200–300 mg for sleep/relaxation'],
    follicular:['Creatine monohydrate 3–5 g/day (performance)','Protein consistency across meals','Vitamin D if deficient'],
    ovulatory:['Hydration & electrolytes emphasis','Omega-3 rich meals','Light zinc from foods (meat/seafood)'],
    luteal:['Magnesium glycinate 200–300 mg (PMS support)','B-complex from foods (eggs, dairy, greens)','Evening primrose or omega-3 foods']
  };
  return rec[cycle]||[];
}

/***** Persistence *****/
function saveState(){
  const s={sex:els.sex.value,age:els.age.value,rhr:els.rhr.value,heightFt:els.heightFt.value,heightIn:els.heightIn.value,heightCm:els.heightCm.value,weightLb:els.weightLb.value,goalWeightLb:els.goalWeightLb.value,weightKg:els.weightKg.value,goalWeightKg:els.goalWeightKg.value,activity:els.activity.value,sleepLast:els.sleepLast.value,sessionType:els.sessionType.value,sessionMin:els.sessionMin.value,cycle:els.cycle.value,protEmphasis:els.protEmphasis.value,units,answers,savedDate:todayKey};
  try{localStorage.setItem('dapNextClean',JSON.stringify(s));}catch{}
}
function loadState(){
  try{
    const raw=localStorage.getItem('dapNextClean'); if(!raw) return;
    const s=JSON.parse(raw)||{};
    els.sex.value=s.sex||'female'; els.age.value=s.age||24; els.rhr.value=s.rhr||'';
    els.heightFt.value=s.heightFt||5; els.heightIn.value=s.heightIn||6; els.heightCm.value=s.heightCm||167.6;
    els.weightLb.value=s.weightLb||150; els.goalWeightLb.value=s.goalWeightLb||145;
    els.weightKg.value=s.weightKg||68; els.goalWeightKg.value=s.goalWeightKg||65.8;
    els.activity.value=s.activity||'moderate'; els.sleepLast.value=s.sleepLast||7;
    els.sessionType.value=s.sessionType||'hypertrophy'; els.sessionMin.value=s.sessionMin||60;
    els.cycle.value=s.cycle||'follicular'; els.protEmphasis.value=s.protEmphasis||'high';
    units=s.units||'us'; answers=s.answers||answers;
  }catch{}
}

function showUnits(){
  const us=units==='us';
  ['heightUS','weightUS','goalWeightUS'].forEach(id=>els[id].classList.toggle('hide',!us));
  ['heightMetric','weightMetric','goalWeightMetric'].forEach(id=>els[id].classList.toggle('hide',us));
  els.unitsBtn.textContent=us?'Metric':'US';
}
function convertToMetric(){
  const ft=Number(els.heightFt.value)||0,inch=Number(els.heightIn.value)||0;
  els.heightCm.value=(cmFromFtIn(ft,inch)).toFixed(1);
  els.weightKg.value=(kgFromLbs(Number(els.weightLb.value)||0)).toFixed(1);
  els.goalWeightKg.value=(kgFromLbs(Number(els.goalWeightLb.value)||0)).toFixed(1);
}
function convertToUS(){
  const cm=Number(els.heightCm.value)||0; const totalIn=cm/2.54;
  const ft=Math.floor(totalIn/12); const inch=Math.round(totalIn-ft*12);
  els.heightFt.value=ft; els.heightIn.value=inch;
  els.weightLb.value=(lbsFromKg(Number(els.weightKg.value)||0)).toFixed(0);
  els.goalWeightLb.value=(lbsFromKg(Number(els.goalWeightKg.value)||0)).toFixed(0);
}

/***** Main compute *****/
function compute(){
  // Readiness index
  const norm=QUESTIONS.map(q=>{const raw=Number(answers[q.id]||3);return q.reverse?6-raw:raw;});
  const avg=norm.reduce((a,b)=>a+b,0)/norm.length;

  const sex=els.sex.value; const age=Number(els.age.value)||0; const rhr=Number(els.rhr.value)||null;
  const kg=(units==='metric')?(Number(els.weightKg.value)||0):kgFromLbs(Number(els.weightLb.value)||0);
  const cm=(units==='metric')?(Number(els.heightCm.value)||0):cmFromFtIn(Number(els.heightFt.value)||0,Number(els.heightIn.value)||0);
  const currentLb=(units==='metric')?lbsFromKg(Number(els.weightKg.value)||0):(Number(els.weightLb.value)||0);
  const goalLb=(units==='metric')?lbsFromKg(Number(els.goalWeightKg.value)||0):(Number(els.goalWeightLb.value)||0);
  const activity=els.activity.value||'moderate'; const activityFactor=ACTIVITY[activity];
  const sessionType=els.sessionType.value; const sessionMinutes=Number(els.sessionMin.value)||0; const cycle=els.cycle.value; const emph=els.protEmphasis.value;

  const goal=inferGoal(currentLb,goalLb); els.goalTag.textContent=goal.toUpperCase();
  const bmr=Math.round(mifflin({sex,kg,cm,age})); const tdee=Math.round(bmr*activityFactor);
  const delta=goal==='cut'?-400:goal==='bulk'?350:0; const target=Math.max(1200,tdee+delta);

  // High-protein model
  let gPerKg = baselineProt(goal) + emphasisBump(emph) + dynamicProtAdd({sleepHours:Number(els.sleepLast.value)||0,sessionMin:sessionMinutes,sessionType,soreness:Number(answers['soreness']||3),goal});
  gPerKg = Math.min(2.7, gPerKg); const gP=Math.round(gPerKg*kg);
  const gF=Math.round(fatPerKgDefault()*kg);
  const gC=Math.round(Math.max(0,(target-gP*4-gF*9)/4));
  const gFiber=Math.max(25, Math.round(kg*0.3));

  els.bmr.textContent=bmr+' kcal'; els.tdee.textContent=tdee+' kcal'; els.target.textContent=target+' kcal';
  els.protModel.textContent=gPerKg.toFixed(2)+' g/kg';
  els.gP.textContent=gP+'g'; els.gF.textContent=gF+'g'; els.gC.textContent=gC+'g'; els.gFiber.textContent=gFiber+'g';
  els.protNotes.textContent='Protein model: baseline '+(baselineProt(goal)).toFixed(1)+' + emphasis + dynamic add-ons (cap 2.7 g/kg).';

  // Sleep
  let need=sleepBase(sex); if((Number(els.sleepLast.value)||0)<7)need+=0.5; if(avg<3)need+=0.3; if(['hypertrophy','competition'].includes(sessionType))need+=0.3; if(sex==='female'&&cycle==='luteal')need+=0.3; need=clamp(Number(need.toFixed(1)),7.0,9.5); els.sleepNeed.textContent=need.toFixed(1);
  const sleepDebt=Math.max(0,8-(Number(els.sleepLast.value)||0));

  // Hydration
  const baselineL=(35*kg)/1000; const sessionH=sessionMinutes/60;
  const extraPerHour=['endurance','competition','power'].includes(sessionType)?0.75:(sessionType==='recovery'?0.25:0.5);
  const extraL=Math.max(0,sessionH*extraPerHour); const totalL=baselineL+extraL;
  const sodium=['endurance','competition','power'].includes(sessionType)?'1–2 g':'0.5–1 g';
  const toGal=l=>(l*0.264172).toFixed(2);
  els.hBase.textContent=toGal(baselineL)+' gal'; els.hExtra.textContent=toGal(extraL)+' gal'; els.hTotal.textContent=toGal(totalL)+' gal'; els.hNa.textContent=sodium;

  // Cold plunge
  const sorenessRaw=Number(answers['soreness']||3);
  const cp=coldPlungePlanner({sex,goal,sessionType,readiness:avg,soreness:sorenessRaw,cycle:(sex==='female'?cycle:'na')});
  els.coldYesNo.textContent=cp.recommend?'Yes':'No'; els.coldTiming.textContent=cp.timing||'—';
  if(cp.recommend){els.coldExtra.classList.remove('hide'); els.coldTemp.textContent=`${cp.tempC}°C / ${cp.tempF}°F`; els.coldDur.textContent=`${cp.durationMin} min`;} else { els.coldExtra.classList.add('hide'); }
  els.coldWhy.textContent=cp.rationale||'';

  // Readiness pill
  const label=avg>=4?'High':avg>=3?'Moderate':'Low';
  els.readinessPill.textContent=`Readiness ${label} (${avg.toFixed(1)}/5)`;

  // Plan
  const plan=dayPlan({goal,sessionType,readiness:avg,soreness:sorenessRaw,sleepDebt});
  els.planBlocks.innerHTML='';
  plan.forEach(b=>{
    const item=document.createElement('div'); item.className='likert-row'; item.style.marginBottom='8px';
    item.innerHTML=`<div style="font-size:12px;color:#2b2b2b;text-transform:uppercase;letter-spacing:.02em;margin-bottom:4px;">${b.label}</div><div>${b.text}</div>`;
    els.planBlocks.appendChild(item);
  });

  // Breathing
  const stressRaw=Number(answers['stress']?6-answers['stress']:3);
  const anxietyRaw=Number(answers['anxiety']?6-answers['anxiety']:3);
  const breath=breathingPlanner({stress:stressRaw,anxiety:anxietyRaw,readiness:avg,sleepDebt});
  els.breathBlock.innerHTML=`<div style="margin-bottom:6px;"><span class="pill">Focus: ${breath.focus}</span></div><ol>${breath.items.map(x=>`<li><b>${x.title}:</b> ${x.detail} <span style="color:#2b2b2b;">(${x.duration})</span></li>`).join('')}</ol>`;
  els.sleepBreath.textContent=breath.focus==='Downshift'?'Resonant breathing 5–10 min':'1:2 focus exhales 3–5 min';

  // Scripture
  const confidenceRaw=Number(answers['conf']||3);
  const moodRaw=Number(answers['mood']||3);
  const distractionRaw=Number(answers['distraction']?6-answers['distraction']:3);
  const supportRaw=Number(answers['support']||3);
  const driveRaw=Number(answers['drive']||3);
  const purposeRaw=Number(answers['purpose']||3);
  const calmRaw=Number(answers['calm']||3);
  const fatigueRaw=Number(answers['fatigue']?6-answers['fatigue']:3);
  const scriptureList=scripturePlanner({stress:stressRaw>=4,anxiety:anxietyRaw>=4,moodLow:moodRaw<=2,confidenceLow:confidenceRaw<=2,distractionHigh:distractionRaw>=4,supportLow:supportRaw<=2,driveLow:driveRaw<=2,readinessHigh:avg>=4,competitionDay:sessionType==='competition',recoveryDay:sessionType==='recovery',purposeLow:purposeRaw<=2,calmLow:calmRaw<=2,fatigueHigh:fatigueRaw>=4});
  els.scripture.innerHTML=scriptureList.map(v=>`<div class="verse"><div><b>${v.ref}</b></div><div>${v.txt}</div></div>`).join('');

  // Self-talk
  const selfLines=selfTalkPlanner(sex,answers);
  els.selfTalk.innerHTML='<ul>'+selfLines.map(x=>`<li>${x}</li>`).join('')+'</ul>';

  // Prayer
  const [p]=nonRepeatingPick('prayer-'+todayKey,PRAYERS,1);
  els.prayer.textContent=p;

  // Women supplements
  els.cycleSuppCard.style.display = (sex==='female') ? 'block' : 'none';
  if(sex==='female'){
    const items=cycleSupplements(cycle);
    els.cycleSupp.innerHTML='<ul>'+items.map(x=>`<li>${x}</li>`).join('')+'</ul>';
  }

  // Zones + VO2
  const {HRmax,useHRR,Z}=zonesFromHR(age,rhr);
  els.hrMax.textContent=HRmax?HRmax+' bpm':'—';
  els.hrRest.textContent=rhr? rhr+' bpm' : '—';
  const zhtml = Object.entries(Z).map(([k,range])=>`<div class="kpi"><small>${k}</small><b>${range[0]}–${range[1]} bpm</b></div>`).join('');
  els.zoneTable.innerHTML=zhtml;
  const rx=(function(){
    if(sessionType==='endurance') return {zone:'Z2',dur:'30–45 min (build 60–90)',note:'Steady conversational pace.'};
    if(sessionType==='power') return {zone:'Z5 intervals',dur:'6–10 min total',note:'Short reps, full recovery.'};
    if(sessionType==='recovery') return {zone:'Z1–Z2',dur:'20–30 min',note:'Relaxed nasal breathing.'};
    if(sessionType==='competition') return {zone:'Z1–Z2 + warm-ups',dur:'As sport-specific',note:'Keep legs fresh.'};
    return {zone:'Z1–Z2',dur:'15–20 min',note:'Warm-up / cool-down support.'};
  })();
  els.zonePrescription.innerHTML=`<div><span class="pill">${rx.zone}</span> — ${rx.dur}<div class="note">${rx.note}</div></div>`;
  els.sumZone.textContent=rx.zone;

  const vo2 = estVO2max(HRmax, rhr);
  els.vo2max.textContent = vo2 ? vo2.toFixed(1)+' ml/kg/min' : 'Enter Resting HR';
  els.vo2class.textContent = vo2Class(sex, age, vo2);
  const t = vo2TargetForDay(sessionType, Z);
  const bpmText = t.bpm ? `${t.bpm[0]}–${t.bpm[1]} bpm` : '—';
  els.vo2target.innerHTML = `<div><span class="pill">${t.label}</span> — <b>${t.minutes} @ ${bpmText}</b><div class="note">${useHRR? 'Using %HRR (preferred)': '%HRmax fallback'} • Stay steady, good form.</div></div>`;
  els.sumVo2.textContent = `${t.label}: ${t.minutes}`;

  // Weekly goals & progress
  const goals=weekGoals(activity, sessionType);
  els.wkZ2Goal.textContent=`${goals.z2} min`; els.wkZ5Goal.textContent=`${goals.z5} min`;
  let wk=loadWeek(); els.wkDone.textContent=`Z2 ${wk.z2} / Z5 ${wk.z5} min`; els.sumWeek.textContent=`${wk.z2}/${goals.z2} Z2 • ${wk.z5}/${goals.z5} Z5`;
  els.addZ2.onclick=()=>{wk=loadWeek(); wk.z2+=5; saveWeek(wk); compute();};
  els.addZ5.onclick=()=>{wk=loadWeek(); wk.z5+=1; saveWeek(wk); compute();};
  els.resetWeek.onclick=()=>{wk={key:getWeekKey(), z2:0, z5:0}; saveWeek(wk); compute();};

  // Sticky summary
  els.sumTarget.textContent=target+' kcal'; els.sumPCF.textContent=`${gP}/${gC}/${gF} g`; els.sumFiber.textContent=gFiber+' g'; els.sumSleep.textContent=need.toFixed(1)+' h';
}

function mealIdeasFromCurrent(){const p=parseInt(els.gP.textContent)||0; const c=parseInt(els.gC.textContent)||0; const f=parseInt(els.gF.textContent)||0; renderMealIdeas(p,c,f);} 

// UI bindings
['sex','age','rhr','heightFt','heightIn','heightCm','weightLb','goalWeightLb','weightKg','goalWeightKg','activity','sleepLast','sessionType','sessionMin','cycle','protEmphasis'].forEach(id=>{
  const el=$(id); if(!el)return;
  el.addEventListener('input',()=>{compute();saveState(); if(id==='sex')toggleCycle();});
  el.addEventListener('change',()=>{compute();saveState(); if(id==='sex')toggleCycle();});
});
function toggleCycle(){ els.cycleWrap.style.display=(els.sex.value==='female')?'grid':'none';}
els.unitsBtn.addEventListener('click',()=>{if(units==='us'){convertToMetric();units='metric';}else{convertToUS();units='us';}showUnits();compute();saveState();});
els.exportBtn.addEventListener('click',()=>window.print());
els.copyBtn.addEventListener('click',async()=>{
  const text=`Target: ${els.sumTarget.textContent}
P/C/F: ${els.sumPCF.textContent} (Fiber ${els.sumFiber.textContent})
Sleep: ${els.sumSleep.textContent}
Zone: ${els.sumZone.textContent}
VO2 Goal: ${els.sumVo2.textContent}
Week: ${els.sumWeek.textContent}
Hydration: ${els.hTotal.textContent} (baseline ${els.hBase.textContent}, extra ${els.hExtra.textContent}); Sodium: ${els.hNa.textContent}`;
  try{await navigator.clipboard.writeText(text); els.copyBtn.textContent='Copied ✔'; setTimeout(()=>els.copyBtn.textContent='Copy Plan',1200);}catch{}
});
els.ideasBtn.addEventListener('click', mealIdeasFromCurrent);

(function init(){ try{const raw=localStorage.getItem('dapNextClean'); if(raw)loadState();}catch{} buildLikert(); showUnits(); toggleCycle(); compute(); })();
</script>
</body>
</html>
