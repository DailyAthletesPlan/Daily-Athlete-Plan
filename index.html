<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Athlete Daily Planner — Pro (No-Babel)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: light dark; }
    html, body { height: 100%; }
    .sticky-pad { padding-bottom: 8.5rem; }
    .btn { border-radius: .75rem; border:1px solid rgba(100,116,139,.5); padding:.6rem .9rem; font-weight:600; }
    .btn-primary { border-color: transparent; background:#0f172a; color:#fff; }
    .card { border-radius: 1rem; box-shadow: 0 5px 20px rgba(0,0,0,.05); }
    .likert button.active { background:#2563eb; color:#fff; border-color:#2563eb; }
    .hidden { display: none; }
    .pill { font-size: .72rem; padding:.25rem .5rem; border-radius:999px; border:1px solid rgba(100,116,139,.35); }
    .divider { height:1px; background:rgba(100,116,139,.2); margin:.75rem 0; }
    .kpi { background: rgba(15,23,42,.03); border-radius: .75rem; padding:.5rem .75rem; }
    .verse { border-left: 3px solid rgba(100,116,139,.4); padding-left: .75rem; }
    @media (prefers-color-scheme: dark) {
      .btn-primary { background:#1e293b; }
      .kpi { background: rgba(255,255,255,.06); }
      .verse { border-left-color: rgba(255,255,255,.35); }
    }
  </style>
</head>
<body class="antialiased bg-slate-50 text-slate-900">
  <main class="min-h-[100dvh] sticky-pad">
    <div class="mx-auto w-full max-w-sm px-4 py-4">
      <!-- HEADER -->
      <header class="mb-4 flex items-center justify-between">
        <div>
          <h1 class="text-xl font-bold tracking-tight">Athlete Daily Planner</h1>
          <p class="text-slate-600 text-sm">Macros, sleep, cold plunge, hydration — plus plan, breathing, & scripture.</p>
        </div>
        <div class="flex items-center gap-2">
          <button id="exportBtn" class="btn">Share / Export</button>
          <button id="unitsBtn" class="btn">Metric</button>
          <button id="themeBtn" class="btn">Dark</button>
        </div>
      </header>

      <!-- PROFILE / INPUTS -->
      <section class="space-y-4">
        <div class="bg-white card p-4">
          <div class="flex items-center justify-between mb-2">
            <h2 class="font-semibold text-base">Profile</h2>
            <span id="readinessPill" class="pill">Readiness —</span>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="col-span-2">
              <label class="block text-xs font-medium mb-1">Sex</label>
              <select id="sex" class="w-full rounded-lg border px-3 py-3">
                <option value="female">Female</option>
                <option value="male">Male</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium mb-1">Age (years)</label>
              <input id="age" type="number" class="w-full rounded-lg border px-3 py-3" value="24" />
            </div>

            <!-- Height (US) -->
            <div class="col-span-2" id="heightUS">
              <label class="block text-xs font-medium mb-1">Height (ft / in)</label>
              <div class="flex gap-2">
                <input id="heightFt" type="number" class="flex-1 rounded-lg border px-3 py-3" value="5" placeholder="ft" />
                <input id="heightIn" type="number" class="flex-1 rounded-lg border px-3 py-3" value="6" placeholder="in" />
              </div>
            </div>
            <!-- Height (Metric) -->
            <div class="col-span-2 hidden" id="heightMetric">
              <label class="block text-xs font-medium mb-1">Height (cm)</label>
              <input id="heightCm" type="number" class="w-full rounded-lg border px-3 py-3" value="167.6" />
            </div>

            <!-- Weight (US) -->
            <div id="weightUS">
              <label class="block text-xs font-medium mb-1">Weight (lbs)</label>
              <input id="weightLb" type="number" class="w-full rounded-lg border px-3 py-3" value="150" />
            </div>
            <!-- Goal Weight (US) -->
            <div id="goalWeightUS">
              <label class="block text-xs font-medium mb-1">Goal weight (lbs)</label>
              <input id="goalWeightLb" type="number" class="w-full rounded-lg border px-3 py-3" value="145" />
            </div>

            <!-- Weight (Metric) -->
            <div class="hidden" id="weightMetric">
              <label class="block text-xs font-medium mb-1">Weight (kg)</label>
              <input id="weightKg" type="number" class="w-full rounded-lg border px-3 py-3" value="68" />
            </div>
            <!-- Goal Weight (Metric) -->
            <div class="hidden" id="goalWeightMetric">
              <label class="block text-xs font-medium mb-1">Goal weight (kg)</label>
              <input id="goalWeightKg" type="number" class="w-full rounded-lg border px-3 py-3" value="65.8" />
            </div>

            <div class="col-span-2">
              <label class="block text-xs font-medium mb-1">Activity level</label>
              <select id="activity" class="w-full rounded-lg border px-3 py-3">
                <option value="sedentary">Sedentary (little to no exercise)</option>
                <option value="light">Light (1–3 days/wk)</option>
                <option value="moderate" selected>Moderate (3–5 days/wk)</option>
                <option value="heavy">Heavy (6–7 days/wk)</option>
                <option value="athlete">Athlete / 2-a-days</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium mb-1">Sleep last night (hours)</label>
              <input id="sleepLast" type="number" step="0.1" class="w-full rounded-lg border px-3 py-3" value="7.0" />
            </div>
            <div>
              <label class="block text-xs font-medium mb-1">Today's session focus</label>
              <select id="sessionType" class="w-full rounded-lg border px-3 py-3">
                <option value="hypertrophy" selected>Hypertrophy / Heavy Strength</option>
                <option value="power">Power / Sprint / Skill</option>
                <option value="endurance">Conditioning / Endurance</option>
                <option value="recovery">Recovery / Mobility</option>
                <option value="competition">Competition / Back-to-back</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium mb-1">Session duration (min)</label>
              <input id="sessionMin" type="number" class="w-full rounded-lg border px-3 py-3" value="60" />
            </div>

            <!-- Female only -->
            <div class="col-span-2" id="cycleWrap">
              <label class="block text-xs font-medium mb-1">Menstrual cycle phase</label>
              <select id="cycle" class="w-full rounded-lg border px-3 py-3">
                <option value="menstruation">Menstruation</option>
                <option value="follicular" selected>Follicular</option>
                <option value="ovulatory">Ovulatory</option>
                <option value="luteal">Luteal</option>
              </select>
            </div>
          </div>

          <div class="mt-3 flex gap-2">
            <button id="copyBtn" class="flex-1 btn">Copy Plan</button>
            <button id="ideasBtn" class="flex-1 btn">Meal Ideas</button>
          </div>
        </div>

        <!-- 15-QUESTION CHECK-IN -->
        <div class="bg-white card p-4">
          <h2 class="font-semibold text-base mb-2">15-Question Mental Check-In</h2>
          <div id="likertList" class="space-y-2 max-h-[28rem] overflow-auto pr-1"></div>
          <div class="pt-2 text-[11px] text-slate-500">Reverse-scored: stress, anxiety, soreness, fatigue, distraction.</div>
        </div>

        <!-- RESULTS: TODAY'S PLAN -->
        <div class="bg-white card p-4">
          <h3 class="font-semibold text-base mb-2">Today’s Plan</h3>
          <div id="planBlocks" class="space-y-2 text-sm"></div>
        </div>

        <!-- RESULTS: MACROS -->
        <div class="bg-white card p-4">
          <h3 class="font-semibold text-base mb-1">Daily Macros</h3>
          <p class="text-xs text-slate-600 mb-3">Goal from goal weight: <span id="goalTag" class="font-semibold">MAINTAIN</span></p>
          <div class="grid grid-cols-2 gap-2 text-sm">
            <div class="text-slate-500">BMR</div><div id="bmr" class="font-semibold">— kcal</div>
            <div class="text-slate-500">TDEE</div><div id="tdee" class="font-semibold">— kcal</div>
            <div class="text-slate-500">Target kcal</div><div id="target" class="font-semibold">— kcal</div>
          </div>
          <div class="mt-3 grid grid-cols-3 gap-2">
            <div class="kpi text-center"><div class="text-[11px] text-slate-500">Protein</div><div id="gP" class="text-xl font-bold">—g</div></div>
            <div class="kpi text-center"><div class="text-[11px] text-slate-500">Carbs</div><div id="gC" class="text-xl font-bold">—g</div></div>
            <div class="kpi text-center"><div class="text-[11px] text-slate-500">Fats</div><div id="gF" class="text-xl font-bold">—g</div></div>
          </div>
          <div id="ideas" class="mt-4 space-y-2 hidden"></div>
        </div>

        <!-- RESULTS: COLD PLUNGE -->
        <div class="bg-white card p-4">
          <h3 class="font-semibold text-base mb-1">Cold Plunge</h3>
          <p class="text-xs text-slate-600 mb-3">Session focus, inferred goal, soreness/readiness, and (if female) cycle.</p>
          <div class="text-sm grid gap-2">
            <div><span class="text-slate-500">Recommend:</span> <span id="coldYesNo" class="font-semibold">—</span></div>
            <div><span class="text-slate-500">Timing:</span> <span id="coldTiming" class="font-semibold">—</span></div>
            <div id="coldExtra" class="hidden">
              <div><span class="text-slate-500">Temperature:</span> <span id="coldTemp" class="font-semibold"></span></div>
              <div><span class="text-slate-500">Duration:</span> <span id="coldDur" class="font-semibold"></span></div>
            </div>
            <div id="coldWhy" class="text-slate-500 text-xs"></div>
          </div>
        </div>

        <!-- RESULTS: SLEEP -->
        <div class="bg-white card p-4">
          <h3 class="font-semibold text-base mb-1">Tonight’s Sleep</h3>
          <div class="grid grid-cols-2 gap-3 items-center">
            <div class="text-center">
              <div class="text-[2rem] leading-none font-extrabold"><span id="sleepNeed">—</span><span class="text-sm font-semibold text-slate-500"> h</span></div>
              <div class="text-[11px] text-slate-500 mt-2">Fix wake time • AM light • Cool, dark room.</div>
            </div>
            <div class="text-sm">
              <div class="font-semibold mb-1">Pre-sleep winddown</div>
              <ul class="list-disc pl-5 space-y-1 text-slate-700">
                <li id="sleepBreath">5–10 min downshift breathing</li>
                <li>90 min before bed: hot shower/bath</li>
                <li>Limit screens & caffeine late</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- RESULTS: HYDRATION (gallons) -->
        <div class="bg-white card p-4">
          <h3 class="font-semibold text-base mb-1">Hydration & Electrolytes</h3>
          <p class="text-xs text-slate-600 mb-3">Shown in gallons (gal). Baseline + session add-on.</p>
          <div class="grid grid-cols-2 gap-2 text-sm">
            <div class="text-slate-500">Baseline water</div><div id="hBase" class="font-semibold">— gal</div>
            <div class="text-slate-500">Session extra</div><div id="hExtra" class="font-semibold">— gal</div>
            <div class="text-slate-500">Total today</div><div id="hTotal" class="font-semibold">— gal</div>
            <div class="text-slate-500">Sodium target</div><div id="hNa" class="font-semibold">—</div>
          </div>
          <div class="mt-2 text-[11px] text-slate-500">Heavy sweaters/heat: consider upper end of sodium range and +0.1–0.2 gal.</div>
        </div>

        <!-- RESULTS: BREATHING EXERCISES -->
        <div class="bg-white card p-4">
          <h3 class="font-semibold text-base mb-1">Breathing Session</h3>
          <div id="breathBlock" class="text-sm"></div>
        </div>

        <!-- RESULTS: SCRIPTURE (NKJV) -->
        <div class="bg-white card p-4">
          <h3 class="font-semibold text-base mb-1">Scripture for Today (NKJV)</h3>
          <div id="scripture" class="text-sm space-y-3"></div>
          <div class="text-[11px] text-slate-500 mt-2">Brief passages from the New King James Version (NKJV).</div>
        </div>
      </section>

      <footer class="mt-6 text-center text-[11px] text-slate-500">
        Inferred goal based on goal weight. Tune factors/thresholds as needed.
      </footer>
    </div>

    <!-- Sticky bottom summary bar -->
    <div class="fixed bottom-0 inset-x-0 bg-white border-t shadow-2xl p-3">
      <div class="mx-auto max-w-sm">
        <div class="flex items-center justify-between gap-3 text-[13px]">
          <div class="flex flex-col">
            <span class="text-slate-500">Target</span>
            <span id="sumTarget" class="font-semibold">— kcal</span>
          </div>
          <div class="flex flex-col">
            <span class="text-slate-500">P/C/F</span>
            <span id="sumPCF" class="font-semibold">—/—/— g</span>
          </div>
          <div class="flex flex-col">
            <span class="text-slate-500">Sleep</span>
            <span id="sumSleep" class="font-semibold">— h</span>
          </div>
          <div class="flex flex-col text-right">
            <span class="text-slate-500">Cold</span>
            <span id="sumCold" class="font-semibold">—</span>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // ---------- Helpers ----------
    const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
    const kgFromLbs = (lbs)=> lbs * 0.45359237;
    const lbsFromKg = (kg)=> kg / 0.45359237;
    const cmFromFtIn = (ft,inch)=> ((Number(ft)||0)*12 + (Number(inch)||0)) * 2.54;
    const L_TO_GAL = 0.264172;

    const ACTIVITY = { sedentary: 1.2, light: 1.375, moderate: 1.55, heavy: 1.725, athlete: 1.9 };

    function mifflin({sex, kg, cm, age}) { const s = sex === 'male' ? 5 : -161; return 10*kg + 6.25*cm - 5*age + s; }
    function inferGoal(currentLb, goalLb) { const cut = currentLb * 0.97, bulk = currentLb * 1.03; return goalLb <= cut ? 'cut' : goalLb >= bulk ? 'bulk' : 'maintain'; }
    function proteinPerKg(goal) { return goal==='cut' ? 2.0 : goal==='bulk' ? 1.6 : 1.8; }
    const fatPerKgDefault = ()=>0.9;
    const sleepBase = (sex)=> sex==='female' ? 8.5 : 7.8;

    function coldPlungePlanner({ sex, goal, sessionType, readiness, soreness, cycle }) {
      const rec = { recommend:false, rationale:'', timing:'', tempC:10, tempF:50, durationMin:0 };
      const lowReadiness = readiness < 3;
      const highSoreness = soreness >= 4;
      const growthPriority = (goal==='bulk' || sessionType==='hypertrophy');

      if (growthPriority) {
        rec.recommend = highSoreness || lowReadiness;
        rec.rationale = 'Growth focus: avoid immediate post-lift cold; use only for soreness/fatigue.';
        rec.timing = 'If used: 6–12+ h after lifting or next morning.';
        rec.durationMin = rec.recommend ? 6 : 0;
      } else if (['competition','endurance','power'].includes(sessionType)) {
        rec.recommend = true;
        rec.rationale = 'Recovery/turnaround focus.';
        rec.timing = 'Within 0–60 min post-session or later in day.';
        rec.durationMin = 6;
      } else if (sessionType==='recovery') {
        rec.recommend = true;
        rec.rationale = 'Recovery day; use short, moderate cold.';
        rec.timing = 'Any time, preferably earlier in day.';
        rec.durationMin = 5;
      }
      if (sex==='female' && cycle==='luteal') {
        rec.tempC = 12; rec.tempF = 54;
        if (rec.durationMin>0) rec.durationMin = Math.max(4, rec.durationMin-1);
        rec.rationale += ' Luteal adjustment: slightly warmer/shorter.';
      }
      if (!rec.recommend) rec.durationMin = 0;
      return rec;
    }

    // Breathing recommender
    function breathingPlanner({ stress, anxiety, readiness, sleepDebt }) {
      const plans = [];
      let focus = 'Downshift';
      if (readiness < 3 || stress >= 4 || anxiety >= 4 || sleepDebt > 1) {
        focus = 'Downshift';
        plans.push({ title: 'Physiological Sighs', detail: '1–2 breaths: inhale through nose, top-up sniff, long exhale through mouth; repeat.', duration: '5–10 min' });
        plans.push({ title: 'Resonant Breathing', detail: 'Inhale 4–5 s, exhale 6–7 s (≈5.5 breaths/min).', duration: '5–10 min' });
      } else {
        focus = 'Up-regulate / Focus',
        plans.push({ title: 'Box Breathing', detail: 'Inhale 4 s • hold 4 s • exhale 4 s • hold 4 s.', duration: '3–5 min' });
        plans.push({ title: '1:2 Focus Exhales', detail: 'Inhale 3 s, exhale 6 s for calm focus.', duration: '3–5 min' });
      }
      return { focus, items: plans };
    }

    // Scripture selector (NKJV excerpts)
    function scripturePlanner(ctx) {
      const verses = [];
      const add = (ref, text) => verses.push({ ref, text });
      const { stress, anxiety, moodLow, confidenceLow, distractionHigh, supportLow, driveLow, readinessHigh, competitionDay, recoveryDay, purposeLow, calmLow, fatigueHigh, sleepDebt } = ctx;

      if (competitionDay) add('1 Corinthians 9:24–25', 'Do you not know that those who run in a race all run, but one receives the prize? Run in such a way that you may obtain it. And everyone who competes for the prize is temperate in all things.');
      if (readinessHigh) add('Psalm 18:32–33', 'It is God who arms me with strength, and makes my way perfect. He makes my feet like the feet of deer, and sets me on my high places.');
      if (confidenceLow) add('Joshua 1:9', 'Have I not commanded you? Be strong and of good courage; do not be afraid, nor be dismayed, for the LORD your God is with you wherever you go.');
      if (stress || anxiety) add('Philippians 4:6–7', 'Be anxious for nothing, but in everything by prayer and supplication, with thanksgiving, let your requests be made known to God; and the peace of God... will guard your hearts and minds through Christ Jesus.');
      if (anxiety) add('1 Peter 5:7', 'Casting all your care upon Him, for He cares for you.');
      if (moodLow) add('Psalm 34:18', 'The LORD is near to those who have a broken heart, and saves such as have a contrite spirit.');
      if (fatigueHigh || sleepDebt > 1) add('Isaiah 40:31', 'But those who wait on the LORD shall renew their strength; they shall mount up with wings like eagles... they shall run and not be weary, they shall walk and not faint.');
      if (purposeLow) add('Proverbs 3:5–6', 'Trust in the LORD with all your heart, and lean not on your own understanding; in all your ways acknowledge Him, and He shall direct your paths.');
      if (calmLow) add('Psalm 46:10', 'Be still, and know that I am God.');
      if (distractionHigh) add('Colossians 3:23', 'And whatever you do, do it heartily, as to the Lord and not to men.');
      if (driveLow) add('Hebrews 12:1–2', '…let us run with endurance the race that is set before us, looking unto Jesus, the author and finisher of our faith.');
      if (supportLow) add('Ecclesiastes 4:9–10', 'Two are better than one… For if they fall, one will lift up his companion.');
      if (recoveryDay) add('Matthew 11:28–29', 'Come to Me, all you who labor and are heavy laden, and I will give you rest. Take My yoke upon you and learn from Me… and you will find rest for your souls.');

      // Fallback if empty
      if (!verses.length) add('Psalm 16:8', 'I have set the LORD always before me; because He is at my right hand I shall not be moved.');
      // Limit to 3–4 short picks to keep it readable
      return verses.slice(0, 4);
    }

    // Plan builder
    function dayPlan({ goal, sessionType, readiness, soreness, sleepDebt }) {
      const blocks = [];
      if (readiness < 2.5 || sleepDebt > 1.5) {
        blocks.push({ label: 'Training', text: 'Keep it easy: technique + mobility + Zone 2 (20–30 min). Optional: light accessories.' });
      } else if (soreness >= 4) {
        blocks.push({ label: 'Training', text: 'Reduce volume 25–40%. Keep intensity moderate. Emphasize long rest and form.' });
      } else {
        let txt = 'Proceed as planned.';
        if (goal==='cut' && sessionType==='hypertrophy') txt = 'Emphasize quality reps; 8–15 reps; avoid failure on first sets.';
        if (goal==='bulk' && sessionType==='hypertrophy') txt = 'Add a back-off set or small accessory volume (5–10%).';
        if (sessionType==='endurance') txt = 'Main set steady; finish with 4–6 strides/short pickups.';
        if (sessionType==='power') txt = 'Full recovery between sets; keep reps crisp and fast.';
        if (sessionType==='recovery') txt = 'Mobility, easy aerobic 15–30 min, light tissue work.';
        if (sessionType==='competition') txt = 'Warm-up progression + taper volume; post-competition refuel and short cold if desired.';
        blocks.push({ label: 'Training', text: txt });
      }
      if (goal==='cut') blocks.push({ label: 'Nutrition', text: 'Front-load protein (≥30–40 g breakfast). Spread protein 3–5 meals. Carbs near training.' });
      else if (goal==='bulk') blocks.push({ label: 'Nutrition', text: 'Add one carb feeding around training. Ensure +300 kcal and ≥1.6 g/kg protein.' });
      else blocks.push({ label: 'Nutrition', text: 'Even protein distribution. Carbs biased to pre/post-session. Fats moderate.' });
      if (readiness < 3 || soreness >= 4) blocks.push({ label: 'Recovery', text: '10–20 min gentle mobility; optional cold per guidance; 10 min breathing; evening walk.' });
      else blocks.push({ label: 'Recovery', text: '5–10 min mobility and post-session cooldown. Walk after dinner.' });
      if (sleepDebt > 0.5) blocks.push({ label: 'Sleep', text: 'Earlier winddown tonight. Optionally a 20 min nap before 3 pm.' });
      else blocks.push({ label: 'Sleep', text: 'Consistent schedule; protect 90-min pre-bed routine.' });
      return blocks;
    }

    // ---------- State ----------
    const $ = (id)=>document.getElementById(id);
    const els = {
      sex: $('sex'), age: $('age'),
      heightUS: $('heightUS'), heightFt: $('heightFt'), heightIn: $('heightIn'),
      heightMetric: $('heightMetric'), heightCm: $('heightCm'),
      weightUS: $('weightUS'), weightLb: $('weightLb'),
      goalWeightUS: $('goalWeightUS'), goalWeightLb: $('goalWeightLb'),
      weightMetric: $('weightMetric'), weightKg: $('weightKg'),
      goalWeightMetric: $('goalWeightMetric'), goalWeightKg: $('goalWeightKg'),
      activity: $('activity'), sleepLast: $('sleepLast'),
      sessionType: $('sessionType'), sessionMin: $('sessionMin'),
      cycleWrap: $('cycleWrap'), cycle: $('cycle'),
      unitsBtn: $('unitsBtn'), exportBtn: $('exportBtn'), themeBtn: $('themeBtn'),
      copyBtn: $('copyBtn'), ideasBtn: $('ideasBtn'),

      // outputs
      goalTag: $('goalTag'), bmr: $('bmr'), tdee: $('tdee'), target: $('target'),
      gP: $('gP'), gC: $('gC'), gF: $('gF'),
      sleepNeed: $('sleepNeed'), sleepBreath: $('sleepBreath'),
      hBase: $('hBase'), hExtra: $('hExtra'), hTotal: $('hTotal'), hNa: $('hNa'),
      coldYesNo: $('coldYesNo'), coldTiming: $('coldTiming'),
      coldExtra: $('coldExtra'), coldTemp: $('coldTemp'), coldDur: $('coldDur'),
      coldWhy: $('coldWhy'),
      sumTarget: $('sumTarget'), sumPCF: $('sumPCF'), sumSleep: $('sumSleep'), sumCold: $('sumCold'),
      likertList: $('likertList'), ideas: $('ideas'), planBlocks: $('planBlocks'),
      readinessPill: $('readinessPill'), breathBlock: $('breathBlock'), scripture: $('scripture')
    };

    const QUESTIONS = [
      { id: "conf", label: "Confidence today" },
      { id: "focus", label: "Focus on task" },
      { id: "motivation", label: "Motivation to train" },
      { id: "stress", label: "Stress (higher = worse)", reverse: true },
      { id: "mood", label: "Mood" },
      { id: "anxiety", label: "Performance anxiety (higher = worse)", reverse: true },
      { id: "readiness", label: "Overall readiness" },
      { id: "soreness", label: "Soreness (higher = worse)", reverse: true },
      { id: "fatigue", label: "Fatigue (higher = worse)", reverse: true },
      { id: "selftalk", label: "Self-talk quality" },
      { id: "purpose", label: "Clarity of goals" },
      { id: "distraction", label: "Distractions (higher = worse)", reverse: true },
      { id: "support", label: "Support from others" },
      { id: "calm", label: "Calm under pressure" },
      { id: "drive", label: "Drive to push" },
    ];

    let units = 'us'; // 'us' | 'metric'
    let answers = {}; QUESTIONS.forEach(q => answers[q.id] = 3);
    let dark=false;

    // ---------- UI builders ----------
    function buildLikert() {
      els.likertList.innerHTML = '';
      QUESTIONS.forEach(q => {
        const row = document.createElement('div');
        row.className = 'rounded-lg border border-slate-200 p-2';
        const label = document.createElement('div');
        label.className = 'text-sm font-medium mb-2';
        label.textContent = q.label;
        const group = document.createElement('div');
        group.className = 'likert flex gap-2 flex-wrap';
        [1,2,3,4,5].forEach(v => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'h-10 w-10 rounded-md border text-base';
          if (answers[q.id] === v) btn.classList.add('active');
          btn.textContent = v;
          btn.addEventListener('click', () => {
            answers[q.id] = v;
            buildLikert();
            compute();
            saveState();
          });
          group.appendChild(btn);
        });
        row.appendChild(label);
        row.appendChild(group);
        els.likertList.appendChild(row);
      });
    }

    // ---------- State persistence ----------
    function saveState() {
      const state = {
        sex: els.sex.value, age: els.age.value,
        heightFt: els.heightFt.value, heightIn: els.heightIn.value, heightCm: els.heightCm.value,
        weightLb: els.weightLb.value, goalWeightLb: els.goalWeightLb.value,
        weightKg: els.weightKg.value, goalWeightKg: els.goalWeightKg.value,
        activity: els.activity.value, sleepLast: els.sleepLast.value,
        sessionType: els.sessionType.value, sessionMin: els.sessionMin.value,
        cycle: els.cycle.value, units, answers, dark
      };
      try { localStorage.setItem('athletePlannerPro', JSON.stringify(state)); } catch(e) {}
    }
    function loadState() {
      try {
        const raw = localStorage.getItem('athletePlannerPro');
        if (!raw) return;
        const s = JSON.parse(raw); if (!s) return;
        els.sex.value = s.sex || 'female';
        els.age.value = s.age || 24;
        els.heightFt.value = s.heightFt || 5;
        els.heightIn.value = s.heightIn || 6;
        els.heightCm.value = s.heightCm || 167.6;
        els.weightLb.value = s.weightLb || 150;
        els.goalWeightLb.value = s.goalWeightLb || 145;
        els.weightKg.value = s.weightKg || 68;
        els.goalWeightKg.value = s.goalWeightKg || 65.8;
        els.activity.value = s.activity || 'moderate';
        els.sleepLast.value = s.sleepLast || 7;
        els.sessionType.value = s.sessionType || 'hypertrophy';
        els.sessionMin.value = s.sessionMin || 60;
        els.cycle.value = s.cycle || 'follicular';
        units = s.units || 'us';
        answers = s.answers || answers;
        dark = !!s.dark;
      } catch(e) {}
    }

    // ---------- Units / Theme toggles ----------
    function showUnits() {
      const us = units === 'us';
      els.heightUS.classList.toggle('hidden', !us);
      els.heightMetric.classList.toggle('hidden', us);
      els.weightUS.classList.toggle('hidden', !us);
      els.goalWeightUS.classList.toggle('hidden', !us);
      els.weightMetric.classList.toggle('hidden', us);
      els.goalWeightMetric.classList.toggle('hidden', us);
      els.unitsBtn.textContent = us ? 'Metric' : 'US';
    }
    function convertToMetric() {
      const ft = Number(els.heightFt.value)||0, inch = Number(els.heightIn.value)||0;
      els.heightCm.value = (cmFromFtIn(ft, inch)).toFixed(1);
      els.weightKg.value = (kgFromLbs(Number(els.weightLb.value)||0)).toFixed(1);
      els.goalWeightKg.value = (kgFromLbs(Number(els.goalWeightLb.value)||0)).toFixed(1);
    }
    function convertToUS() {
      const cm = Number(els.heightCm.value)||0;
      const totalIn = cm/2.54;
      const ft = Math.floor(totalIn/12);
      const inch = Math.round(totalIn - ft*12);
      els.heightFt.value = ft;
      els.heightIn.value = inch;
      els.weightLb.value = (lbsFromKg(Number(els.weightKg.value)||0)).toFixed(0);
      els.goalWeightLb.value = (lbsFromKg(Number(els.goalWeightKg.value)||0)).toFixed(0);
    }
    function toggleUnits() {
      if (units==='us') { convertToMetric(); units='metric'; }
      else { convertToUS(); units='us'; }
      showUnits(); compute(); saveState();
    }
    function applyTheme() {
      document.documentElement.classList.toggle('dark', dark);
      document.body.classList.toggle('dark:bg-slate-900', dark);
      document.body.classList.toggle('dark:text-slate-100', dark);
      els.themeBtn.textContent = dark ? 'Light' : 'Dark';
    }

    // ---------- Compute ----------
    function compute() {
      // readiness via likert
      const norm = QUESTIONS.map(q => {
        const raw = Number(answers[q.id] || 3);
        return q.reverse ? 6 - raw : raw;
      });
      const avg = norm.reduce((a,b)=>a+b,0) / norm.length;
      const sorenessRaw = Number(answers['soreness'] || 3);
      const stressRaw = Number(answers['stress'] ? 6 - answers['stress'] : 3);
      const anxietyRaw = Number(answers['anxiety'] ? 6 - answers['anxiety'] : 3);
      const confidenceRaw = Number(answers['conf'] || 3);
      const moodRaw = Number(answers['mood'] || 3);
      const distractionRaw = Number(answers['distraction'] ? 6 - answers['distraction'] : 3);
      const supportRaw = Number(answers['support'] || 3);
      const driveRaw = Number(answers['drive'] || 3);
      const purposeRaw = Number(answers['purpose'] || 3);
      const calmRaw = Number(answers['calm'] || 3);
      const fatigueRaw = Number(answers['fatigue'] ? 6 - answers['fatigue'] : 3);

      // input extraction
      const sex = els.sex.value;
      const age = Number(els.age.value)||0;

      const kg = (units==='metric') ? (Number(els.weightKg.value)||0) : kgFromLbs(Number(els.weightLb.value)||0);
      const cm = (units==='metric') ? (Number(els.heightCm.value)||0) : cmFromFtIn(Number(els.heightFt.value)||0, Number(els.heightIn.value)||0);
      const currentLb = (units==='metric') ? lbsFromKg(Number(els.weightKg.value)||0) : (Number(els.weightLb.value)||0);
      const goalLb = (units==='metric') ? lbsFromKg(Number(els.goalWeightKg.value)||0) : (Number(els.goalWeightLb.value)||0);

      const activity = ACTIVITY[els.activity.value] || 1.55;
      const sessionType = els.sessionType.value;
      const sessionMinutes = Number(els.sessionMin.value)||0;
      const cycle = els.cycle.value;

      const goal = inferGoal(currentLb, goalLb);
      els.goalTag.textContent = goal.toUpperCase();
      els.goalTag.className = 'font-semibold ' + (goal==='cut' ? 'text-rose-600' : goal==='bulk' ? 'text-emerald-500' : '');

      // Energy + macros
      const bmr = Math.round(mifflin({sex, kg, cm, age}));
      const tdee = Math.round(bmr * activity);
      const delta = goal==='cut' ? -400 : goal==='bulk' ? 300 : 0;
      const target = Math.max(1200, tdee + delta);

      const pPerKg = proteinPerKg(goal), fatPerKg = fatPerKgDefault();
      const gP = Math.round(pPerKg * kg);
      const gF = Math.round(fatPerKg * kg);
      const carbKcal = Math.max(0, target - gP*4 - gF*9);
      const gC = Math.round(carbKcal / 4);

      els.bmr.textContent = bmr + ' kcal';
      els.tdee.textContent = tdee + ' kcal';
      els.target.textContent = target + ' kcal';
      els.gP.textContent = gP + 'g';
      els.gF.textContent = gF + 'g';
      els.gC.textContent = gC + 'g';

      // Sleep
      let need = sleepBase(sex);
      if ((Number(els.sleepLast.value)||0) < 7) need += 0.5;
      if (avg < 3) need += 0.3;
      if (['hypertrophy','competition'].includes(sessionType)) need += 0.3;
      if (sex==='female' && cycle==='luteal') need += 0.3;
      need = clamp(Number(need.toFixed(1)), 7.0, 9.5);
      els.sleepNeed.textContent = need.toFixed(1);
      const sleepDebt = Math.max(0, 8 - (Number(els.sleepLast.value)||0));

      // Hydration (gallons)
      const baselineL = (35 * kg)/1000;
      const sessionH = sessionMinutes / 60;
      const extraPerHour = ['endurance','competition','power'].includes(sessionType) ? 0.75 : (sessionType==='recovery' ? 0.25 : 0.5);
      const extraL = Math.max(0, sessionH * extraPerHour);
      const totalL = baselineL + extraL;
      const sodium = ['endurance','competition','power'].includes(sessionType) ? '1–2 g' : '0.5–1 g';

      const toGal = (l)=> (l * 0.264172).toFixed(2);
      els.hBase.textContent = toGal(baselineL) + ' gal';
      els.hExtra.textContent = toGal(extraL) + ' gal';
      els.hTotal.textContent = toGal(totalL) + ' gal';
      els.hNa.textContent = sodium;

      // Cold plunge
      const cp = coldPlungePlanner({ sex, goal, sessionType, readiness: avg, soreness: sorenessRaw, cycle: (sex==='female' ? cycle : 'na') });
      els.coldYesNo.textContent = cp.recommend ? 'Yes' : 'No';
      els.coldTiming.textContent = cp.timing || '—';
      if (cp.recommend) {
        els.coldExtra.classList.remove('hidden');
        els.coldTemp.textContent = `${cp.tempC}°C / ${cp.tempF}°F`;
        els.coldDur.textContent = `${cp.durationMin} min`;
      } else {
        els.coldExtra.classList.add('hidden');
      }
      els.coldWhy.textContent = cp.rationale || '';

      // Readiness pill
      const pill = els.readinessPill;
      const label = avg >= 4 ? 'High' : avg >= 3 ? 'Moderate' : 'Low';
      pill.textContent = `Readiness ${label} (${avg.toFixed(1)}/5)`;
      pill.style.borderColor = avg>=4 ? '#10b981' : avg>=3 ? '#f59e0b' : '#ef4444';
      pill.style.color = avg>=4 ? '#065f46' : avg>=3 ? '#78350f' : '#7f1d1d';
      pill.style.background = avg>=4 ? 'rgba(16,185,129,.12)' : avg>=3 ? 'rgba(245,158,11,.12)' : 'rgba(239,68,68,.12)';

      // Today's Plan
      const plan = dayPlan({ goal, sessionType, readiness: avg, soreness: sorenessRaw, sleepDebt });
      els.planBlocks.innerHTML = '';
      plan.forEach(b => {
        const item = document.createElement('div');
        item.className = 'rounded-lg border p-3';
        item.innerHTML = `<div class="text-xs uppercase tracking-wide text-slate-500 mb-1">${b.label}</div><div>${b.text}</div>`;
        els.planBlocks.appendChild(item);
      });

      // Breathing plan
      const breath = breathingPlanner({ stress: stressRaw, anxiety: anxietyRaw, readiness: avg, sleepDebt });
      els.breathBlock.innerHTML = `
        <div class="mb-2"><span class="pill">Focus: ${breath.focus}</span></div>
        <ol class="list-decimal pl-5 space-y-1">
          ${breath.items.map(x => `<li><span class="font-semibold">${x.title}:</span> ${x.detail} <span class="text-slate-500">(${x.duration})</span></li>`).join('')}
        </ol>
      `;
      els.sleepBreath.textContent = breath.focus==='Downshift' ? 'Resonant breathing 5–10 min' : '1:2 focus exhales 3–5 min';

      // Scripture plan (NKJV)
      const scriptureList = scripturePlanner({
        stress: stressRaw>=4, anxiety: anxietyRaw>=4, moodLow: moodRaw<=2, confidenceLow: confidenceRaw<=2,
        distractionHigh: distractionRaw>=4, supportLow: supportRaw<=2, driveLow: driveRaw<=2,
        readinessHigh: avg>=4, competitionDay: sessionType==='competition', recoveryDay: sessionType==='recovery',
        purposeLow: purposeRaw<=2, calmLow: calmRaw<=2, fatigueHigh: fatigueRaw>=4, sleepDebt
      });
      els.scripture.innerHTML = scriptureList.map(v => `
        <div class="verse">
          <div class="font-semibold">${v.ref}</div>
          <div>${v.text}</div>
        </div>
      `).join('');

      // Sticky summary
      els.sumTarget.textContent = target + ' kcal';
      els.sumPCF.textContent = `${gP}/${gC}/${gF} g`;
      els.sumSleep.textContent = need.toFixed(1) + ' h';
      els.sumCold.textContent = cp.recommend ? 'Yes' : 'No';
    }

    // ---------- Meal ideas ----------
    function mealIdeas(proteinG, carbsG, fatG) {
      const P = Math.max(0, Math.round(proteinG*0.93));
      const C = Math.max(0, Math.round(carbsG*0.93));
      const F = Math.max(0, Math.round(fatG*0.93));
      const part = (p,c,f,r)=>({P:Math.round(p*r),C:Math.round(c*r),F:Math.round(f*r)});
      const B=part(P,C,F,.25), L=part(P,C,F,.30), D=part(P,C,F,.35), S=part(P,C,F,.10);

      const items = [
        { title:'Breakfast', macros:B, ideas:[
          'Greek yogurt + whey + berries + honey',
          'Eggs + egg whites + sourdough + fruit',
          'Overnight oats (milk) + chia + banana'
        ]},
        { title:'Lunch', macros:L, ideas:[
          'Chicken rice bowl (olive oil) + veggies',
          'Turkey sandwich + cheese + fruit',
          'Tuna pasta salad + spinach'
        ]},
        { title:'Dinner', macros:D, ideas:[
          'Salmon + potatoes + salad (oil)',
          'Beef tacos (corn tortillas) + guac',
          'Stir-fry tofu/chicken + rice'
        ]},
        { title:'Snack', macros:S, ideas:[
          'Protein shake + banana',
          'Cottage cheese + crackers',
          'Trail mix (portion) + fruit'
        ]},
      ];

      els.ideas.innerHTML = '';
      items.forEach(m => {
        const box = document.createElement('div');
        box.className = 'rounded-xl border p-3 text-sm';
        const h = document.createElement('div');
        h.className = 'font-semibold mb-1';
        h.textContent = m.title;
        const t = document.createElement('div');
        t.className = 'text-xs text-slate-500 mb-1';
        t.textContent = `Target ≈ P${m.macros.P}/C${m.macros.C}/F${m.macros.F} g`;
        const ul = document.createElement('ul');
        ul.className = 'list-disc pl-5 space-y-1';
        m.ideas.forEach(it => { const li = document.createElement('li'); li.textContent = it; ul.appendChild(li); });
        box.appendChild(h); box.appendChild(t); box.appendChild(ul);
        els.ideas.appendChild(box);
      });
      els.ideas.classList.remove('hidden');
    }

    // ---------- Events ----------
    [
      'sex','age','heightFt','heightIn','heightCm','weightLb','goalWeightLb',
      'weightKg','goalWeightKg','activity','sleepLast','sessionType','sessionMin','cycle'
    ].forEach(id => {
      const el = $(id);
      el && el.addEventListener('input', () => { compute(); saveState(); if (id==='sex') toggleCycle(); });
      el && el.addEventListener('change', () => { compute(); saveState(); if (id==='sex') toggleCycle(); });
    });

    function toggleCycle() { els.cycleWrap.classList.toggle('hidden', els.sex.value !== 'female'); }

    els.unitsBtn.addEventListener('click', toggleUnits);
    els.exportBtn.addEventListener('click', ()=> window.print());
    els.themeBtn.addEventListener('click', ()=>{ dark=!dark; applyTheme(); saveState(); });
    els.copyBtn.addEventListener('click', async ()=>{
      const text = `Target: ${els.sumTarget.textContent}
P/C/F: ${els.sumPCF.textContent}
Sleep: ${els.sumSleep.textContent}
Cold plunge: ${els.sumCold.textContent}
Hydration: ${els.hTotal.textContent} (baseline ${els.hBase.textContent}, extra ${els.hExtra.textContent}); Sodium: ${els.hNa.textContent}`;
      try { await navigator.clipboard.writeText(text); els.copyBtn.textContent='Copied ✔'; setTimeout(()=>els.copyBtn.textContent='Copy Plan',1200); } catch(e){}
    });
    els.ideasBtn.addEventListener('click', ()=>{
      const p = parseInt(els.gP.textContent)||0;
      const c = parseInt(els.gC.textContent)||0;
      const f = parseInt(els.gF.textContent)||0;
      mealIdeas(p,c,f);
    });

    // ---------- Boot ----------
    loadState();
    buildLikert();
    showUnits();
    toggleCycle();
    applyTheme();
    compute();
  </script>
</body>
</html>
