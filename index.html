<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Athlete Daily Planner — Classic</title>
  <style>
    :root {
      --text: #000000;
      --muted: #3d3d3d;
      --soft: #e6e6e6;
      --accent: #000000;
    }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: "Times New Roman", Times, serif;
      background: #ffffff;
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .container {
      max-width: 720px;
      margin: 0 auto;
      padding: 16px;
      min-height: 100dvh;
      padding-bottom: 120px;
    }
    h1 { font-size: 26px; margin: 0 0 4px; font-weight: 700; }
    h2 { font-size: 20px; margin: 0 0 8px; font-weight: 700; }
    h3 { font-size: 18px; margin: 0 0 8px; font-weight: 700; }
    p.muted { color: var(--muted); margin: 0; font-size: 14px; }
    .card {
      background: #ffffff;
      border: 1px solid var(--soft);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,.04);
      margin-bottom: 16px;
    }
    .grid { display: grid; grid-gap: 12px; }
    .grid-2 { grid-template-columns: 1fr 1fr; }
    @media (max-width: 640px) { .grid-2 { grid-template-columns: 1fr; } }
    label { display: block; font-size: 12px; margin-bottom: 6px; color: var(--muted); }
    input, select, button { font-family: "Times New Roman", Times, serif; color: var(--text); }
    input[type="number"], input[type="text"], select {
      width: 100%; border: 1px solid var(--soft); border-radius: 10px; padding: 10px 12px; font-size: 16px; background: #ffffff; outline: none;
    }
    input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin_button { -webkit-appearance: none; margin: 0; }
    .row { display: flex; gap: 8px; }
    .btn { border: 1px solid var(--soft); border-radius: 12px; padding: 10px 14px; font-weight: 700; background: #fff; cursor: pointer; }
    .btn:active { transform: translateY(1px); }
    .btn-primary { background: var(--accent); color: #fff; border-color: var(--accent); }
    .likert-row { border: 1px solid var(--soft); border-radius: 10px; padding: 10px; }
    .likert-label { font-size: 15px; margin-bottom: 8px; white-space: normal; }
    .likert { display: flex; gap: 6px; flex-wrap: wrap; }
    .likert button { width: 42px; height: 42px; border-radius: 8px; border: 1px solid var(--soft); background: #fff; font-size: 16px; }
    .likert button.active { background: var(--accent); color: #fff; border-color: var(--accent); }
    .kpi-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
    @media (max-width: 480px) { .kpi-grid { grid-template-columns: 1fr; } }
    .kpi { border: 1px solid var(--soft); border-radius: 12px; padding: 12px; text-align: center; }
    .kpi small { display: block; color: var(--muted); font-size: 12px; margin-bottom: 2px; }
    .kpi b { font-size: 22px; font-weight: 700; }
    .pill { display: inline-block; font-size: 12px; padding: 4px 10px; border-radius: 999px; border: 1px solid var(--soft); color: var(--muted); }
    .verse { border-left: 3px solid var(--soft); padding-left: 10px; }
    .sticky { position: fixed; left: 0; right: 0; bottom: 0; background: #ffffff; border-top: 1px solid var(--soft); box-shadow: 0 -8px 20px rgba(0,0,0,.06); padding: 12px 16px; }
    .sticky-inner { max-width: 720px; margin: 0 auto; display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 6px; }
    @media (max-width: 560px) { .sticky-inner { grid-template-columns: 1fr 1fr; } }
    .sticky .block { display: flex; flex-direction: column; }
    .sticky small { color: var(--muted); }
    .center-between { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
    .hide { display: none; }
    .mb-8 { margin-bottom: 8px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="center-between mb-8">
      <div>
        <h1>Athlete Daily Planner</h1>
        <p class="muted">Classic, professional layout — macros, sleep, hydration (gallons), cold plunge, plan, breathing, scripture.</p>
      </div>
      <div class="row">
        <button id="exportBtn" class="btn">Print / Share</button>
        <button id="unitsBtn" class="btn">Metric</button>
      </div>
    </div>

    <div class="card">
      <div class="center-between mb-8">
        <h2>Profile</h2>
        <span id="readinessPill" class="pill">Readiness —</span>
      </div>
      <div class="grid grid-2">
        <div class="grid">
          <label>Sex</label>
          <select id="sex">
            <option value="female">Female</option>
            <option value="male">Male</option>
          </select>
        </div>
        <div class="grid">
          <label>Age (years)</label>
          <input id="age" type="number" value="24" />
        </div>

        <div class="grid" id="heightUS">
          <label>Height (ft / in)</label>
          <div class="row">
            <input id="heightFt" type="number" placeholder="ft" value="5" />
            <input id="heightIn" type="number" placeholder="in" value="6" />
          </div>
        </div>
        <div class="grid hide" id="heightMetric">
          <label>Height (cm)</label>
          <input id="heightCm" type="number" value="167.6" />
        </div>

        <div class="grid" id="weightUS">
          <label>Weight (lbs)</label>
          <input id="weightLb" type="number" value="150" />
        </div>
        <div class="grid" id="goalWeightUS">
          <label>Goal weight (lbs)</label>
          <input id="goalWeightLb" type="number" value="145" />
        </div>

        <div class="grid hide" id="weightMetric">
          <label>Weight (kg)</label>
          <input id="weightKg" type="number" value="68" />
        </div>
        <div class="grid hide" id="goalWeightMetric">
          <label>Goal weight (kg)</label>
          <input id="goalWeightKg" type="number" value="65.8" />
        </div>

        <div class="grid">
          <label>Activity level</label>
          <select id="activity">
            <option value="sedentary">Sedentary (little to no exercise)</option>
            <option value="light">Light (1–3 days/wk)</option>
            <option value="moderate" selected>Moderate (3–5 days/wk)</option>
            <option value="heavy">Heavy (6–7 days/wk)</option>
            <option value="athlete">Athlete / 2-a-days</option>
          </select>
        </div>
        <div class="grid">
          <label>Sleep last night (hours)</label>
          <input id="sleepLast" type="number" step="0.1" value="7.0" />
        </div>
        <div class="grid">
          <label>Today's session focus</label>
          <select id="sessionType">
            <option value="hypertrophy" selected>Hypertrophy / Heavy Strength</option>
            <option value="power">Power / Sprint / Skill</option>
            <option value="endurance">Conditioning / Endurance</option>
            <option value="recovery">Recovery / Mobility</option>
            <option value="competition">Competition / Back-to-back</option>
          </select>
        </div>
        <div class="grid">
          <label>Session duration (min)</label>
          <input id="sessionMin" type="number" value="60" />
        </div>

        <div class="grid" id="cycleWrap">
          <label>Menstrual cycle phase</label>
          <select id="cycle">
            <option value="menstruation">Menstruation</option>
            <option value="follicular" selected>Follicular</option>
            <option value="ovulatory">Ovulatory</option>
            <option value="luteal">Luteal</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <button id="copyBtn" class="btn">Copy Plan</button>
        <button id="ideasBtn" class="btn">Meal Ideas</button>
      </div>
    </div>

    <div class="card">
      <h2>15-Question Mental Check-In</h2>
      <div id="likertList" style="max-height: 440px; overflow: auto;"></div>
      <p class="muted" style="margin-top:8px;">Reverse-scored: stress, anxiety, soreness, fatigue, distraction.</p>
    </div>

    <div class="card">
      <h3>Today’s Plan</h3>
      <div id="planBlocks"></div>
    </div>

    <div class="card">
      <h3>Daily Macros</h3>
      <p class="muted">Goal from goal weight: <b id="goalTag">MAINTAIN</b></p>
      <div class="grid grid-2">
        <div class="grid"><span class="muted">BMR</span><b id="bmr">— kcal</b></div>
        <div class="grid"><span class="muted">TDEE</span><b id="tdee">— kcal</b></div>
        <div class="grid"><span class="muted">Target kcal</span><b id="target">— kcal</b></div>
      </div>
      <div class="kpi-grid" style="margin-top:8px;">
        <div class="kpi"><small>Protein</small><b id="gP">—g</b></div>
        <div class="kpi"><small>Carbs</small><b id="gC">—g</b></div>
        <div class="kpi"><small>Fats</small><b id="gF">—g</b></div>
      </div>
      <div id="ideas" class="hide" style="margin-top:10px;"></div>
    </div>

    <div class="card">
      <h3>Cold Plunge</h3>
      <p class="muted">Session focus, inferred goal, soreness/readiness, and (if female) cycle.</p>
      <div class="grid">
        <div class="grid-2">
          <div class="grid"><span class="muted">Recommend</span><b id="coldYesNo">—</b></div>
          <div class="grid"><span class="muted">Timing</span><b id="coldTiming">—</b></div>
        </div>
        <div id="coldExtra" class="grid hide">
          <div class="grid"><span class="muted">Temperature</span><b id="coldTemp"></b></div>
          <div class="grid"><span class="muted">Duration</span><b id="coldDur"></b></div>
        </div>
        <div><span class="muted" id="coldWhy"></span></div>
      </div>
    </div>

    <div class="card">
      <h3>Tonight’s Sleep</h3>
      <div class="grid grid-2">
        <div class="grid">
          <span class="muted">Recommended duration</span>
          <b style="font-size:28px;" id="sleepNeed">—</b>
          <span class="muted">hours</span>
        </div>
        <div class="grid">
          <span class="muted">Pre-sleep winddown</span>
          <ul style="margin:6px 0 0 18px; padding:0;">
            <li id="sleepBreath">5–10 min downshift breathing</li>
            <li>90 min before bed: hot shower/bath</li>
            <li>Limit screens & caffeine late</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Hydration & Electrolytes</h3>
      <p class="muted">Shown in gallons (gal). Baseline + session add-on.</p>
      <div class="grid grid-2">
        <div class="grid"><span class="muted">Baseline water</span><b id="hBase">— gal</b></div>
        <div class="grid"><span class="muted">Session extra</span><b id="hExtra">— gal</b></div>
        <div class="grid"><span class="muted">Total today</span><b id="hTotal">— gal</b></div>
        <div class="grid"><span class="muted">Sodium target</span><b id="hNa">—</b></div>
      </div>
      <p class="muted" style="margin-top:6px;">Heavy sweaters/heat: consider upper end of sodium range and +0.1–0.2 gal.</p>
    </div>

    <div class="card">
      <h3>Breathing Session</h3>
      <div id="breathBlock"></div>
    </div>

    <div class="card">
      <h3>Scripture for Today (NKJV)</h3>
      <div id="scripture" class="grid" style="grid-gap:10px;"></div>
      <p class="muted">Brief passages from the New King James Version (NKJV).</p>
    </div>
  </div>

  <div class="sticky">
    <div class="sticky-inner">
      <div class="block"><small>Target</small><b id="sumTarget">— kcal</b></div>
      <div class="block"><small>P/C/F</small><b id="sumPCF">—/—/— g</b></div>
      <div class="block"><small>Sleep</small><b id="sumSleep">— h</b></div>
      <div class="block"><small>Cold</small><b id="sumCold">—</b></div>
    </div>
  </div>

  <script>
    const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
    const kgFromLbs = (lbs)=> lbs * 0.45359237;
    const lbsFromKg = (kg)=> kg / 0.45359237;
    const cmFromFtIn = (ft,inch)=> ((Number(ft)||0)*12 + (Number(inch)||0)) * 2.54;
    const ACTIVITY = { sedentary: 1.2, light: 1.375, moderate: 1.55, heavy: 1.725, athlete: 1.9 };
    function mifflin({sex, kg, cm, age}) { const s = sex === 'male' ? 5 : -161; return 10*kg + 6.25*cm - 5*age + s; }
    function inferGoal(currentLb, goalLb) { const cut = currentLb * 0.97, bulk = currentLb * 1.03; return goalLb <= cut ? 'cut' : goalLb >= bulk ? 'bulk' : 'maintain'; }
    function proteinPerKg(goal) { return goal==='cut' ? 2.0 : goal==='bulk' ? 1.6 : 1.8; }
    const fatPerKgDefault = ()=>0.9;
    const sleepBase = (sex)=> sex==='female' ? 8.5 : 7.8;

    function coldPlungePlanner({ sex, goal, sessionType, readiness, soreness, cycle }) {
      const rec = { recommend:false, rationale:'', timing:'', tempC:10, tempF:50, durationMin:0 };
      const lowReadiness = readiness < 3;
      const highSoreness = soreness >= 4;
      const growthPriority = (goal==='bulk' || sessionType==='hypertrophy');
      if (growthPriority) { rec.recommend = highSoreness || lowReadiness; rec.rationale = 'Growth focus: avoid immediate post-lift cold; use only for soreness/fatigue.'; rec.timing = 'If used: 6–12+ h after lifting or next morning.'; rec.durationMin = rec.recommend ? 6 : 0; }
      else if (['competition','endurance','power'].includes(sessionType)) { rec.recommend = true; rec.rationale = 'Recovery/turnaround focus.'; rec.timing = 'Within 0–60 min post-session or later in day.'; rec.durationMin = 6; }
      else if (sessionType==='recovery') { rec.recommend = true; rec.rationale = 'Recovery day; use short, moderate cold.'; rec.timing = 'Any time, preferably earlier in day.'; rec.durationMin = 5; }
      if (sex==='female' && cycle==='luteal') { rec.tempC = 12; rec.tempF = 54; if (rec.durationMin>0) rec.durationMin = Math.max(4, rec.durationMin-1); rec.rationale += ' Luteal adjustment: slightly warmer/shorter.'; }
      if (!rec.recommend) rec.durationMin = 0;
      return rec;
    }

    function breathingPlanner({ stress, anxiety, readiness, sleepDebt }) {
      const plans = []; let focus = 'Downshift';
      if (readiness < 3 || stress >= 4 || anxiety >= 4 || sleepDebt > 1) {
        focus = 'Downshift';
        plans.push({ title: 'Physiological Sighs', detail: '1–2 breaths: inhale through nose, top-up sniff, long exhale; repeat.', duration: '5–10 min' });
        plans.push({ title: 'Resonant Breathing', detail: 'Inhale 4–5 s, exhale 6–7 s (≈5.5 breaths/min).', duration: '5–10 min' });
      } else {
        focus = 'Up-regulate / Focus';
        plans.push({ title: 'Box Breathing', detail: 'Inhale 4 s • hold 4 s • exhale 4 s • hold 4 s.', duration: '3–5 min' });
        plans.push({ title: '1:2 Focus Exhales', detail: 'Inhale 3 s, exhale 6 s for calm focus.', duration: '3–5 min' });
      }
      return { focus, items: plans };
    }

    function scripturePlanner(ctx) {
      const verses = []; const add = (ref, text) => verses.push({ ref, text });
      const { stress, anxiety, moodLow, confidenceLow, distractionHigh, supportLow, driveLow, readinessHigh, competitionDay, recoveryDay, purposeLow, calmLow, fatigueHigh, sleepDebt } = ctx;
      if (competitionDay) add('1 Corinthians 9:24–25', 'Do you not know that those who run in a race all run, but one receives the prize? Run in such a way that you may obtain it…');
      if (readinessHigh) add('Psalm 18:32–33', 'It is God who arms me with strength, and makes my way perfect. He makes my feet like the feet of deer…');
      if (confidenceLow) add('Joshua 1:9', 'Be strong and of good courage; do not be afraid, nor be dismayed, for the LORD your God is with you wherever you go.');
      if (stress || anxiety) add('Philippians 4:6–7', 'Be anxious for nothing, but in everything by prayer and supplication, with thanksgiving, let your requests be made known to God…');
      if (anxiety) add('1 Peter 5:7', 'Casting all your care upon Him, for He cares for you.');
      if (moodLow) add('Psalm 34:18', 'The LORD is near to those who have a broken heart, and saves such as have a contrite spirit.');
      if (fatigueHigh || sleepDebt > 1) add('Isaiah 40:31', 'Those who wait on the LORD shall renew their strength; they shall mount up with wings like eagles…');
      if (purposeLow) add('Proverbs 3:5–6', 'Trust in the LORD with all your heart… and He shall direct your paths.');
      if (calmLow) add('Psalm 46:10', 'Be still, and know that I am God.');
      if (distractionHigh) add('Colossians 3:23', 'Whatever you do, do it heartily, as to the Lord and not to men.');
      if (driveLow) add('Hebrews 12:1–2', '…let us run with endurance the race that is set before us, looking unto Jesus…');
      if (supportLow) add('Ecclesiastes 4:9–10', 'Two are better than one… For if they fall, one will lift up his companion.');
      if (recoveryDay) add('Matthew 11:28–29', 'Come to Me, all you who labor and are heavy laden, and I will give you rest…');
      if (!verses.length) add('Psalm 16:8', 'I have set the LORD always before me; because He is at my right hand I shall not be moved.');
      return verses.slice(0, 4);
    }

    function dayPlan({ goal, sessionType, readiness, soreness, sleepDebt }) {
      const blocks = [];
      if (readiness < 2.5 || sleepDebt > 1.5) {
        blocks.push({ label: 'Training', text: 'Easy day: technique + mobility + Zone 2 (20–30 min). Optional light accessories.' });
      } else if (soreness >= 4) {
        blocks.push({ label: 'Training', text: 'Reduce volume 25–40%. Keep intensity moderate. Emphasize long rest and form.' });
      } else {
        let txt = 'Proceed as planned.';
        if (goal==='cut' && sessionType==='hypertrophy') txt = 'Quality reps; 8–15 reps; avoid failure on first sets.';
        if (goal==='bulk' && sessionType==='hypertrophy') txt = 'Add a back-off set or +5–10% accessory volume.';
        if (sessionType==='endurance') txt = 'Main set steady; finish with 4–6 strides.';
        if (sessionType==='power') txt = 'Full recovery between sets; crisp, fast reps.';
        if (sessionType==='recovery') txt = 'Mobility, easy aerobic 15–30 min, light tissue work.';
        if (sessionType==='competition') txt = 'Warm-up progression + taper volume; post-comp refuel and brief cold if desired.';
        blocks.push({ label: 'Training', text: txt });
      }
      if (goal==='cut') blocks.push({ label: 'Nutrition', text: 'Front-load protein (≥30–40 g breakfast). Distribute protein 3–5 meals. Carbs near training.' });
      else if (goal==='bulk') blocks.push({ label: 'Nutrition', text: 'Add one carb feeding around training. Ensure +300 kcal and ≥1.6 g/kg protein.' });
      else blocks.push({ label: 'Nutrition', text: 'Even protein distribution. Carbs pre/post-session. Fats moderate.' });
      if (readiness < 3 || soreness >= 4) blocks.push({ label: 'Recovery', text: '10–20 min gentle mobility; optional cold per guidance; 10 min breathing; evening walk.' });
      else blocks.push({ label: 'Recovery', text: '5–10 min mobility and cooldown. Walk after dinner.' });
      if (sleepDebt > 0.5) blocks.push({ label: 'Sleep', text: 'Earlier winddown tonight. Optional 20 min nap before 3 pm.' });
      else blocks.push({ label: 'Sleep', text: 'Consistent schedule; protect 90-min pre-bed routine.' });
      return blocks;
    }

    const $ = (id)=>document.getElementById(id);
    const els = {
      sex: $('sex'), age: $('age'),
      heightUS: $('heightUS'), heightFt: $('heightFt'), heightIn: $('heightIn'),
      heightMetric: $('heightMetric'), heightCm: $('heightCm'),
      weightUS: $('weightUS'), weightLb: $('weightLb'),
      goalWeightUS: $('goalWeightUS'), goalWeightLb: $('goalWeightLb'),
      weightMetric: $('weightMetric'), weightKg: $('weightKg'),
      goalWeightMetric: $('goalWeightMetric'), goalWeightKg: $('goalWeightKg'),
      activity: $('activity'), sleepLast: $('sleepLast'),
      sessionType: $('sessionType'), sessionMin: $('sessionMin'),
      cycleWrap: $('cycleWrap'), cycle: $('cycle'),
      unitsBtn: $('unitsBtn'), exportBtn: $('exportBtn'),
      copyBtn: $('copyBtn'), ideasBtn: $('ideasBtn'),
      goalTag: $('goalTag'), bmr: $('bmr'), tdee: $('tdee'), target: $('target'),
      gP: $('gP'), gC: $('gC'), gF: $('gF'),
      sleepNeed: $('sleepNeed'), sleepBreath: $('sleepBreath'),
      hBase: $('hBase'), hExtra: $('hExtra'), hTotal: $('hTotal'), hNa: $('hNa'),
      coldYesNo: $('coldYesNo'), coldTiming: $('coldTiming'),
      coldExtra: $('coldExtra'), coldTemp: $('coldTemp'), coldDur: $('coldDur'),
      coldWhy: $('coldWhy'),
      sumTarget: $('sumTarget'), sumPCF: $('sumPCF'), sumSleep: $('sumSleep'), sumCold: $('sumCold'),
      likertList: $('likertList'), ideas: $('ideas'), planBlocks: $('planBlocks'),
      readinessPill: $('readinessPill'), breathBlock: $('breathBlock'), scripture: $('scripture')
    };

    const QUESTIONS = [
      { id: "conf", label: "Confidence today" },
      { id: "focus", label: "Focus on task" },
      { id: "motivation", label: "Motivation to train" },
      { id: "stress", label: "Stress (higher = worse)", reverse: true },
      { id: "mood", label: "Mood" },
      { id: "anxiety", label: "Performance anxiety (higher = worse)", reverse: true },
      { id: "readiness", label: "Overall readiness" },
      { id: "soreness", label: "Soreness (higher = worse)", reverse: true },
      { id: "fatigue", label: "Fatigue (higher = worse)", reverse: true },
      { id: "selftalk", label: "Self-talk quality" },
      { id: "purpose", label: "Clarity of goals" },
      { id: "distraction", label: "Distractions (higher = worse)", reverse: true },
      { id: "support", label: "Support from others" },
      { id: "calm", label: "Calm under pressure" },
      { id: "drive", label: "Drive to push" },
    ];

    let units = 'us'; let answers = {}; QUESTIONS.forEach(q => answers[q.id] = 3);

    function buildLikert() {
      els.likertList.innerHTML = '';
      QUESTIONS.forEach(q => {
        const row = document.createElement('div');
        row.className = 'likert-row';
        const label = document.createElement('div');
        label.className = 'likert-label';
        label.textContent = q.label;
        const group = document.createElement('div');
        group.className = 'likert';
        [1,2,3,4,5].forEach(v => {
          const btn = document.createElement('button');
          btn.type = 'button'; btn.textContent = v;
          if (answers[q.id] === v) btn.classList.add('active');
          btn.addEventListener('click', () => { answers[q.id] = v; buildLikert(); compute(); saveState(); });
          group.appendChild(btn);
        });
        row.appendChild(label); row.appendChild(group);
        els.likertList.appendChild(row);
      });
    }

    function saveState() {
      const state = {
        sex: els.sex.value, age: els.age.value,
        heightFt: els.heightFt.value, heightIn: els.heightIn.value, heightCm: els.heightCm.value,
        weightLb: els.weightLb.value, goalWeightLb: els.goalWeightLb.value,
        weightKg: els.weightKg.value, goalWeightKg: els.goalWeightKg.value,
        activity: els.activity.value, sleepLast: els.sleepLast.value,
        sessionType: els.sessionType.value, sessionMin: els.sessionMin.value,
        cycle: els.cycle.value, units, answers
      };
      try { localStorage.setItem('athletePlannerClassic', JSON.stringify(state)); } catch(e) {}
    }
    function loadState() {
      try {
        const raw = localStorage.getItem('athletePlannerClassic');
        if (!raw) return;
        const s = JSON.parse(raw); if (!s) return;
        els.sex.value = s.sex || 'female';
        els.age.value = s.age || 24;
        els.heightFt.value = s.heightFt || 5;
        els.heightIn.value = s.heightIn || 6;
        els.heightCm.value = s.heightCm || 167.6;
        els.weightLb.value = s.weightLb || 150;
        els.goalWeightLb.value = s.goalWeightLb || 145;
        els.weightKg.value = s.weightKg || 68;
        els.goalWeightKg.value = s.goalWeightKg || 65.8;
        els.activity.value = s.activity || 'moderate';
        els.sleepLast.value = s.sleepLast || 7;
        els.sessionType.value = s.sessionType || 'hypertrophy';
        els.sessionMin.value = s.sessionMin || 60;
        els.cycle.value = s.cycle || 'follicular';
        units = s.units || 'us';
        answers = s.answers || answers;
      } catch(e) {}
    }

    function showUnits() {
      const us = units === 'us';
      els.heightUS.classList.toggle('hide', !us);
      els.heightMetric.classList.toggle('hide', us);
      els.weightUS.classList.toggle('hide', !us);
      els.goalWeightUS.classList.toggle('hide', !us);
      els.weightMetric.classList.toggle('hide', us);
      els.goalWeightMetric.classList.toggle('hide', us);
      els.unitsBtn.textContent = us ? 'Metric' : 'US';
    }
    function convertToMetric() {
      const ft = Number(els.heightFt.value)||0, inch = Number(els.heightIn.value)||0;
      els.heightCm.value = (cmFromFtIn(ft, inch)).toFixed(1);
      els.weightKg.value = (kgFromLbs(Number(els.weightLb.value)||0)).toFixed(1);
      els.goalWeightKg.value = (kgFromLbs(Number(els.goalWeightLb.value)||0)).toFixed(1);
    }
    function convertToUS() {
      const cm = Number(els.heightCm.value)||0;
      const totalIn = cm/2.54;
      const ft = Math.floor(totalIn/12);
      const inch = Math.round(totalIn - ft*12);
      els.heightFt.value = ft;
      els.heightIn.value = inch;
      els.weightLb.value = (lbsFromKg(Number(els.weightKg.value)||0)).toFixed(0);
      els.goalWeightLb.value = (lbsFromKg(Number(els.goalWeightKg.value)||0)).toFixed(0);
    }
    function toggleUnits() {
      if (units==='us') { convertToMetric(); units='metric'; }
      else { convertToUS(); units='us'; }
      showUnits(); compute(); saveState();
    }

    function compute() {
      const norm = QUESTIONS.map(q => { const raw = Number(answers[q.id] || 3); return q.reverse ? 6 - raw : raw; });
      const avg = norm.reduce((a,b)=>a+b,0) / norm.length;
      const sorenessRaw = Number(answers['soreness'] || 3);
      const stressRaw = Number(answers['stress'] ? 6 - answers['stress'] : 3);
      const anxietyRaw = Number(answers['anxiety'] ? 6 - answers['anxiety'] : 3);
      const confidenceRaw = Number(answers['conf'] || 3);
      const moodRaw = Number(answers['mood'] || 3);
      const distractionRaw = Number(answers['distraction'] ? 6 - answers['distraction'] : 3);
      const supportRaw = Number(answers['support'] || 3);
      const driveRaw = Number(answers['drive'] || 3);
      const purposeRaw = Number(answers['purpose'] || 3);
      const calmRaw = Number(answers['calm'] || 3);
      const fatigueRaw = Number(answers['fatigue'] ? 6 - answers['fatigue'] : 3);

      const sex = els.sex.value;
      const age = Number(els.age.value)||0;
      const kg = (units==='metric') ? (Number(els.weightKg.value)||0) : kgFromLbs(Number(els.weightLb.value)||0);
      const cm = (units==='metric') ? (Number(els.heightCm.value)||0) : cmFromFtIn(Number(els.heightFt.value)||0, Number(els.heightIn.value)||0);
      const currentLb = (units==='metric') ? lbsFromKg(Number(els.weightKg.value)||0) : (Number(els.weightLb.value)||0);
      const goalLb = (units==='metric') ? lbsFromKg(Number(els.goalWeightKg.value)||0) : (Number(els.goalWeightLb.value)||0);
      const activity = ACTIVITY[els.activity.value] || 1.55;
      const sessionType = els.sessionType.value;
      const sessionMinutes = Number(els.sessionMin.value)||0;
      const cycle = els.cycle.value;

      const goal = inferGoal(currentLb, goalLb);
      els.goalTag.textContent = goal.toUpperCase();

      const bmr = Math.round(mifflin({sex, kg, cm, age}));
      const tdee = Math.round(bmr * activity);
      const delta = goal==='cut' ? -400 : goal==='bulk' ? 300 : 0;
      const target = Math.max(1200, tdee + delta);

      const pPerKg = proteinPerKg(goal), fatPerKg = fatPerKgDefault();
      const gP = Math.round(pPerKg * kg);
      const gF = Math.round(fatPerKg * kg);
      const carbKcal = Math.max(0, target - gP*4 - gF*9);
      const gC = Math.round(carbKcal / 4);

      els.bmr.textContent = bmr + ' kcal';
      els.tdee.textContent = tdee + ' kcal';
      els.target.textContent = target + ' kcal';
      els.gP.textContent = gP + 'g';
      els.gF.textContent = gF + 'g';
      els.gC.textContent = gC + 'g';

      let need = sleepBase(sex);
      if ((Number(els.sleepLast.value)||0) < 7) need += 0.5;
      if (avg < 3) need += 0.3;
      if (['hypertrophy','competition'].includes(sessionType)) need += 0.3;
      if (sex==='female' && cycle==='luteal') need += 0.3;
      need = clamp(Number(need.toFixed(1)), 7.0, 9.5);
      els.sleepNeed.textContent = need.toFixed(1);
      const sleepDebt = Math.max(0, 8 - (Number(els.sleepLast.value)||0));

      const baselineL = (35 * kg)/1000;
      const sessionH = sessionMinutes / 60;
      const extraPerHour = ['endurance','competition','power'].includes(sessionType) ? 0.75 : (sessionType==='recovery' ? 0.25 : 0.5);
      const extraL = Math.max(0, sessionH * extraPerHour);
      const totalL = baselineL + extraL;
      const sodium = ['endurance','competition','power'].includes(sessionType) ? '1–2 g' : '0.5–1 g';

      const toGal = (l)=> (l * 0.264172).toFixed(2);
      els.hBase.textContent = toGal(baselineL) + ' gal';
      els.hExtra.textContent = toGal(extraL) + ' gal';
      els.hTotal.textContent = toGal(totalL) + ' gal';
      els.hNa.textContent = sodium;

      const cp = coldPlungePlanner({ sex, goal, sessionType, readiness: avg, soreness: sorenessRaw, cycle: (sex==='female' ? cycle : 'na') });
      els.coldYesNo.textContent = cp.recommend ? 'Yes' : 'No';
      els.coldTiming.textContent = cp.timing || '—';
      if (cp.recommend) { els.coldExtra.classList.remove('hide'); els.coldTemp.textContent = `${cp.tempC}°C / ${cp.tempF}°F`; els.coldDur.textContent = `${cp.durationMin} min`; }
      else { els.coldExtra.classList.add('hide'); }
      els.coldWhy.textContent = cp.rationale || '';

      const pill = els.readinessPill;
      const label = avg >= 4 ? 'High' : avg >= 3 ? 'Moderate' : 'Low';
      pill.textContent = `Readiness ${label} (${avg.toFixed(1)}/5)`;

      const plan = dayPlan({ goal, sessionType, readiness: avg, soreness: sorenessRaw, sleepDebt });
      els.planBlocks.innerHTML = '';
      plan.forEach(b => {
        const item = document.createElement('div');
        item.className = 'likert-row'; item.style.marginBottom = '8px';
        item.innerHTML = `<div style="font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.02em; margin-bottom:4px;">${b.label}</div><div>${b.text}</div>`;
        els.planBlocks.appendChild(item);
      });

      const breath = breathingPlanner({ stress: stressRaw, anxiety: anxietyRaw, readiness: avg, sleepDebt });
      els.breathBlock.innerHTML = `<div style="margin-bottom:6px;"><span class="pill">Focus: ${breath.focus}</span></div><ol style="margin:0; padding-left:18px;">${breath.items.map(x => `<li><b>${x.title}:</b> ${x.detail} <span style="color:var(--muted)">(${x.duration})</span></li>`).join('')}</ol>`;
      els.sleepBreath.textContent = breath.focus==='Downshift' ? 'Resonant breathing 5–10 min' : '1:2 focus exhales 3–5 min';

      const scriptureList = scripturePlanner({
        stress: stressRaw>=4, anxiety: anxietyRaw>=4, moodLow: moodRaw<=2, confidenceLow: confidenceRaw<=2,
        distractionHigh: distractionRaw>=4, supportLow: supportRaw<=2, driveLow: driveRaw<=2,
        readinessHigh: avg>=4, competitionDay: sessionType==='competition', recoveryDay: sessionType==='recovery',
        purposeLow: purposeRaw<=2, calmLow: calmRaw<=2, fatigueHigh: fatigueRaw>=4, sleepDebt
      });
      els.scripture.innerHTML = scriptureList.map(v => `<div class="verse"><div><b>${v.ref}</b></div><div>${v.text}</div></div>`).join('');

      els.sumTarget.textContent = target + ' kcal';
      els.sumPCF.textContent = `${gP}/${gC}/${gF} g`;
      els.sumSleep.textContent = need.toFixed(1) + ' h';
      els.sumCold.textContent = cp.recommend ? 'Yes' : 'No';
    }

    function mealIdeas(proteinG, carbsG, fatG) {
      const P = Math.max(0, Math.round(proteinG*0.93));
      const C = Math.max(0, Math.round(carbsG*0.93));
      const F = Math.max(0, Math.round(fatG*0.93));
      const part = (p,c,f,r)=>({P:Math.round(p*r),C:Math.round(c*r),F:Math.round(f*r)});
      const B=part(P,C,F,.25), L=part(P,C,F,.30), D=part(P,C,F,.35), S=part(P,C,F,.10);
      const items = [
        { title:'Breakfast', macros:B, ideas:[ 'Greek yogurt + whey + berries + honey','Eggs + egg whites + sourdough + fruit','Overnight oats (milk) + chia + banana' ]},
        { title:'Lunch', macros:L, ideas:[ 'Chicken rice bowl (olive oil) + veggies','Turkey sandwich + cheese + fruit','Tuna pasta salad + spinach' ]},
        { title:'Dinner', macros:D, ideas:[ 'Salmon + potatoes + salad (oil)','Beef tacos (corn tortillas) + guac','Stir-fry tofu/chicken + rice' ]},
        { title:'Snack', macros:S, ideas:[ 'Protein shake + banana','Cottage cheese + crackers','Trail mix (portion) + fruit' ]},
      ];
      els.ideas.innerHTML = '';
      items.forEach(m => {
        const box = document.createElement('div'); box.className = 'likert-row';
        const h = document.createElement('div'); h.style.fontWeight = '700'; h.style.marginBottom = '4px'; h.textContent = m.title;
        const t = document.createElement('div'); t.style.color = 'var(--muted)'; t.style.fontSize = '12px'; t.style.marginBottom = '4px'; t.textContent = `Target ≈ P${m.macros.P}/C${m.macros.C}/F${m.macros.F} g`;
        const ul = document.createElement('ul'); ul.style.margin = '0'; ul.style.paddingLeft = '18px';
        m.ideas.forEach(it => { const li = document.createElement('li'); li.textContent = it; ul.appendChild(li); });
        box.appendChild(h); box.appendChild(t); box.appendChild(ul); els.ideas.appendChild(box);
      });
      els.ideas.classList.remove('hide');
    }

    ['sex','age','heightFt','heightIn','heightCm','weightLb','goalWeightLb','weightKg','goalWeightKg','activity','sleepLast','sessionType','sessionMin','cycle'].forEach(id => {
      const el = document.getElementById(id); if (!el) return;
      el.addEventListener('input', () => { compute(); saveState(); if (id==='sex') toggleCycle(); });
      el.addEventListener('change', () => { compute(); saveState(); if (id==='sex') toggleCycle(); });
    });
    function toggleCycle() { document.getElementById('cycleWrap').style.display = (document.getElementById('sex').value === 'female') ? 'grid' : 'none'; }

    document.getElementById('unitsBtn').addEventListener('click', () => { if (units==='us') { convertToMetric(); units='metric'; } else { convertToUS(); units='us'; } showUnits(); compute(); saveState(); });
    document.getElementById('exportBtn').addEventListener('click', ()=> window.print());
    document.getElementById('copyBtn').addEventListener('click', async ()=>{
      const text = `Target: ${document.getElementById('sumTarget').textContent}
P/C/F: ${document.getElementById('sumPCF').textContent}
Sleep: ${document.getElementById('sumSleep').textContent}
Cold plunge: ${document.getElementById('sumCold').textContent}
Hydration: ${document.getElementById('hTotal').textContent} (baseline ${document.getElementById('hBase').textContent}, extra ${document.getElementById('hExtra').textContent}); Sodium: ${document.getElementById('hNa').textContent}`;
      try { await navigator.clipboard.writeText(text); document.getElementById('copyBtn').textContent='Copied ✔'; setTimeout(()=>document.getElementById('copyBtn').textContent='Copy Plan',1200); } catch(e){}
    });
    document.getElementById('ideasBtn').addEventListener('click', ()=>{
      const p = parseInt(document.getElementById('gP').textContent)||0;
      const c = parseInt(document.getElementById('gC').textContent)||0;
      const f = parseInt(document.getElementById('gF').textContent)||0;
      mealIdeas(p,c,f);
    });

    (function init(){
      try { const raw = localStorage.getItem('athletePlannerClassic'); if (raw) { loadState(); } else { } } catch(e) {}
      buildLikert(); showUnits(); toggleCycle(); compute();
    })();
  </script>
</body>
</html>
