import React, { useMemo, useState, useEffect } from "react";
import { motion } from "framer-motion";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Tabs, TabsList, TabsTrigger, TabsContent } from "@/components/ui/tabs";
import { Slider } from "@/components/ui/slider";
import { Badge } from "@/components/ui/badge";
import { Separator } from "@/components/ui/separator";
import {
  Activity,
  Apple,
  BatteryCharging,
  BookOpen,
  Brain,
  CalendarHeart,
  Droplets,
  FlaskConical,
  Heart,
  HeartPulse,
  ListChecks,
  Moon,
  Snowflake,
  Sparkles,
  Target,
  UtensilsCrossed,
} from "lucide-react";

// ------------------------------------------------------------
// THE TUNGSTEN STANDARD — Elite MVP (Single-file React app)
// ------------------------------------------------------------
// Deepened features vs. v1:
// 1) Physiology-anchored energy & macro model (Mifflin + activity + goal + cycle).
// 2) Macro distribution by meal, fiber target, carb timing, and protein-by-FFM option.
// 3) Cardio engine with VO2max estimate (Uth formula) & HR zone calculator (Karvonen).
// 4) Hydration & electrolyte planner (L/day + sodium mg/day), sweat-rate aware heuristics.
// 5) Menstrual-phase adjustments (kcal, sleep, hydration, micronutrients, training bias).
// 6) Cold-plunge planner with performance-protection rules and contraindication hints.
// 7) 21-Point dashboard drives adaptive prescriptions, verse & prayer themes, and tips.
// 8) Daily Action Plan (AM/PM sequencing) autogenerated from weak domains.
// 9) Local storage persistence. Fully client-side; no tracking.
// ------------------------------------------------------------

// ---------- Low-level helpers ----------
const cmFromInches = (ft, inches) => (Number(ft) * 12 + Number(inches)) * 2.54;
const kgFromLbs = (lbs) => Number(lbs) * 0.45359237;
const lbsFromKg = (kg) => Number(kg) / 0.45359237;
const clamp = (v, lo, hi) => Math.min(hi, Math.max(lo, v));
const round = (x, p = 0) => Math.round(x * 10 ** p) / 10 ** p;

// Activity factors
const ACTIVITY = { sedentary: 1.2, light: 1.375, moderate: 1.55, active: 1.725, athlete: 1.9 };

// Themes for verse/prayer mapping
const VERSES = {
  strength: [
    { ref: "Philippians 4:13", text: "I can do all things through Christ who strengthens me." },
    { ref: "Joshua 1:9", text: "Be strong and of good courage..." },
  ],
  peace: [
    { ref: "John 14:27", text: "Peace I leave with you... Let not your heart be troubled." },
    { ref: "1 Peter 5:7", text: "Casting all your care upon Him, for He cares for you." },
  ],
  wisdom: [
    { ref: "James 1:5", text: "If any of you lacks wisdom, let him ask of God..." },
    { ref: "Proverbs 3:5-6", text: "Trust in the Lord... and He shall direct your paths." },
  ],
  hope: [
    { ref: "Romans 8:28", text: "All things work together for good to those who love God..." },
    { ref: "Hebrews 11:1", text: "Faith is the substance of things hoped for..." },
  ],
  grace: [
    { ref: "Ephesians 2:8-9", text: "By grace you have been saved through faith..." },
    { ref: "1 John 4:7-8", text: "Beloved, let us love one another... for God is love." },
  ],
};

const PRAYERS = {
  low: (name) => `Lord, meet ${name || "me"} in weakness and fatigue. Steady my breath, quiet my mind, and guide the next right step. Amen.`,
  medium: (name) => `Father, thank You for progress. Help ${name || "me"} be faithful in sleep, nourishment, and kindness so resilience grows. Amen.`,
  high: (name) => `Lord, thank You for momentum. Keep ${name || "me"} humble, focused, and generous. Use this health to serve others. Amen.`,
};

// Food & meal ideas
const FOOD_IDEAS = {
  protein: ["Chicken breast", "Salmon", "Greek yogurt", "Eggs", "Lentils", "Cottage cheese", "Tofu/Tempeh"],
  carbs: ["Quinoa", "Oats", "Sweet potatoes", "Brown rice", "Berries", "Beans/Lentils", "Whole-grain bread"],
  fats: ["Avocado", "Extra-virgin olive oil", "Almonds", "Walnuts", "Chia/Flax", "Peanut/Almond butter"],
  meals: {
    cutting: [
      "Yogurt + berries + 30g oats",
      "Grilled chicken, quinoa, big veggie plate",
      "Egg-white omelet, spinach, feta, side fruit",
      "Tofu stir-fry, cauliflower rice",
    ],
    maintenance: [
      "Salmon, brown rice, asparagus",
      "Turkey chili with beans",
      "Sushi bowl: rice, tuna/salmon, avocado, edamame",
      "Buddha bowl: lentils, greens, tahini",
    ],
    bulking: [
      "Whole eggs + oats + banana + nut butter",
      "Steak, sweet potato, EVOO salad",
      "Lentil curry + rice + extra olive oil",
      "Cottage cheese + fruit + granola",
    ],
  },
};

// 21-question scaffold
const QUESTIONS = [
  { key: "sleep", label: "Sleep Quality" },
  { key: "nutrition", label: "Nutrition Quality" },
  { key: "hydration", label: "Hydration & Electrolytes" },
  { key: "bodyRel", label: "Physical Self-Relationship" },
  { key: "breath", label: "Stress Management (Breathing)" },
  { key: "chatter", label: "Chatter Control" },
  { key: "compassion", label: "Self-Compassion" },
  { key: "resilience", label: "Emotional Resilience" },
  { key: "focus", label: "Mental Focus" },
  { key: "grit", label: "Resilience Building (Challenges)" },
  { key: "rhythm", label: "Internal Rhythm (Circadian/Hormonal)" },
  { key: "spiritual", label: "Spiritual Connection" },
  { key: "turnToward", label: "Turning Toward (Bids for Connection)" },
  { key: "conflict", label: "Conflict Management (Four Horsemen)" },
  { key: "trust", label: "Trust & Loyalty" },
  { key: "overthink", label: "Overthinking Control" },
  { key: "intimacy", label: "Intimacy & Desire" },
  { key: "selfExpand", label: "Self-Expansion" },
  { key: "connection", label: "Connection Quality" },
  { key: "internalHealth", label: "Internal Health (Heart/Lungs/Gut)" },
  { key: "allIn", label: "All-In Commitment" },
];

// ---------- Persistence ----------
function useLocalState(key, init) {
  const [v, setV] = useState(() => {
    try { const s = localStorage.getItem(key); return s ? JSON.parse(s) : init; } catch { return init; }
  });
  useEffect(() => { try { localStorage.setItem(key, JSON.stringify(v)); } catch {} }, [key, v]);
  return [v, setV];
}

// ---------- Core calculations ----------
// BMR: Mifflin–St Jeor
function calcBMR({ gender, age, heightCm, weightKg }) {
  if (!gender || !age || !heightCm || !weightKg) return 0;
  const s = gender === "female" ? -161 : 5;
  return 10 * weightKg + 6.25 * heightCm - 5 * age + s;
}

// Goal calories
function targetCalories({ tdee, weightKg, goalWeightKg }) {
  if (!tdee || !weightKg || !goalWeightKg) return tdee;
  const delta = goalWeightKg - weightKg;
  if (Math.abs(delta) < 2) return tdee; // maintenance
  if (delta < 0) return Math.round(tdee * 0.82); // 18% deficit
  return Math.round(tdee * 1.1); // 10% surplus
}

// Optional body-fat aware protein (if user toggles later; default off in UI)
function macrosFromCalories({ calories, weightKg, proteinGPerKg = 1.8, fatPct = 0.28 }) {
  if (!calories || !weightKg) return { protein: 0, fat: 0, carbs: 0 };
  const protein = Math.round(weightKg * proteinGPerKg);
  const fat = Math.round((calories * fatPct) / 9);
  const remainingCals = calories - protein * 4 - fat * 9;
  const carbs = Math.max(0, Math.round(remainingCals / 4));
  return { protein, fat, carbs };
}

// Female cycle adjustments
function cycleAdjustments(phase) {
  switch (phase) {
    case "menstruation":
      return {
        kcal: +100,
        waterMl: +300,
        sleepBonusH: 0.5,
        micronutrients: ["Iron 18–27mg with vitamin C", "Omega-3 (1–2g EPA/DHA)", "Magnesium glycinate 200–400mg"],
        trainingBias: "Gentle Zone 2, mobility, technique; deload heavy lifts if needed.",
      };
    case "follicular":
      return {
        kcal: 0,
        waterMl: 0,
        sleepBonusH: 0,
        micronutrients: ["Creatine 3–5g/day", "Complex carbs around training"],
        trainingBias: "Strength & HIIT tolerance higher—push progressions with good form.",
      };
    case "ovulation":
      return {
        kcal: 0,
        waterMl: +150,
        sleepBonusH: 0,
        micronutrients: ["Collagen + vitamin C for tendons", "Electrolytes in heat"],
        trainingBias: "Peak power window; thorough warm-up; watch joint laxity/injury risk.",
      };
    case "luteal":
      return {
        kcal: +150,
        waterMl: +400,
        sleepBonusH: 0.5,
        micronutrients: ["Magnesium 200–400mg", "B6 1.3–1.7mg/day", "Electrolytes"],
        trainingBias: "Favor Zone 2 and tempo; manage heat load; keep protein/fiber high.",
      };
    default:
      return { kcal: 0, waterMl: 0, sleepBonusH: 0, micronutrients: [], trainingBias: "Balanced training." };
  }
}

// Cardio engine: VO2max estimate (Uth 2004): 15.3 × (HRmax / HRrest)
// HR zones (Karvonen): targetHR = resting + intensity% × (HRmax − resting)
function estimateHRmax(age, userHrMax) {
  // Allow user override; default Tanaka: 208 − 0.7 × age
  if (userHrMax) return userHrMax;
  return Math.round(208 - 0.7 * age);
}
function estimateVO2max(hrMax, hrRest) { if (!hrMax || !hrRest) return 0; return round(15.3 * (hrMax / hrRest), 1); }
function cardioPrescription(age, totalScore, hrRest, hrMaxOverride) {
  const quality = totalScore <= 45 ? "rebuild" : totalScore <= 80 ? "build" : "perform";
  const z2 = quality === "rebuild" ? 25 : quality === "build" ? 35 : 45; // Zone 2 min/day
  const hiit = quality === "rebuild" ? 4 : quality === "build" ? 6 : 8; // × (1′ hard / 1′ easy)
  const hiitAdj = age >= 50 ? Math.max(3, hiit - 1) : hiit;
  const hrMax = estimateHRmax(age, hrMaxOverride);
  const r = Number(hrRest || 60);
  const zones = [
    { name: "Z1 Recovery", lo: 0.5, hi: 0.6 },
    { name: "Z2 Aerobic Base", lo: 0.6, hi: 0.7 },
    { name: "Z3 Tempo", lo: 0.7, hi: 0.8 },
    { name: "Z4 Threshold", lo: 0.8, hi: 0.9 },
    { name: "Z5 VO₂/Speed", lo: 0.9, hi: 1.0 },
  ].map(z => ({
    ...z,
    hr: `${Math.round(r + z.lo * (hrMax - r))}-${Math.round(r + z.hi * (hrMax - r))} bpm`,
  }));
  return {
    quality,
    zone2Min: z2,
    hiitSets: hiitAdj,
    protocol: `Zone 2 ${z2} min continuous OR ${hiitAdj} × (1′ hard / 1′ easy) after warm-up. 2–3 d/wk HIIT; rest is Zone 2/walking.`,
    hrMax,
    zones,
    vo2: estimateVO2max(hrMax, r),
  };
}

// Hydration: baseline 35 ml/kg + training. Electrolytes: sodium 1500–2300 mg baseline,
// add ~300–600 mg per liter of sweat/training fluids >60 min.
function waterMlPerDay(weightKg, trainingMin = 30) {
  if (!weightKg) return 0;
  const base = weightKg * 35; // ml
  const extra = Math.max(0, trainingMin - 30) * 8; // +8 ml per min beyond 30
  return Math.round(base + extra);
}
function sodiumPlan(waterMl, trainingMin) {
  const liters = waterMl / 1000;
  const baseline = 1800; // mg/day mid-baseline
  const extra = trainingMin > 60 ? Math.round((trainingMin - 60) * 3) : 0; // ~3 mg/min beyond 60
  const rec = clamp(baseline + extra, 1500, 4000);
  return { liters: round(liters, 1), sodiumMg: rec };
}

// Sleep target (base 7.5 h) + adjustments
function sleepHoursTarget(scoreSleep, scoreStress, femaleBonusH = 0) {
  const base = 7.5;
  const adj = (scoreSleep <= 2 ? 0.5 : 0) + (scoreStress <= 2 ? 0.5 : 0) + femaleBonusH;
  return clamp(round(base + adj, 1), 7, 9.5);
}

// Cold plunge guidance
function coldPlungePlan(totalScore) {
  if (totalScore <= 45) {
    return { temp: "50–59°F (10–15°C)", duration: "1–2 min", freq: "2–3×/wk", caution: "Use on rest/skill days; avoid right after heavy lifting." };
  } else if (totalScore <= 80) {
    return { temp: "48–57°F (9–14°C)", duration: "2–4 min", freq: "3×/wk", caution: "Separate from strength by 6–8h; fine after Zone 2." };
  }
  return { temp: "45–55°F (7–13°C)", duration: "3–5 min", freq: "3–4×/wk", caution: "Keep far from max-strength or sprint sessions to protect adaptations." };
}

function pickVerse(totalScore, weakDomains) {
  if (weakDomains.includes("stress") || weakDomains.includes("sleep")) return VERSES.peace[0];
  if (weakDomains.includes("wisdom")) return VERSES.wisdom[0];
  if (totalScore <= 45) return VERSES.peace[0];
  if (totalScore <= 80) return VERSES.wisdom[0];
  return VERSES.strength[0];
}
function pickPrayer(totalScore, name) {
  if (totalScore <= 45) return PRAYERS.low(name);
  if (totalScore <= 80) return PRAYERS.medium(name);
  return PRAYERS.high(name);
}

// Adaptive coaching tips from weak domains
function generateTips(answers, gender, cyclePhase) {
  const tips = [];
  if (answers.sleep <= 2) tips.push("Protect 8–9h sleep window, dark/cool room, 3-2-1 rule (alcohol/food/water). CBT-I: get out of bed if awake >20 min.");
  if (answers.hydration <= 2) tips.push("Start day with 500 ml water + pinch of salt; carry bottle; add electrolytes on training days.");
  if (answers.nutrition <= 2) tips.push("Hit protein floor ≥ 0.8 g/lb bodyweight; add 6–10g fiber per meal; anchor meals to training.");
  if (answers.breath <= 2) tips.push("Physiological sigh 3× when stressed; Box breathing 4-4-4-4 for 2–3 min twice daily.");
  if (answers.chatter <= 2) tips.push("Use distanced self-talk: address yourself by name; write 3-line reframe.");
  if (answers.resilience <= 2 || answers.grit <= 2) tips.push("Schedule one hard-but-safe challenge today (cold shower, hill walk, extra set).");
  if (answers.connection <= 2 || answers.turnToward <= 2) tips.push("Turn toward one small bid today: eye contact + 10-sec hug + ask one curious question.");
  if (gender === "female") {
    if (cyclePhase === "luteal") tips.push("Front-load protein/fiber early; electrolytes with heat; prefer Zone 2 if energy dips.");
    if (cyclePhase === "menstruation") tips.push("Iron with vitamin C; keep movement gentle if cramps/fatigue.");
  }
  return tips.slice(0, 8);
}

function MacroBadge({ label, grams }) {
  return <Badge className="text-sm px-3 py-1 rounded-2xl">{label}: <span className="font-semibold ml-1">{grams}g</span></Badge>;
}

export default function TungstenStandardApp() {
  // ---------- Profile ----------
  const [name, setName] = useLocalState("ts_name", "");
  const [gender, setGender] = useLocalState("ts_gender", "male");
  const [age, setAge] = useLocalState("ts_age", 30);
  const [unit, setUnit] = useLocalState("ts_unit", "imperial");
  const [heightFt, setHeightFt] = useLocalState("ts_h_ft", 5);
  const [heightIn, setHeightIn] = useLocalState("ts_h_in", 10);
  const [heightCm, setHeightCm] = useLocalState("ts_h_cm", 178);
  const [weight, setWeight] = useLocalState("ts_weight", 190);
  const [goalWeight, setGoalWeight] = useLocalState("ts_goal_weight", 180);
  const [activity, setActivity] = useLocalState("ts_activity", "moderate");
  const [cyclePhase, setCyclePhase] = useLocalState("ts_cycle", "follicular");
  const [hrRest, setHrRest] = useLocalState("ts_hr_rest", 60);
  const [hrMaxOverride, setHrMaxOverride] = useLocalState("ts_hrmax", 0);

  // ---------- 21 Questions ----------
  const [answers, setAnswers] = useLocalState("ts_q", Object.fromEntries(QUESTIONS.map(q => [q.key, 3])));
  const totalScore = useMemo(() => QUESTIONS.reduce((s, q) => s + Number(answers[q.key] || 0), 0), [answers]);

  // ---------- Derived metrics ----------
  const heightInCm = unit === "imperial" ? cmFromInches(heightFt, heightIn) : Number(heightCm);
  const weightInKg = unit === "imperial" ? kgFromLbs(weight) : Number(weight);
  const goalWeightKg = unit === "imperial" ? kgFromLbs(goalWeight) : Number(goalWeight);

  const bmr = useMemo(() => Math.round(calcBMR({ gender, age: Number(age), heightCm: heightInCm, weightKg: weightInKg })), [gender, age, heightInCm, weightInKg]);
  const tdee = useMemo(() => Math.round(bmr * (ACTIVITY[activity] || 1.55)), [bmr, activity]);
  const femaleAdj = gender === "female" ? cycleAdjustments(cyclePhase) : { kcal: 0, waterMl: 0, sleepBonusH: 0, micronutrients: [], trainingBias: "Balanced" };
  const kcalTargetBase = useMemo(() => targetCalories({ tdee, weightKg: weightInKg, goalWeightKg }), [tdee, weightInKg, goalWeightKg]);
  const kcalTarget = clamp(kcalTargetBase + (femaleAdj.kcal || 0), 1200, 5000);
  const macros = useMemo(() => macrosFromCalories({ calories: kcalTarget, weightKg: weightInKg }), [kcalTarget, weightInKg]);

  const cardio = useMemo(() => cardioPrescription(Number(age), totalScore, hrRest, hrMaxOverride || undefined), [age, totalScore, hrRest, hrMaxOverride]);
  const waterMl = useMemo(() => waterMlPerDay(weightInKg, cardio.zone2Min) + (femaleAdj.waterMl || 0), [weightInKg, cardio.zone2Min, femaleAdj.waterMl]);
  const electrolytes = useMemo(() => sodiumPlan(waterMl, cardio.zone2Min), [waterMl, cardio.zone2Min]);
  const sleepH = useMemo(() => sleepHoursTarget(answers.sleep, answers.breath, femaleAdj.sleepBonusH || 0), [answers.sleep, answers.breath, femaleAdj.sleepBonusH]);
  const tips = useMemo(() => generateTips(answers, gender, cyclePhase), [answers, gender, cyclePhase]);

  // Meal timing guidance
  const mealsPerDay = 3;
  const proteinPerMeal = Math.max(20, Math.round(macros.protein / mealsPerDay));
  const carbsTrainingBias = gender === "female" && cyclePhase === "follicular" ? 1.1 : 1.0;
  const carbsPrePost = Math.round((macros.carbs * 0.5 * carbsTrainingBias) / 2); // split pre/post

  // Verse & prayer themed by weak domains
  const weakDomains = [];
  if (answers.sleep <= 2) weakDomains.push("sleep");
  if (answers.breath <= 2 || answers.resilience <= 2) weakDomains.push("stress");
  if (answers.wisdom <= 2) weakDomains.push("wisdom");
  const verse = useMemo(() => pickVerse(totalScore, weakDomains), [totalScore, JSON.stringify(weakDomains)]);
  const prayer = useMemo(() => pickPrayer(totalScore, name), [totalScore, name]);
  const plunge = useMemo(() => coldPlungePlan(totalScore), [totalScore]);

  const goalBucket = useMemo(() => {
    if (kcalTarget < tdee * 0.95) return "cutting";
    if (kcalTarget > tdee * 1.05) return "bulking";
    return "maintenance";
  }, [kcalTarget, tdee]);

  const number = (v) => (isNaN(Number(v)) ? 0 : Number(v));

  return (
    <div className="min-h-screen w-full bg-gradient-to-b from-slate-900 via-slate-950 to-black text-slate-100">
      <div className="mx-auto max-w-7xl px-4 py-8">
        <motion.h1 initial={{ opacity: 0, y: -10 }} animate={{ opacity: 1, y: 0 }} className="text-3xl md:text-5xl font-extrabold tracking-tight text-center">
          The Tungsten Standard
        </motion.h1>
        <p className="text-center text-slate-300 mt-2">Daily, adaptive guidance for body, mind, and spirit — elite depth edition.</p>

        <Tabs defaultValue="profile" className="mt-8">
          <TabsList className="grid grid-cols-5 bg-slate-800/50">
            <TabsTrigger value="profile">Profile</TabsTrigger>
            <TabsTrigger value="checkin">21-Check</TabsTrigger>
            <TabsTrigger value="plan">Today's Plan</TabsTrigger>
            <TabsTrigger value="metrics">Physio Metrics</TabsTrigger>
            <TabsTrigger value="ideas">Food Ideas</TabsTrigger>
          </TabsList>

          {/* PROFILE */}
          <TabsContent value="profile" className="mt-6">
            <div className="grid lg:grid-cols-2 gap-6">
              <Card className="bg-slate-900/60 border-slate-700">
                <CardContent className="space-y-4 p-6">
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <Label>Name</Label>
                      <Input value={name} onChange={(e) => setName(e.target.value)} placeholder="(optional)" />
                    </div>
                    <div>
                      <Label>Gender</Label>
                      <Select value={gender} onValueChange={setGender}>
                        <SelectTrigger className="bg-slate-800 border-slate-700"><SelectValue /></SelectTrigger>
                        <SelectContent>
                          <SelectItem value="male">Male</SelectItem>
                          <SelectItem value="female">Female</SelectItem>
                        </SelectContent>
                      </Select>
                    </div>
                    <div>
                      <Label>Age</Label>
                      <Input type="number" min={12} max={100} value={age} onChange={(e)=>setAge(number(e.target.value))} />
                    </div>
                    <div>
                      <Label>Units</Label>
                      <Select value={unit} onValueChange={setUnit}>
                        <SelectTrigger className="bg-slate-800 border-slate-700"><SelectValue /></SelectTrigger>
                        <SelectContent>
                          <SelectItem value="imperial">Imperial</SelectItem>
                          <SelectItem value="metric">Metric</SelectItem>
                        </SelectContent>
                      </Select>
                    </div>
                  </div>

                  {unit === "imperial" ? (
                    <div className="grid grid-cols-4 gap-3">
                      <div>
                        <Label>Height (ft)</Label>
                        <Input type="number" min={3} max={7} value={heightFt} onChange={(e)=>setHeightFt(number(e.target.value))} />
                      </div>
                      <div>
                        <Label>Height (in)</Label>
                        <Input type="number" min={0} max={11} value={heightIn} onChange={(e)=>setHeightIn(number(e.target.value))} />
                      </div>
                      <div>
                        <Label>Weight (lb)</Label>
                        <Input type="number" min={60} max={500} value={weight} onChange={(e)=>setWeight(number(e.target.value))} />
                      </div>
                      <div>
                        <Label>Goal (lb)</Label>
                        <Input type="number" min={60} max={500} value={goalWeight} onChange={(e)=>setGoalWeight(number(e.target.value))} />
                      </div>
                    </div>
                  ) : (
                    <div className="grid grid-cols-3 gap-3">
                      <div>
                        <Label>Height (cm)</Label>
                        <Input type="number" min={120} max={220} value={heightCm} onChange={(e)=>setHeightCm(number(e.target.value))} />
                      </div>
                      <div>
                        <Label>Weight (kg)</Label>
                        <Input type="number" min={30} max={200} value={weight} onChange={(e)=>setWeight(number(e.target.value))} />
                      </div>
                      <div>
                        <Label>Goal (kg)</Label>
                        <Input type="number" min={30} max={200} value={goalWeight} onChange={(e)=>setGoalWeight(number(e.target.value))} />
                      </div>
                    </div>
                  )}

                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <Label>Activity</Label>
                      <Select value={activity} onValueChange={setActivity}>
                        <SelectTrigger className="bg-slate-800 border-slate-700"><SelectValue placeholder="Select activity" /></SelectTrigger>
                        <SelectContent>
                          <SelectItem value="sedentary">Sedentary</SelectItem>
                          <SelectItem value="light">Light (1–3 d/wk)</SelectItem>
                          <SelectItem value="moderate">Moderate (3–5 d/wk)</SelectItem>
                          <SelectItem value="active">Active (6–7 d/wk)</SelectItem>
                          <SelectItem value="athlete">Athlete / 2-a-days</SelectItem>
                        </SelectContent>
                      </Select>
                    </div>
                    <div className="grid grid-cols-2 gap-3">
                      <div>
                        <Label>Resting HR (bpm)</Label>
                        <Input type="number" min={35} max={120} value={hrRest} onChange={(e)=>setHrRest(number(e.target.value))} />
                      </div>
                      <div>
                        <Label>HRmax (override)</Label>
                        <Input type="number" min={100} max={230} value={hrMaxOverride} onChange={(e)=>setHrMaxOverride(number(e.target.value))} placeholder="auto" />
                      </div>
                    </div>
                  </div>

                  {gender === "female" && (
                    <div>
                      <Label>Cycle Phase</Label>
                      <Select value={cyclePhase} onValueChange={setCyclePhase}>
                        <SelectTrigger className="bg-slate-800 border-slate-700"><SelectValue placeholder="Select phase" /></SelectTrigger>
                        <SelectContent>
                          <SelectItem value="menstruation">Menstruation</SelectItem>
                          <SelectItem value="follicular">Follicular</SelectItem>
                          <SelectItem value="ovulation">Ovulation</SelectItem>
                          <SelectItem value="luteal">Luteal</SelectItem>
                        </SelectContent>
                      </Select>
                    </div>
                  )}

                  <Separator className="bg-slate-700" />

                  <div className="grid md:grid-cols-4 gap-3 text-sm text-slate-300">
                    <div>BMR: <span className="font-semibold text-slate-100">{bmr || "—"}</span> kcal</div>
                    <div>TDEE: <span className="font-semibold text-slate-100">{tdee || "—"}</span> kcal</div>
                    <div>Target Intake: <span className="font-semibold text-slate-100">{kcalTarget || "—"}</span> kcal</div>
                    <div>Mode: <span className="font-semibold text-slate-100 capitalize">{goalBucket}</span></div>
                  </div>
                </CardContent>
              </Card>

              <Card className="bg-slate-900/60 border-slate-700">
                <CardContent className="p-6">
                  <h3 className="font-semibold mb-3 flex items-center gap-2"><FlaskConical className="h-5 w-5"/>Daily Macros</h3>
                  <div className="flex flex-wrap gap-2">
                    <MacroBadge label="Protein" grams={macros.protein} />
                    <MacroBadge label="Carbs" grams={macros.carbs} />
                    <MacroBadge label="Fat" grams={macros.fat} />
                  </div>
                  {gender === "female" && (
                    <div className="mt-4 text-sm text-slate-300 space-y-1">
                      <div className="font-medium">Cycle Adjustments</div>
                      <div className="text-xs">Bias: {femaleAdj.trainingBias}</div>
                      <ul className="list-disc list-inside">
                        {femaleAdj.micronutrients.map((n,i)=>(<li key={i}>{n}</li>))}
                      </ul>
                    </div>
                  )}
                  <Separator className="my-4 bg-slate-700" />
                  <div className="grid md:grid-cols-3 gap-3 text-sm">
                    <div className="bg-slate-800/50 rounded-2xl p-3">
                      <div className="font-semibold mb-1">Protein per meal</div>
                      <div>{proteinPerMeal} g × {mealsPerDay} meals</div>
                    </div>
                    <div className="bg-slate-800/50 rounded-2xl p-3">
                      <div className="font-semibold mb-1">Carbs pre-workout</div>
                      <div>{carbsPrePost} g</div>
                    </div>
                    <div className="bg-slate-800/50 rounded-2xl p-3">
                      <div className="font-semibold mb-1">Carbs post-workout</div>
                      <div>{carbsPrePost} g + 20–30 g protein</div>
                    </div>
                  </div>
                </CardContent>
              </Card>
            </div>
          </TabsContent>

          {/* 21-CHECK */}
          <TabsContent value="checkin" className="mt-6">
            <Card className="bg-slate-900/60 border-slate-700">
              <CardContent className="p-6 space-y-6">
                <div className="grid md:grid-cols-2 gap-6">
                  {QUESTIONS.map((q) => (
                    <div key={q.key} className="bg-slate-800/50 rounded-2xl p-4">
                      <div className="flex justify-between items-center">
                        <Label className="text-slate-200">{q.label}</Label>
                        <Badge variant="secondary" className="bg-slate-700 text-slate-100">{answers[q.key]}</Badge>
                      </div>
                      <Slider value={[answers[q.key]]} min={1} max={5} step={1} className="mt-3" onValueChange={(v)=> setAnswers({ ...answers, [q.key]: v[0] })} />
                    </div>
                  ))}
                </div>
                <div className="text-center text-slate-300">Total Score: <span className="font-bold text-slate-100">{totalScore}</span> / 105</div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* PLAN */}
          <TabsContent value="plan" className="mt-6">
            <div className="grid xl:grid-cols-3 gap-6">
              {/* Cardio */}
              <Card className="bg-slate-900/60 border-slate-700">
                <CardContent className="p-6 space-y-2">
                  <h3 className="font-semibold mb-1 flex items-center gap-2"><HeartPulse className="h-5 w-5"/>Cardio — VO₂ Focus</h3>
                  <p className="text-sm text-slate-300">Quality: <span className="capitalize font-semibold text-slate-100">{cardio.quality}</span></p>
                  <p className="text-sm text-slate-300">VO₂max est.: <span className="font-semibold text-slate-100">{cardio.vo2 || "—"}</span> ml·kg⁻¹·min⁻¹</p>
                  <p className="text-sm text-slate-300">Zone 2: <span className="font-semibold text-slate-100">{cardio.zone2Min} min</span></p>
                  <p className="text-sm text-slate-300">HIIT: <span className="font-semibold text-slate-100">{cardio.hiitSets} × 1′ hard / 1′ easy</span></p>
                  <p className="text-xs text-slate-400">Protocol: {cardio.protocol}</p>
                </CardContent>
              </Card>

              {/* Hydration & Sleep */}
              <Card className="bg-slate-900/60 border-slate-700">
                <CardContent className="p-6 space-y-2">
                  <h3 className="font-semibold mb-1 flex items-center gap-2"><Droplets className="h-5 w-5"/>Hydration & Sleep</h3>
                  <p className="text-sm text-slate-300">Water: <span className="font-semibold text-slate-100">{electrolytes.liters}</span> L/day</p>
                  <p className="text-sm text-slate-300">Sodium: <span className="font-semibold text-slate-100">{electrolytes.sodiumMg}</span> mg/day</p>
                  <p className="text-sm text-slate-300 flex items-center gap-2"><Moon className="h-4 w-4"/>Sleep: <span className="font-semibold text-slate-100">{sleepH}</span> h target</p>
                  {gender === "female" && femaleAdj.sleepBonusH > 0 && (
                    <p className="text-xs text-slate-400">Cycle bonus applied: +{femaleAdj.sleepBonusH} h</p>
                  )}
                </CardContent>
              </Card>

              {/* Cold Plunge */}
              <Card className="bg-slate-900/60 border-slate-700">
                <CardContent className="p-6 space-y-2">
                  <h3 className="font-semibold mb-1 flex items-center gap-2"><Snowflake className="h-5 w-5"/>Cold Plunge</h3>
                  <p className="text-sm text-slate-300">Temp: <span className="font-semibold text-slate-100">{plunge.temp}</span></p>
                  <p className="text-sm text-slate-300">Duration: <span className="font-semibold text-slate-100">{plunge.duration}</span></p>
                  <p className="text-sm text-slate-300">Frequency: <span className="font-semibold text-slate-100">{plunge.freq}</span></p>
                  <p className="text-xs text-slate-400">{plunge.caution}</p>
                </CardContent>
              </Card>

              {/* Scripture & Prayer */}
              <Card className="bg-slate-900/60 border-slate-700 xl:col-span-2">
                <CardContent className="p-6">
                  <h3 className="font-semibold mb-2 flex items-center gap-2"><BookOpen className="h-5 w-5"/>Verse of the Day</h3>
                  <blockquote className="bg-slate-800/50 rounded-2xl p-4 border border-slate-700">
                    <p className="italic">“{verse.text}”</p>
                    <div className="text-right mt-2 text-slate-300">— {verse.ref} (NKJV)</div>
                  </blockquote>
                  <h3 className="font-semibold mt-4 mb-2">Daily Prayer</h3>
                  <Textarea className="bg-slate-800/60 border-slate-700" rows={3} value={prayer} readOnly />
                </CardContent>
              </Card>

              {/* Macro details */}
              <Card className="bg-slate-900/60 border-slate-700">
                <CardContent className="p-6 space-y-2">
                  <h3 className="font-semibold mb-1 flex items-center gap-2"><FlaskConical className="h-5 w-5"/>Macro Targets</h3>
                  <div className="flex flex-wrap gap-2 mb-2">
                    <MacroBadge label="Protein" grams={macros.protein} />
                    <MacroBadge label="Carbs" grams={macros.carbs} />
                    <MacroBadge label="Fat" grams={macros.fat} />
                  </div>
                  <p className="text-sm text-slate-300">Calories: <span className="font-semibold text-slate-100">{kcalTarget}</span> kcal/day</p>
                  <p className="text-xs text-slate-400">Protein ~1.8 g/kg; Fat ~28% kcal; Carbs = remainder. Evenly distribute protein across meals (≥25–35g).</p>
                </CardContent>
              </Card>

              {/* Daily Actions */}
              <Card className="bg-slate-900/60 border-slate-700 xl:col-span-3">
                <CardContent className="p-6">
                  <h3 className="font-semibold mb-2 flex items-center gap-2"><ListChecks className="h-5 w-5"/>Daily Action Plan</h3>
                  <div className="grid md:grid-cols-3 gap-4 text-sm">
                    <div className="bg-slate-800/50 rounded-2xl p-4 border border-slate-700">
                      <div className="font-semibold mb-1">AM</div>
                      <ul className="list-disc list-inside space-y-1">
                        <li>500 ml water + pinch of salt on waking</li>
                        <li>2–5 min breathwork (box or physiological sigh)</li>
                        <li>Protein-rich breakfast ≥ {proteinPerMeal} g</li>
                        <li>Light sun exposure / walk 5–10 min</li>
                      </ul>
                    </div>
                    <div className="bg-slate-800/50 rounded-2xl p-4 border border-slate-700">
                      <div className="font-semibold mb-1">Midday / Training</div>
                      <ul className="list-disc list-inside space-y-1">
                        <li>Pre-workout carbs ~ {carbsPrePost} g + 20–30 g protein</li>
                        <li>Training: {cardio.protocol}</li>
                        <li>Post-workout carbs ~ {carbsPrePost} g + 20–30 g protein</li>
                        <li>Fluids target: {electrolytes.liters} L + ~{electrolytes.sodiumMg} mg sodium total</li>
                      </ul>
                    </div>
                    <div className="bg-slate-800/50 rounded-2xl p-4 border border-slate-700">
                      <div className="font-semibold mb-1">PM</div>
                      <ul className="list-disc list-inside space-y-1">
                        <li>3-2-1 Rule (alcohol/food/water)</li>
                        <li>10-min wind-down: journal + prayer</li>
                        <li>Sleep target: {sleepH} h (cool, dark, consistent)</li>
                        <li>Cold exposure: {plunge.freq}, {plunge.temp}, {plunge.duration} (not after heavy lifts)</li>
                      </ul>
                    </div>
                  </div>
                  {tips.length > 0 && (
                    <div className="mt-4">
                      <div className="font-semibold mb-1">Smart Tips (from your check-in)</div>
                      <ul className="list-disc list-inside text-slate-300 text-sm space-y-1">
                        {tips.map((t,i)=>(<li key={i}>{t}</li>))}
                      </ul>
                    </div>
                  )}
                </CardContent>
              </Card>
            </div>
          </TabsContent>

          {/* METRICS */}
          <TabsContent value="metrics" className="mt-6">
            <Card className="bg-slate-900/60 border-slate-700">
              <CardContent className="p-6">
                <h3 className="font-semibold mb-3 flex items-center gap-2"><Target className="h-5 w-5"/>Cardio Metrics</h3>
                <div className="grid md:grid-cols-3 gap-4 text-sm">
                  <div className="bg-slate-800/50 rounded-2xl p-4 border border-slate-700">
                    <div className="font-semibold">HRmax</div>
                    <div>{cardio.hrMax} bpm (auto or override)</div>
                  </div>
                  <div className="bg-slate-800/50 rounded-2xl p-4 border border-slate-700">
                    <div className="font-semibold">Resting HR</div>
                    <div>{hrRest} bpm (morning)</div>
                  </div>
                  <div className="bg-slate-800/50 rounded-2xl p-4 border border-slate-700">
                    <div className="font-semibold">VO₂max Estimate</div>
                    <div>{cardio.vo2 || "—"} ml·kg⁻¹·min⁻¹</div>
                  </div>
                </div>
                <Separator className="my-4 bg-slate-700" />
                <div className="grid md:grid-cols-5 gap-3 text-sm">
                  {cardio.zones.map((z, i) => (
                    <div key={i} className="bg-slate-800/50 rounded-2xl p-3 border border-slate-700">
                      <div className="font-semibold">{z.name}</div>
                      <div>{z.hr}</div>
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* FOOD IDEAS */}
          <TabsContent value="ideas" className="mt-6">
            <Card className="bg-slate-900/60 border-slate-700">
              <CardContent className="p-6 space-y-4">
                <h3 className="font-semibold">Smart Food Ideas ({goalBucket})</h3>
                <div className="grid md:grid-cols-3 gap-6">
                  <div>
                    <div className="text-slate-300 text-sm mb-1">Proteins</div>
                    <ul className="list-disc list-inside text-slate-100/90 text-sm">
                      {FOOD_IDEAS.protein.map((p,i)=>(<li key={i}>{p}</li>))}
                    </ul>
                  </div>
                  <div>
                    <div className="text-slate-300 text-sm mb-1">Carbs</div>
                    <ul className="list-disc list-inside text-slate-100/90 text-sm">
                      {FOOD_IDEAS.carbs.map((p,i)=>(<li key={i}>{p}</li>))}
                    </ul>
                  </div>
                  <div>
                    <div className="text-slate-300 text-sm mb-1">Fats</div>
                    <ul className="list-disc list-inside text-slate-100/90 text-sm">
                      {FOOD_IDEAS.fats.map((p,i)=>(<li key={i}>{p}</li>))}
                    </ul>
                  </div>
                </div>
                <Separator className="bg-slate-700" />
                <div className="grid md:grid-cols-3 gap-6">
                  {FOOD_IDEAS.meals[goalBucket].map((m, i) => (
                    <div key={i} className="bg-slate-800/50 rounded-2xl p-4 border border-slate-700 text-sm">{m}</div>
                  ))}
                </div>
                <p className="text-xs text-slate-400 mt-2">Tip: meal anchor = protein + fiber + color + hydration. Carb timing around training improves performance & recovery.</p>
              </CardContent>
            </Card>
          </TabsContent>
        </Tabs>

        <div className="mt-8 text-center text-xs text-slate-500">
          <p>Educational guidance only. Not medical advice. Seek clinical care for symptoms or diagnoses.</p>
        </div>
      </div>
    </div>
  );
}
