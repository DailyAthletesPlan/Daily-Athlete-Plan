<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>The Tungsten Standard (PWA)</title>
<meta name="theme-color" content="#000000" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-title" content="Tungsten" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 256'%3E%3Crect width='256' height='256' rx='56' fill='black'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Times New Roman' font-size='160' font-weight='700' fill='white'%3ET%3C/text%3E%3C/svg%3E" />
<style>
  :root { --text:#000; --muted:#2b2b2b; --soft:#e6e6e6; --bg:#fff; }
  html, body { height:100%; }
  * { box-sizing:border-box; }
  body { margin:0; font-family:"Times New Roman", Times, serif; color:var(--text); background:#fff; font-weight:700; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
  .container { max-width:960px; margin:0 auto; padding:16px; min-height:100dvh; padding-bottom:144px; background:#fff; }
  h1{font-size:28px;margin:0 0 6px;} h2{font-size:22px;margin:0 0 10px;} h3{font-size:20px;margin:0 0 8px;} p.muted{color:#2b2b2b;margin:0;font-size:15px;}
  .card{background:#fff;border:1px solid #e6e6e6;border-radius:12px;padding:16px;margin-bottom:16px;}
  .grid{display:grid;grid-gap:12px;} .grid-2{grid-template-columns:1fr 1fr;} .grid-3{grid-template-columns:1fr 1fr 1fr;} @media (max-width:760px){.grid-2,.grid-3{grid-template-columns:1fr;}}
  label{display:block;font-size:13px;margin-bottom:6px;color:#2b2b2b;}
  input,select,button,textarea{font-family:"Times New Roman", Times, serif;font-weight:700;color:#000;background:#fff;}
  input[type="number"],input[type="text"],select,textarea{width:100%;border:1px solid #e6e6e6;border-radius:10px;padding:10px 12px;font-size:16px;outline:none;background:#fff;}
  textarea{min-height:84px;resize:vertical;}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
  .btn{border:1px solid #e6e6e6;border-radius:12px;padding:10px 14px;background:#fff;cursor:pointer;}
  .btn:active{transform:translateY(1px);} .btn.primary{background:#000;color:#fff;border-color:#000;}
  .likert-row{border:1px solid #e6e6e6;border-radius:10px;padding:12px;background:#fff;}
  .likert-label{font-size:16px;margin-bottom:8px;white-space:normal;}
  .likert{display:flex;gap:6px;flex-wrap:wrap;}
  .likert button{width:44px;height:44px;border-radius:8px;border:1px solid #e6e6e6;background:#fff;font-size:16px;}
  .likert button.active{background:#000;color:#fff;border-color:#000;}
  .kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;} @media (max-width:560px){.kpi-grid{grid-template-columns:1fr 1fr;}}
  .kpi{border:1px solid #e6e6e6;border-radius:12px;padding:12px;text-align:center;background:#fff;}
  .kpi small{display:block;color:#2b2b2b;font-size:13px;margin-bottom:3px;}
  .pill{display:inline-block;font-size:12px;padding:4px 10px;border-radius:999px;border:1px solid #e6e6e6;color:#2b2b2b;background:#fff;}
  .verse{border-left:3px solid #e6e6e6;padding-left:10px;background:#fff;}
  .sticky{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid #e6e6e6;padding:12px 16px;}
  .sticky-inner{max-width:960px;margin:0 auto;display:grid;grid-template-columns:repeat(8,1fr);gap:8px;} /* Updated grid */
  @media (max-width:640px){.sticky-inner{grid-template-columns:1fr 1fr 1fr 1fr;}}
  .sticky .block{display:flex;flex-direction:column;} .sticky small{color:#2b2b2b;}
  .center-between{display:flex;align-items:center;justify-content:space-between;gap:8px;}
  .hide{display:none;} .mb-8{margin-bottom:8px;} ul{margin:0;padding-left:18px;}
  .note{color:#2b2b2b;font-size:12px;}
</style>
</head>
<body>
  <div class="container">
    <div class="center-between mb-8">
      <div>
        <h1>The Tungsten Standard</h1>
        <p class="muted">A Holistic Plan for Mental, Physical, & Relational Health.</p>
      </div>
      <div class="row">
        <button id="installBtn" class="btn primary hide" aria-label="Install app">Install App</button>
        <button id="exportBtn" class="btn" aria-label="Print or share">Print / Share</button>
        <button id="unitsBtn" class="btn" aria-label="Toggle units">Metric</button>
      </div>
    </div>

    <div class="card">
      <div class="center-between mb-8">
        <h2>Profile</h2>
        <span id="readinessPill" class="pill">Readiness —</span>
      </div>
      <div class="grid grid-3">
        <div class="grid"><label for="sex">Sex</label><select id="sex"><option value="female">Female</option><option value="male">Male</option></select></div>
        <div class="grid"><label for="age">Age (years)</label><input id="age" type="number" value="24" /></div>
        <div class="grid"><label for="rhr">Resting HR (bpm)</label><input id="rhr" type="number" placeholder="Optional (50–75)" /></div>

        <div class="grid" id="heightUS"><label>Height (ft / in)</label><div class="row"><input id="heightFt" type="number" placeholder="ft" value="5" /><input id="heightIn" type="number" placeholder="in" value="6" /></div></div>
        <div class="grid hide" id="heightMetric"><label for="heightCm">Height (cm)</label><input id="heightCm" type="number" value="167.6" /></div>

        <div class="grid" id="weightUS"><label for="weightLb">Weight (lbs)</label><input id="weightLb" type="number" value="150" /></div>
        <div class="grid" id="goalWeightUS"><label for="goalWeightLb">Goal weight (lbs)</label><input id="goalWeightLb" type="number" value="145" /></div>

        <div class="grid hide" id="weightMetric"><label for="weightKg">Weight (kg)</label><input id="weightKg" type="number" value="68" /></div>
        <div class="grid hide" id="goalWeightMetric"><label for="goalWeightKg">Goal weight (kg)</label><input id="goalWeightKg" type="number" value="65.8" /></div>

        <div class="grid"><label for="activity">Activity level</label><select id="activity"><option value="sedentary">Sedentary</option><option value="light">Light (1–3 d/wk)</option><option value="moderate" selected>Moderate (3–5 d/wk)</option><option value="heavy">Heavy (6–7 d/wk)</option><option value="athlete">Athlete / 2-a-days</option></select></div>
        <div class="grid"><label for="sleepLast">Sleep last night (hours)</label><input id="sleepLast" type="number" step="0.1" value="7.0" /></div>
        <div class="grid"><label for="sessionType">Today's focus</label><select id="sessionType"><option value="hypertrophy" selected>Hypertrophy / Strength</option><option value="power">Power / Sprint / Skill</option><option value="endurance">Endurance / Conditioning</option><option value="recovery">Recovery / Mobility</option><option value="competition">Competition</option></select></div>
        <div class="grid"><label for="sessionMin">Session duration (min)</label><input id="sessionMin" type="number" value="60" /></div>
        <div class="grid" id="cycleWrap"><label for="cycle">Menstrual cycle phase</label><select id="cycle"><option value="menstruation">Menstruation</option><option value="follicular" selected>Follicular</option><option value="ovulatory">Ovulatory</option><option value="luteal">Luteal</option></select><span class="note">(Based on Dr. Kate Clancy's research)</span></div>
        <div class="grid">
          <label for="protEmphasis">Protein Emphasis</label>
          <select id="protEmphasis">
            <option value="normal">Normal</option>
            <option value="high" selected>High</option>
            <option value="very">Very High</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:12px;"><button id="copyBtn" class="btn">Copy Plan</button><button id="ideasBtn" class="btn">Meal Ideas</button></div>
    </div>

    <div class="card">
      <h2>15-Question Mental Health Check-In (1 = Very Low • 5 = Very High)</h2>
      <div id="likertList" style="max-height:460px;overflow:auto;"></div>
      <p class="muted" style="margin-top:8px;">Reverse-scored: Stress, Anxiety, Soreness, Fatigue, Distractions.</p>
    </div>

    <div class="card">
      <div class="center-between mb-8">
        <h2>Daily Relational Check-In (1 = Poor • 5 = Great)</h2>
        <span id="relationshipPill" class="pill">Connection —</span>
      </div>
      <div id="relationshipLikertList"></div>
      <h3 style="margin-top:12px;">Relational Feedback (Based on your answers)</h3>
      <div id="relationshipFeedback" class="verse" style="background: #fafafa; padding: 10px;">
        <p class="muted">Answer the questions above to receive actionable feedback based on research from Drs. Gottman, Perel, Kross, and Waldinger.</p>
      </div>
    </div>
    
    <div class="card"><h3>Today’s Plan</h3><div id="planBlocks"></div></div>

    <div class="card">
      <h3>Daily Macros (High-Protein Default)</h3>
      <p class="muted">Goal from goal weight: <b id="goalTag">MAINTAIN</b></p>
      <div class="grid grid-2">
        <div class="grid"><span class="muted">BMR</span><b id="bmr">— kcal</b></div>
        <div class="grid"><span class="muted">TDEE</span><b id="tdee">— kcal</b></div>
        <div class="grid"><span class="muted">Target kcal</span><b id="target">— kcal</b></div>
        <div class="grid"><span class="muted">Protein g/kg (cap 2.7)</span><b id="protModel">— g/kg</b></div>
      </div>
      <div class="kpi-grid" style="margin-top:8px;">
        <div class="kpi"><small>Protein</small><b id="gP">—g</b></div>
        <div class="kpi"><small>Carbs</small><b id="gC">—g</b></div>
        <div class="kpi"><small>Fats</small><b id="gF">—g</b></div>
        <div class="kpi"><small>Fiber (min)</small><b id="gFiber">—g</b></div>
      </div>
      <div id="ideas" class="hide" style="margin-top:10px;"></div>
      <p class="muted" style="margin-top:8px;" id="protNotes"></p>
    </div>

    <div class="card" id="cycleSuppCard">
      <h3>Supplement Considerations (Women)</h3>
      <div id="cycleSupp"></div>
      <p class="note">Educational only. Based on research from Dr. Enrique Schisterman & Dr. Lauren Colenso-Semple.</p>
    </div>

    <div class="card">
      <h3>Cold Plunge (Wim Hof Method)</h3>
      <div class="grid grid-2">
        <div class="grid"><span class="muted">Recommend</span><b id="coldYesNo">—</b></div>
        <div class="grid"><span class="muted">Timing</span><b id="coldTiming">—</b></div>
      </div>
      <div id="coldExtra" class="grid hide" style="margin-top:6px;">
        <div class="grid"><span class="muted">Temperature</span><b id="coldTemp"></b></div>
        <div class="grid"><span class="muted">Duration</span><b id="coldDur"></b></div>
      </div>
      <div><span class="muted" id="coldWhy"></span></div>
    </div>

    <div class="card">
      <h3>VO₂ & Heart-Rate Zones</h3>
      <p class="muted">Based on research from Dr. Michael Joyner (Mayo Clinic) & Dr. Joe Eisenmann.</p>
      <div class="grid grid-2">
        <div class="grid"><span class="muted">HRmax (est.)</span><b id="hrMax">— bpm</b></div>
        <div class="grid"><span class="muted">HRrest</span><b id="hrRest">— bpm</b></div>
      </div>
      <div class="grid grid-3" id="zoneTable"></div>
      <div class="likert-row" id="zonePrescription"></div>
    </div>

    <div class="card">
      <h3>VO₂ Max Goal for Today (Wu Tsai Alliance)</h3>
      <div class="grid grid-2">
        <div class="grid"><span class="muted">Estimated VO₂ max</span><b id="vo2max">— ml/kg/min</b></div>
        <div class="grid"><span class="muted">Classification</span><b id="vo2class">—</b></div>
      </div>
      <div class="likert-row" id="vo2target" style="margin-top:12px;"></div>
      <p class="note" id="vo2note" style="margin-top:8px;">VO₂max uses HRmax and Resting HR. Enter Resting HR for accuracy.</p>
    </div>

    <div class="card">
      <h3>Weekly Conditioning Targets</h3>
      <div class="grid grid-3">
        <div class="kpi"><small>Z2 minutes (goal)</small><b id="wkZ2Goal">—</b></div>
        <div class="kpi"><small>Z5 minutes (goal)</small><b id="wkZ5Goal">—</b></div>
        <div class="kpi"><small>Completed</small><b id="wkDone">—</b></div>
      </div>
      <div class="row" style="margin-top:8px;">
        <button id="addZ2" class="btn">+5 min Z2</button>
        <button id="addZ5" class="btn">+1 min Z5</button>
        <button id="resetWeek" class="btn">Reset Week</button>
      </div>
      <p class="note">Progress saves on this device.</p>
    </div>

    <div class="card">
      <h3>Tonight’s Sleep (Dr. Matthew Walker)</h3>
      <div class="grid grid-2">
        <div class="grid"><span class="muted">Recommended duration</span><b style="font-size:28px;" id="sleepNeed">—</b><span class="muted">hours</span></div>
        <div class="grid"><span class="muted">Pre-sleep wind-down (Dr. Breus)</span><ul><li id="sleepBreath">5–10 min downshift breathing</li><li>90 min before bed: hot shower/bath</li><li>Limit screens & caffeine late</li></ul></div>
      </div>
      <div class="likert-row" id="sleepDeepDive"></div>
    </div>

    <div class="card">
      <h3>Hydration & Electrolytes</h3>
      <p class="muted" id="hydrationUnitLabel">Gallons (gal). Baseline + session add-on.</p>
      <div class="grid grid-2">
        <div class="grid"><span class="muted">Baseline water</span><b id="hBase">— gal</b></div>
        <div class="grid"><span class="muted">Session extra</span><b id="hExtra">— gal</b></div>
        <div class="grid"><span class="muted">Total today</span><b id="hTotal">— gal</b></div>
        <div class="grid"><span class="muted">Sodium target</span><b id="hNa">—</b></div>
      </div>
    </div>

    <div class="card"><h3>Breathing Session (SEAL Box Breathing)</h3><div id="breathBlock"></div></div>
    <div class="card"><h3>Self-Talk (Drs. Kross & Turow)</h3><div id="selfTalk"></div></div>
    <div class="card"><h3>Daily Prayer (Knechtle & Giovannetti)</h3><div id="prayer"></div></div>

    <div class="card">
      <h3>Scripture for Today (NKJV)</h3>
      <div id="scripture" class="grid" style="grid-gap:10px;"></div>
      <p class="muted">Themes adapt to your check-in. You can merge unlimited verses via <code>window.NKJV_EXTRA</code>.</p>
    </div>
  </div>

  <div class="sticky" role="status" aria-live="polite">
    <div class="sticky-inner">
      <div class="block"><small>Target</small><b id="sumTarget">— kcal</b></div>
      <div class="block"><small>P/C/F</small><b id="sumPCF">—/—/— g</b></div>
      <div class="block"><small>Relational</small><b id="sumRelationship">—</b></div> <div class="block"><small>Sleep</small><b id="sumSleep">— h</b></div>
      <div class="block"><small>Zone</small><b id="sumZone">—</b></div>
      <div class="block"><small>VO2 Goal</small><b id="sumVo2">—</b></div>
      <div class="block"><small>Week</small><b id="sumWeek">—</b></div>
      <div class="block"><small>Readiness</small><b id="sumReadiness">— %</b></div>
    </div>
  </div>

<script>
/***** PWA bootstrap (manifest + inline service worker) *****/
(function setupPWA(){
  const svg = size => `<?xml version="1.0"?><svg xmlns='http://www.w3.org/2000/svg' width='${size}' height='${size}' viewBox='0 0 ${size} ${size}'><rect width='100%' height='100%' rx='${Math.round(size*0.22)}' fill='black'/><text x='50%' y='54%' font-family='Times New Roman' font-weight='700' font-size='${Math.round(size*0.7)}' text-anchor='middle' fill='white'>T</text></svg>`;
  const makeIcon = size => URL.createObjectURL(new Blob([svg(size)], { type: 'image/svg+xml' }));
  // *** UPDATED MANIFEST ***
  const manifest = { name:'The Tungsten Standard', short_name:'Tungsten', start_url:'.', display:'standalone', background_color:'#ffffff', theme_color:'#000000', icons:[ {src:makeIcon(192),sizes:'192x192',type:'image/svg+xml'}, {src:makeIcon(512),sizes:'512x512',type:'image/svg+xml'} ] };
  const manifestURL = URL.createObjectURL(new Blob([JSON.stringify(manifest)], { type:'application/json' }));
  const link=document.createElement('link'); link.rel='manifest'; link.href=manifestURL; document.head.appendChild(link);
  if('serviceWorker' in navigator){
    const swCode = `const CACHE='tungsten-standard-v1';self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE).then(c=>c.addAll([self.registration.scope])).then(()=>self.skipWaiting()))});self.addEventListener('activate',e=>{e.waitUntil(self.clients.claim())});self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(h=>h||fetch(e.request).then(res=>{const cp=res.clone();caches.open(CACHE).then(c=>{if(e.request.method==='GET'&&new URL(e.request.url).origin===location.origin)c.put(e.request,cp);});return res;})))})`;
    const swURL = URL.createObjectURL(new Blob([swCode], { type:'text/javascript' }));
    navigator.serviceWorker.register(swURL).catch(()=>{});
  }
  let deferredPrompt=null; const installBtn=document.getElementById('installBtn');
  window.addEventListener('beforeinstallprompt',(e=>{e.preventDefault();deferredPrompt=e;installBtn.classList.remove('hide');}));
  installBtn?.addEventListener('click',async()=>{if(!deferredPrompt)return;deferredPrompt.prompt();await deferredPrompt.userChoice;installBtn.classList.add('hide');deferredPrompt=null;});
})();
</script>

<script>
// --- Wrap entire application in an IIFE
(function TungstenStandardApp() {

  /***** Constants & Content Pools *****/
  const todayKey = new Date().toISOString().slice(0, 10);
  const STORAGE_KEY = 'tungstenStandard-v1'; // *** UPDATED STORAGE KEY ***
  
  const ACTIVITY = { sedentary: 1.2, light: 1.375, moderate: 1.55, heavy: 1.725, athlete: 1.9 };
  const FAT_PER_KG = 0.9;
  const FIBER_PER_1000_KCAL = 14;

  const VO2_CLASSIFICATION = {
    male: { '18-25': [39, 44, 49, 54], '26-35': [36, 41, 46, 51], '36-45': [32, 37, 42, 47], '46-55': [29, 34, 38, 43], '56-65': [26, 31, 35, 40], '65+':   [23, 28, 32, 36] },
    female: { '18-25': [33, 38, 43, 48], '26-35': [30, 35, 39, 44], '36-45': [27, 31, 36, 40], '46-55': [25, 29, 33, 37], '56-65': [22, 26, 30, 34], '65+':   [20, 24, 28, 31] }
  };

  const QUESTIONS = [
    {id:'conf',label:'Confidence (1 = very low • 5 = very high)'},
    {id:'focus',label:'Focus on task (1 = scattered • 5 = locked in)'},
    {id:'motivation',label:'Motivation to train (1 = none • 5 = high)'},
    {id:'stress',label:'Stress (1 = none • 5 = very high; reverse-scored)',reverse:true},
    {id:'mood',label:'Mood (1 = poor • 5 = great)'},
    {id:'anxiety',label:'Performance anxiety (1 = calm • 5 = severe; reverse-scored)',reverse:true},
    {id:'readiness',label:'Overall readiness (1 = low • 5 = high)'},
    {id:'soreness',label:'Soreness (1 = none • 5 = severe; reverse-scored)',reverse:true},
    {id:'fatigue',label:'Fatigue (1 = fresh • 5 = exhausted; reverse-scored)',reverse:true},
    {id:'selftalk',label:'Self-talk quality (1 = negative • 5 = positive)'},
    {id:'purpose',label:'Clarity of goals (1 = unclear • 5 = crystal clear)'},
    {id:'distraction',label:'Distractions (1 = none • 5 = constant; reverse-scored)',reverse:true},
    {id:'support',label:'Support from others (1 = none • 5 = strong)'},
    {id:'calm',label:'Calm under pressure (1 = shaky • 5 = steady)'},
    {id:'drive',label:'Drive to push (1 = off • 5 = on)'}
  ];

  // *** NEW: Relationship Questions Based on Research ***
  const RELATIONSHIP_QUESTIONS = [
    {id: 'r_connection', label: "Our emotional & physical connection today. (Perel & Gottman)"},
    {id: 'r_conflict', label: "Our ability to handle conflict respectfully (No 'Four Horsemen'). (Gottman)"},
    {id: 'r_support', label: "My effectiveness as a supportive, secure partner. (Waldinger)"},
    {id: 'r_chatter', label: "My ability to manage my *own* 'chatter' (overthinking/anxiety). (Kross)"},
    {id: 'r_growth', label: "Our sense of fun, growth, and 'self-expansion.' (Lewandowski)"}
  ];

  // (All content pools like NKJV_BASE, BREATH, MEALS, etc. are unchanged)
  const NKJV_BASE={courage:[{ref:'Joshua 1:9',txt:'Be strong and of good courage...'},{ref:'Deuteronomy 31:6',txt:'He will not leave you nor forsake you.'},{ref:'Psalm 27:1',txt:'The LORD is my light and my salvation; whom shall I fear?'}],focus:[{ref:'Colossians 3:23',txt:'Whatever you do, do it heartily, as to the Lord and not to men.'},{ref:'Philippians 3:14',txt:'I press toward the goal for the prize of the upward call...'},{ref:'Proverbs 4:25',txt:'Let your eyes look straight ahead...'}],peace:[{ref:'Philippians 4:6–7',txt:'Be anxious for nothing... and the peace of God...'},{ref:'John 14:27',txt:'Peace I leave with you...'},{ref:'Isaiah 26:3',txt:'You will keep him in perfect peace...'}],strength:[{ref:'Isaiah 40:31',txt:'Those who wait on the LORD shall renew their strength...'},{ref:'Psalm 18:32–33',txt:'It is God who arms me with strength...'},{ref:'Habakkuk 3:19',txt:'The LORD God is my strength...'}],endurance:[{ref:'Hebrews 12:1–2',txt:'...let us run with endurance the race that is set before us...'},{ref:'James 1:12',txt:'Blessed is the man who endures temptation...'},{ref:'Romans 5:3–4',txt:'Tribulation produces perseverance...'}],help:[{ref:'Psalm 46:1',txt:'God is our refuge and strength...'},{ref:'Psalm 34:17',txt:'The righteous cry out, and the LORD hears...'},{ref:'Isaiah 41:10',txt:'Fear not, for I am with you... I will strengthen you...'}],hope:[{ref:'Lamentations 3:22–23',txt:'Through the LORD’s mercies we are not consumed...'},{ref:'Romans 15:13',txt:'Now may the God of hope fill you with all joy and peace...'},{ref:'Psalm 31:24',txt:'Be of good courage, and He shall strengthen your heart...'}],recovery:[{ref:'Matthew 11:28–29',txt:'Come to Me, all you who labor...'},{ref:'Psalm 23:1–3',txt:'The LORD is my shepherd... He restores my soul...'},{ref:'3 John 2',txt:'Beloved, I pray that you may prosper in all things...'}],victory:[{ref:'1 Corinthians 9:24–25',txt:'Run in such a way that you may obtain it...'},{ref:'1 John 5:4',txt:'For whatever is born of God overcomes the world...'},{ref:'Romans 8:37',txt:'In all these things we are more than conqUerors...'}]};
  const NKJV = (()=>{const extra=(window.NKJV_EXTRA||{}); const out={}; const themes=new Set([...Object.keys(NKJV_BASE),...Object.keys(extra)]); themes.forEach(t=>{out[t]=[...(NKJV_BASE[t]||[]),...((extra[t]||[]))];}); return out;})();
  const BREATH={downshift:[{title:'Physiological Sighs (Dr. Huberman)',detail:'Nasal inhale; top-up sniff; long slow exhale.',duration:'5–10 min'},{title:'Resonant 5.5 bpm',detail:'In 4–5 s, out 6–7 s. Relax shoulders.',duration:'5–10 min'},{title:'4-7-8 (Dr. Weil)',detail:'In 4 • Hold 7 • Out 8.',duration:'4–8 min'},{title:'Extended Exhale 1:2',detail:'In 3 s • Out 6 s.',duration:'3–10 min'}],focus:[{title:'Box 4-4-4-4 (SEALs)',detail:'In 4 • Hold 4 • Out 4 • Hold 4.',duration:'3–6 min'},{title:'Tactical 4/4',detail:'In 4 • Out 4.',duration:'3–10 min'},{title:'Nasal Tempo',detail:'Even cadence; nasal only.',duration:'5–10 min'}]};
  const MEALS={breakfast:['Greek yogurt (2%) + whey + berries + honey','Eggs + egg whites + sourdough + fruit','Overnight oats (milk) + chia + banana (+ whey)','Protein pancakes + peanut butter + blueberries','Cottage cheese bowl: pineapple + granola','Smoked salmon + eggs + potato + spinach','Turkey sausage egg bites + fruit','Tofu scramble + black beans + avocado'],lunch:['Chicken rice bowl (olive oil) + veggies','Turkey sandwich + cheese + fruit','Tuna pasta salad + spinach','Beef burrito bowl + beans + salsa','Shrimpa quinoa bowl + avocado','Lentil soup + whole grain toast + yogurt','Grilled chicken Caesar (light dressing) + fruit','Soba noodles + edame + sesame chicken'],dinner:['Salmon + potatoes + salad (olive oil)','Beef tacos (corn tortillas) + guac','Stir-fry tofu/chicken + rice','Pork tenderloin + rice pilaf + green beans','Chicken parmesan + pasta + side salad','Turkey chili + rice + side veggies','Baked cod + couscous + asparagus','Bison burger (no bun) + sweet potato + slaw'],snack:['Protein shake + banana','Cottage cheese + crackers','Trail mix (portion) + fruit','String cheese + apple + almonds','Greek yogurt + granola','Beef jerky + orange','Edamame + sea salt','Hummus + carrots + turkey roll-ups']};
  const SELF_TALK={female:{boost:['I am capable, composed, and powerful.','My breath sets my rhythm; my rhythm sets my performance.','Strength and grace work together in me.'],focus:['I aim my attention where it matters and keep it there.','One task at a time, with poise.'],calm:['Pressure reveals my poise; I respond with composure.','I slow my breath and lead my body.'],grit:['I finish what I start with great form.','Discipline over mood — I execute.']},male:{boost:['I bring calm focus and decisive action to every rep.','I do the hard things well.','I control my breathing, my tempo, my outcome.'],focus:['Laser on the next rep; nothing extra.','Simple, crisp, repeatable actions.'],calm:['I stay composed; my breath steadies my mind.','I trade tension for accuracy.'],grit:['Discipline over mood — I execute.','I finish strong: efficient, fast, relentless.']}};
  const PRAYERS=['Lord, grant me wisdom, steady breath, and strength to honor You in every choice today. Amen.','Father, guide my steps, protect my mind from distraction, and help me serve others with joy. Amen.','Jesus, shape my effort and attitude. Keep me humble in victory and teachable in struggle. Amen.','God, quiet my anxiety, sharpen my focus, and fill me with courage to do what is right. Amen.','Lord, thank You for this day. Help me to steward my body and gifts for Your glory. Amen.'];


  /***** Helper Utilities *****/
  const $ = id => document.getElementById(id);
  const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
  const kgFromLbs = lbs => (lbs || 0) * 0.45359237;
  const lbsFromKg = kg => (kg || 0) / 0.45359237;
  const cmFromFtIn = (ft, inch) => ((Number(ft) || 0) * 12 + (Number(inch) || 0)) * 2.54;
  const ftInFromCm = (cm) => {
    const totalInches = (cm || 0) / 2.54;
    const ft = Math.floor(totalInches / 12);
    const inch = Math.round((totalInches % 12) * 10) / 10;
    return { ft, inch };
  };

  function getBag(key){try{const raw=localStorage.getItem(key);if(!raw)return{date:todayKey,used:[]};const o=JSON.parse(raw);if(!o||o.date!==todayKey)return{date:todayKey,used:[]};return o;}catch{return{date:todayKey,used:[]};}}
  function setBag(key,bag){try{localStorage.setItem(key,JSON.stringify(bag));}catch{}}
  function nonRepeatingPick(key,arr,count){const bag=getBag(key);let pool=arr.map((v,i)=>({v,i})).filter(x=>!bag.used.includes(x.i));if(pool.length<count){bag.used=[];setBag(key,bag);} const bag2=getBag(key);let pool2=arr.map((v,i)=>({v,i})).filter(x=>!bag2.used.includes(x.i));for(let i=pool2.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[pool2[i],pool2[j]]=[pool2[j],pool2[i]];}const picks=pool2.slice(0,count);picks.forEach(p=>bag2.used.push(p.i));setBag(key,bag2);return picks.map(p=>p.v);}

  /***** DOM Elements *****/
  const els = {
    sex: $("sex"), age: $("age"), rhr: $("rhr"),
    heightUS: $("heightUS"), heightFt: $("heightFt"), heightIn: $("heightIn"),
    heightMetric: $("heightMetric"), heightCm: $("heightCm"),
    weightUS: $("weightUS"), weightLb: $("weightLb"),
    goalWeightUS: $("goalWeightUS"), goalWeightLb: $("goalWeightLb"),
    weightMetric: $("weightMetric"), weightKg: $("weightKg"),
    goalWeightMetric: $("goalWeightMetric"), goalWeightKg: $("goalWeightKg"),
    activity: $("activity"), sleepLast: $("sleepLast"), sessionType: $("sessionType"),
    sessionMin: $("sessionMin"), cycleWrap: $("cycleWrap"), cycle: $("cycle"),
    protEmphasis: $("protEmphasis"), unitsBtn: $("unitsBtn"), exportBtn: $("exportBtn"),
    copyBtn: $("copyBtn"), ideasBtn: $("ideasBtn"),
    goalTag: $("goalTag"), bmr: $("bmr"), tdee: $("tdee"), target: $("target"),
    protModel: $("protModel"), gP: $("gP"), gC: $("gC"), gF: $("gF"), gFiber: $("gFiber"),
    protNotes: $("protNotes"), sleepNeed: $("sleepNeed"), sleepBreath: $("sleepBreath"),
    hydrationUnitLabel: $("hydrationUnitLabel"), hBase: $("hBase"), hExtra: $("hExtra"), hTotal: $("hTotal"), hNa: $("hNa"),
    coldYesNo: $("coldYesNo"), coldTiming: $("coldTiming"), coldExtra: $("coldExtra"),
    coldTemp: $("coldTemp"), coldDur: $("coldDur"), coldWhy: $("coldWhy"),
    sumTarget: $("sumTarget"), sumPCF: $("sumPCF"), sumFiber: $("sumFiber"),
    sumSleep: $("sumSleep"), sumZone: $("sumZone"), sumVo2: $("sumVo2"), sumWeek: $("sumWeek"),
    sumReadiness: $("sumReadiness"), // NEW
    sumRelationship: $("sumRelationship"), // NEW
    likertList: $("likertList"), 
    relationshipLikertList: $("relationshipLikertList"), // NEW
    relationshipPill: $("relationshipPill"), // NEW
    relationshipFeedback: $("relationshipFeedback"), // NEW
    ideas: $("ideas"), planBlocks: $("planBlocks"),
    readinessPill: $("readinessPill"), breathBlock: $("breathBlock"), scripture: $("scripture"),
    selfTalk: $("selfTalk"), prayer: $("prayer"),
    hrMax: $("hrMax"), hrRest: $("hrRest"), zoneTable: $("zoneTable"), zonePrescription: $("zonePrescription"),
    cycleSupp: $("cycleSupp"), cycleSuppCard: $("cycleSuppCard"),
    vo2max: $("vo2max"), vo2class: $("vo2class"), vo2target: $("vo2target"), vo2note: $("vo2note"),
    wkZ2Goal: $("wkZ2Goal"), wkZ5Goal: $("wkZ5Goal"), wkDone: $("wkDone"),
    addZ2: $("addZ2"), addZ5: $("addZ5"), resetWeek: $("resetWeek")
  };

  /***** STATE MANAGEMENT *****/
  let state = {
    units: 'us',
    sex: 'female',
    age: 24,
    rhr: 55, // Default RHR to populate VO2 max
    heightFt: 5,
    heightIn: 6,
    heightCm: 167.6,
    weightLb: 150,
    goalWeightLb: 145,
    weightKg: 68,
    goalWeightKg: 65.8,
    activity: 'moderate',
    sleepLast: 7.0,
    sessionType: 'hypertrophy',
    sessionMin: 60,
    cycle: 'follicular',
    protEmphasis: 'high',
    answers: {},
    relationshipAnswers: {}, // NEW
    weeklyZ2: 0,
    weeklyZ5: 0
  };

  // Populate initial answers
  QUESTIONS.forEach(q => state.answers[q.id] = 3);
  RELATIONSHIP_QUESTIONS.forEach(q => state.relationshipAnswers[q.id] = 3); // NEW
  
  function saveState() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    } catch (e) {
      console.warn('Failed to save state to localStorage', e);
    }
  }

  function loadState() {
    try {
      const storedState = localStorage.getItem(STORAGE_KEY);
      if (storedState) {
        const loaded = JSON.parse(storedState);
        state = { ...state, ...loaded }; // Merge loaded data over defaults
        
        let loadedAnswers = loaded.answers || {};
        QUESTIONS.forEach(q => {
          state.answers[q.id] = loadedAnswers[q.id] || 3;
        });
        
        // NEW: Load relationship answers
        let loadedRelAnswers = loaded.relationshipAnswers || {};
        RELATIONSHIP_QUESTIONS.forEach(q => {
          state.relationshipAnswers[q.id] = loadedRelAnswers[q.id] || 3;
        });
      }
    } catch (e) {
      console.warn('Failed to load state, using defaults', e);
      localStorage.removeItem(STORAGE_KEY);
    }
  }

  function syncDomFromState() {
    els.sex.value = state.sex;
    els.age.value = state.age;
    els.rhr.value = state.rhr || '';
    els.heightFt.value = state.heightFt;
    els.heightIn.value = state.heightIn;
    els.heightCm.value = state.heightCm;
    els.weightLb.value = state.weightLb;
    els.goalWeightLb.value = state.goalWeightLb;
    els.weightKg.value = state.weightKg;
    els.goalWeightKg.value = state.goalWeightKg;
    els.activity.value = state.activity;
    els.sleepLast.value = state.sleepLast;
    els.sessionType.value = state.sessionType;
    els.sessionMin.value = state.sessionMin;
    els.cycle.value = state.cycle;
    els.protEmphasis.value = state.protEmphasis;

    toggleUnitViews(state.units);
    els.cycleWrap.style.display = state.sex === 'female' ? 'grid' : 'none';
  }

  /***** UI BUILDERS & HELPERS *****/
  const display = (el, show) => el.style.display = show ? (el.dataset.d || 'grid') : 'none';
  const updateHTML = (id, val, unit = '') => {
    if (els[id]) els[id].innerHTML = (val != null && val !== 'N/A') ? (val + unit) : '—';
  };
  const updateText = (id, val) => {
    if (els[id]) els[id].textContent = val ?? '—';
  };
  const r = (n, f = 0) => n == null ? null : Number(n.toFixed(f));

  function buildLikert() {
    els.likertList.innerHTML = '';
    QUESTIONS.forEach(q => {
      const row = document.createElement('div');
      row.className = 'likert-row';
      const label = document.createElement('div');
      label.className = 'likert-label';
      label.textContent = q.label;
      const group = document.createElement('div');
      group.className = 'likert';
      
      [1, 2, 3, 4, 5].forEach(v => {
        const b = document.createElement('button');
        b.type = 'button';
        b.textContent = v;
        const isActive = state.answers[q.id] === v;
        b.setAttribute('aria-pressed', isActive ? 'true' : 'false');
        if (isActive) b.classList.add('active');
        
        b.addEventListener('click', () => {
          state.answers[q.id] = v;
          buildLikert();
          recalculateAndSave();
        });
        group.appendChild(b);
      });
      row.appendChild(label);
      row.appendChild(group);
      els.likertList.appendChild(row);
    });
  }
  
  // *** NEW: Build Relationship Likert ***
  function buildRelationshipLikert() {
    els.relationshipLikertList.innerHTML = '';
    RELATIONSHIP_QUESTIONS.forEach(q => {
      const row = document.createElement('div');
      row.className = 'likert-row';
      const label = document.createElement('div');
      label.className = 'likert-label';
      label.textContent = q.label;
      const group = document.createElement('div');
      group.className = 'likert';
      
      [1, 2, 3, 4, 5].forEach(v => {
        const b = document.createElement('button');
        b.type = 'button';
        b.textContent = v;
        const isActive = state.relationshipAnswers[q.id] === v;
        b.setAttribute('aria-pressed', isActive ? 'true' : 'false');
        if (isActive) b.classList.add('active');
        
        b.addEventListener('click', () => {
          state.relationshipAnswers[q.id] = v;
          buildRelationshipLikert(); // Re-render this component
          recalculateAndSave(); // Run full calculation
        });
        group.appendChild(b);
      });
      row.appendChild(label);
      row.appendChild(group);
      els.relationshipLikertList.appendChild(row);
    });
  }

  function toggleUnitViews(newUnits) {
    const isUS = newUnits === 'us';
    display(els.heightUS, isUS);
    display(els.weightUS, isUS);
    display(els.goalWeightUS, isUS);
    display(els.heightMetric, !isUS);
    display(els.weightMetric, !isUS);
    display(els.goalWeightMetric, !isUS);
    els.unitsBtn.textContent = isUS ? 'Metric' : 'US (lbs/ft)';
    updateText('hydrationUnitLabel', isUS ? 'Gallons (gal). Baseline + session add-on.' : 'Liters (L). Baseline + session add-on.');
  }

  /***** CALCULATION LOGIC *****/
  
  function _calculateReadiness(answers, sleepLast) {
    const sleepBase = state.sex === 'female' ? 8.5 : 7.8;
    const sleepDebt = Math.max(0, sleepBase - sleepLast);
    let score = 0;
    QUESTIONS.forEach(q => {
      let v = answers[q.id];
      if (q.reverse) v = 6 - v;
      score += v;
    });
    let readinessScore = Math.round((score / (QUESTIONS.length * 5)) * 100);
    if (sleepDebt > 1) readinessScore -= 5;
    if (sleepDebt > 2) readinessScore -= 10;
    
    let pillText = '...';
    if (readinessScore >= 85) pillText = 'Primed';
    else if (readinessScore >= 70) pillText = 'Ready';
    else if (readinessScore >= 50) pillText = 'Moderate';
    else if (readinessScore >= 30) pillText = 'Low';
    else pillText = 'Very Low';
    
    return {
      score: readinessScore,
      pill: `Readiness ${readinessScore}% (${pillText})`,
      sleepDebt: sleepDebt,
      rawScore: score
    };
  }
  
  // *** NEW: Calculate Relationship Score & Feedback ***
  function _calculateRelationship(answers) {
    let score = 0;
    RELATIONSHIP_QUESTIONS.forEach(q => {
      score += answers[q.id];
    });
    
    const total = RELATIONSHIP_QUESTIONS.length * 5;
    const percentage = (score / total) * 100;
    
    let pill = '...';
    if (percentage >= 90) pill = 'Tungsten';
    else if (percentage >= 70) pill = 'Connected';
    else if (percentage >= 50) pill = 'Coasting';
    else if (percentage >= 30) pill = 'Disconnected';
    else pill = 'Critical';
    
    let feedback = [];
    
    // The "Nice Call Out" Logic
    if (answers.r_conflict <= 2) {
      feedback.push("<b>Conflict Alert:</b> A low score here suggests one of **Dr. Gottman's 'Four Horsemen'** (Criticism, Contempt, Defensiveness, or Stonewalling) is present. These are the top predictors of separation. Focus today on a gentle start-up: 'I feel (X) about (Y), I need (Z).' instead of 'You always (X)'.");
    }
    if (answers.r_connection <= 2) {
      feedback.push("<b>Connection Low:</b> **Dr. Gottman's** research shows trust is built in tiny 'sliding door' moments, not grand gestures. **Esther Perel** notes that desire needs novelty. Ask: 'What's one new thing we can do?' or 'What's on your mind today?'");
    }
    if (answers.r_chatter <= 2) {
      feedback.push("<b>'Chatter' is High:</b> A low score means your internal overthinking is high. **Dr. Ethan Kross's** work shows this is *your* work to do. Use 'distanced self-talk' (e.g., 'John, you are feeling anxious, it's not a fact') to manage this *before* bringing it to your partner as blame.");
    }
    if (answers.r_growth <= 2) {
      feedback.push("<b>Rut Alert:</b> You're not growing. **Dr. Lewandowski's** 'self-expansion' model shows that couples who grow together, stay together. The 'spark' (**Perel**) comes from new experiences. Plan a date to learn or do something new, even if it's small.");
    }
    if (answers.r_support <= 2) {
      feedback.push("<b>Support System Low:</b> **Dr. Waldinger's** 85-year Harvard study proves that secure, supportive relationships are the #1 predictor of a long, healthy life. This is critical. Ask your partner: 'What does a 5/5 level of support look like for you today?'");
    }
    
    if (feedback.length === 0 && percentage >= 70) {
      feedback.push("<b>You are 'Tungsten.'</b> Your scores reflect a strong, resilient, and connected relationship. You are actively managing conflict, connection, and growth. Keep doing what you're doing.");
    } else if (feedback.length === 0) {
      feedback.push("<b>You are 'Coasting.'</b> Nothing is critically wrong, but the spark is low. Re-read the advice for 'Connection' and 'Growth' and pick one small action to take today.");
    }

    return {
      score: percentage,
      pill: `Connection: ${pill}`,
      summary: pill.toUpperCase(),
      feedback: feedback.map(f => `<p>${f}</p>`).join('')
    };
  }

  function _calculateMacros(appState) {
    const { sex, age, activity, protEmphasis, sleepLast, sessionMin, sessionType, cycle } = appState;
    const kg = state.weightKg;
    const cm = state.heightCm;
    const s = sex === 'male' ? 5 : -161;
    const bmr = (10 * kg) + (6.25 * cm) - (5 * age) + s;
    const tdee = bmr * (ACTIVITY[activity] || 1.55);
    const goal = inferGoal(state.weightLb, state.goalWeightLb);
    const goalKg = state.goalWeightKg;
    let targetKcal;
    if (goal === 'cut') targetKcal = tdee - 450;
    else if (goal === 'bulk') targetKcal = tdee + 350;
    else targetKcal = tdee;

    const sleepHours = sleepLast;
    const soreness = state.answers.soreness;
    const baseProt = goal === 'cut' ? 2.1 : (goal === 'bulk' ? 1.8 : 2.0);
    const emphBump = protEmphasis === 'very' ? 0.5 : (protEmphasis === 'high' ? 0.25 : 0.0);
    
    let add = 0;
    if (sleepHours < 7) add += 0.15;
    if (sessionMin >= 75 || ['hypertrophy', 'endurance', 'competition', 'power'].includes(sessionType)) add += 0.10;
    if (soreness >= 4) add += 0.10;
    if (goal === 'cut') add += 0.10;

    const protModel = clamp(baseProt + emphBump + add, 1.6, 2.7);
    let protPerKg = protModel;
    if (sex === 'female' && cycle === 'luteal' && goal !== 'cut') {
      protPerKg = Math.min(2.7, protPerKg + 0.15);
    }
    
    const gP = protPerKg * goalKg;
    const kcalP = gP * 4;
    const gF = FAT_PER_KG * kg;
    const kcalF = gF * 9;
    const kcalC = targetKcal - kcalP - kcalF;
    const gC = kcalC / 4;
    const gFiber = (targetKcal / 1000) * FIBER_PER_1000_KCAL;
    
    return {
      bmr: r(bmr), tdee: r(tdee), targetKcal: r(targetKcal),
      protModel: r(protModel, 2), gP: r(gP), gC: r(gC), gF: r(gF), gFiber: r(gFiber),
      goal: goal.toUpperCase(),
      protNotes: `Protein (g/kg) logic: ${r(baseProt,2)} (base) + ${r(emphBump,2)} (emph) + ${r(add,2)} (dynamic) = ${r(protModel,2)} g/kg.`
    };
  }
  
  function inferGoal(currentLb, goalLb) {
    const cut = currentLb * 0.97;
    const bulk = currentLb * 1.03;
    return goalLb <= cut ? 'cut' : (goalLb >= bulk ? 'bulk' : 'maintain');
  }

  function _calculateHR(appState) {
    const { age, rhr, sessionType } = appState;
    const hrMax = 220 - age;
    const hrRest = rhr || (hrMax * 0.35);
    const hrr = hrMax - hrRest;
    const hasRHR = !!rhr;
    
    const z2_low = hasRHR ? (hrr * 0.60) + hrRest : hrMax * 0.70;
    const z2_high = hasRHR ? (hrr * 0.70) + hrRest : hrMax * 0.80;
    const z5_low = hasRHR ? (hrr * 0.90) + hrRest : hrMax * 0.90;
    const z5_high = hrMax;
    
    let prescription = '';
    let zoneSum = 'Z2/Z5';
    if (sessionType === 'endurance') {
      prescription = `<b>Endurance Focus:</b> Aim for 30–60+ min in Zone 2 (${r(z2_low)}–${r(z2_high)} bpm).`;
      zoneSum = 'Z2';
    } else if (sessionType === 'power') {
      prescription = `<b>Power/Sprint Focus:</b> Work in Zone 5 (${r(z5_low)}–${r(z5_high)} bpm) for short bursts (e.g., 8x 30s ON, 90s OFF).`;
      zoneSum = 'Z5';
    } else if (sessionType === 'hypertrophy') {
      prescription = `<b>Hypertrophy/Strength:</b> Heart rate is secondary to lifting. Zone 2 (${r(z2_low)}–${r(z2_high)} bpm) for active recovery or warm-up.`;
    } else {
      prescription = `<b>Recovery Day:</b> Optional 20–30 min in Zone 2 (${r(z2_low)}–${r(z2_high)} bpm) to promote blood flow.`;
    }
    
    const zones = [
      { z: 'Z1', pct: '50–60%', bpm: `${r(hrMax*0.5)}–${r(hrMax*0.6)}` },
      { z: 'Z2', pct: '60–70%', bpm: `<b>${r(z2_low)}–${r(z2_high)}</b>` },
      { z: 'Z3', pct: '70–80%', bpm: `${r(hrMax*0.7)}–${r(hrMax*0.8)}` },
      { z: 'Z4', pct: '80–90%', bpm: `${r(hrMax*0.8)}–${r(hrMax*0.9)}` },
      { z: 'Z5', pct: '90–100%', bpm: `<b>${r(z5_low)}–${r(z5_high)}</b>` }
    ];

    return { hrMax, hrRest, zones, prescription, zoneSum };
  }
  
  function getAgeGroup(age) {
    if (age <= 25) return '18-25';
    if (age <= 35) return '26-35';
    if (age <= 45) return '36-45';
    if (age <= 55) return '46-55';
    if (age <= 65) return '56-65';
    return '65+';
  }

  function classifyVO2(vo2, sex, ageGroup) {
    const thresholds = VO2_CLASSIFICATION[sex][ageGroup];
    if (vo2 >= thresholds[3]) return 'Superior';
    if (vo2 >= thresholds[2]) return 'Excellent';
    if (vo2 >= thresholds[1]) return 'Good';
    if (vo2 >= thresholds[0]) return 'Fair';
    return 'Poor';
  }
  
  function _calculateVO2(appState) {
    const { age, rhr, sex, sessionType } = appState;
    const hrMax = 220 - age;
    let vo2max = null, classification = 'N/A', target = '', vo2Sum = '...';
    let vo2note = 'Enter Resting HR (RHR) for a VO₂max estimate.';

    if (rhr && rhr > 0) {
      vo2max = 15.3 * (hrMax / rhr);
      const ageGroup = getAgeGroup(age);
      classification = classifyVO2(vo2max, sex, ageGroup);
      vo2note = `Estimated using the Heart Rate Ratio method (15.3 * [HRmax / RHR]). Classification is based on Cooper Institute data for your age and sex.`;
    }
    
    switch (sessionType) {
      case 'endurance':
        target = '<b>VO₂max Focus:</b> Today is ideal for VO₂max work. Aim to accumulate 3-5 minute intervals in Zone 5 (90-100% HRmax).<br><b>Example:</b> 4 repeats of [4 min @ 90-95% HRmax] + [3 min active recovery @ 70% HRmax].';
        vo2Sum = 'Z5 Work';
        break;
      case 'power':
        target = '<b>Power/Sprint Focus:</b> Today\'s HIIT will significantly tax VO₂max. Focus on maximal power output during intervals.<br><b>Example:</b> 8-10 repeats of [30 sec all-out sprint] + [90 sec light recovery].';
        vo2Sum = 'HIIT';
        break;
      case 'competition':
        target = '<b>Competition Day:</b> Your VO₂max is a result of your training. Focus on your event plan and execution. Good luck!';
        vo2Sum = 'Compete';
        break;
      default:
        target = '<b>Goal:</b> VO₂max is not the primary target. Focus on today\'s session goal (e.g., strength, recovery).';
        vo2Sum = 'N/A';
        break;
    }

    return { vo2max: r(vo2max, 1), classification, target, vo2note, vo2Sum };
  }
  
  function coldPlungePlanner({sex,goal,sessionType,readiness,soreness,cycle}){const rec={recommend:false,rationale:'',timing:'',tempC:10,tempF:50,durationMin:0};const lowReadiness=readiness<3,highSoreness=soreness>=4,growth=(goal==='bulk'||sessionType==='hypertrophy');if(growth){rec.recommend=highSoreness||lowReadiness;rec.rationale='Growth focus: avoid immediate post-lift cold; use for soreness/fatigue if needed.';rec.timing='If used: 6–12+ h after lifting or next morning.';rec.durationMin=rec.recommend?6:0;}else if(['competition','endurance','power'].includes(sessionType)){rec.recommend=true;rec.rationale='Recovery/turnaround focus.';rec.timing='Within 0–60 min post-session or later in day.';rec.durationMin=6;}else if(sessionType==='recovery'){rec.recommend=true;rec.rationale='Recovery day; short, moderate cold.';rec.timing='Any time, earlier in day.';rec.durationMin=5;}if(sex==='female'&&cycle==='luteal'){rec.tempC=12;rec.tempF=54;if(rec.durationMin>0)rec.durationMin=Math.max(4,rec.durationMin-1);rec.rationale+=' Luteal: slightly warmer/shorter.';}if(!rec.recommend)rec.durationMin=0;return rec;}
  function breathingPlanner({stress,anxiety,readiness,sleepDebt}){const needDown=(readiness<3||stress>=4||anxiety>=4||sleepDebt>1);const bagKey='breath-'+todayKey+'-'+(needDown?'down':'focus');const picks=nonRepeatingPick(bagKey,needDown?BREATH.downshift:BREATH.focus,3);const focus=needDown?'Downshift':'Up-regulate / Focus';return{focus,items:picks};}
  function scripturePlanner(ctx){const picks=[];const add=(theme,count)=>{if(!NKJV[theme])return;const key='script-'+todayKey+'-'+theme;picks.push(...nonRepeatingPick(key,NKJV[theme],count));};const {stress,anxiety,moodLow,confidenceLow,distractionHigh,supportLow,driveLow,readinessHigh,competitionDay,recoveryDay,purposeLow,calmLow,fatigueHigh}=ctx;if(competitionDay)add('victory',2);if(readinessHigh)add('strength',1);if(confidenceLow)add('courage',1);if(stress||anxiety)add('peace',1);if(moodLow||fatigueHigh)add('recovery',1);if(purposeLow||distractionHigh)add('focus',1);if(supportLow)add('help',1);if(driveLow)add('endurance',1);if(!picks.length)add('hope',1);return picks.slice(0,6);}
  function selfTalkPlanner(sex,answers){const bank=SELF_TALK[sex];const out=[];const low=(k)=>Number(answers[k]||3)<=2;const high=(k)=>Number(answers[k]||3)>=4; if(low('conf')) out.push(bank.boost[0]); if(high('distraction')) out.push(bank.focus[0]); if(high('stress')||high('anxiety')) out.push(bank.calm[0]); if(low('drive')) out.push(bank.grit[0]); if(out.length<2) out.push(bank.boost[1]||bank.focus[1]); return out.slice(0,3);}
  function dayPlan({goal,sessionType,readiness,soreness,sleepDebt}){const blocks=[];if(readiness<2.5||sleepDebt>1.5){blocks.push({label:'Training',text:'Easy day: technique + mobility + Zone 2 (15–25 min). Optional light accessories.'});}else if(soreness>=4){blocks.push({label:'Training',text:'Reduce volume 25–40%. Keep intensity moderate. Emphasize long rest and form.'});}else{let txt='Proceed as planned.';if(goal==='cut'&&sessionType==='hypertrophy')txt+=' Maintain intensity, reduce volume slightly if low energy.';blocks.push({label:'Training',text:txt});}if(readiness<3)blocks.push({label:'Mindset',text:'Focus on execution, not outcome. Control breath.'});return blocks;}
  function cycleSupplements(cycle){const items=[];if(cycle==='menstruation')items.push('<b>Iron:</b> Key due to blood loss (check levels). <b>Magnesium:</b> May help cramps. <b>Omega-3:</b> Anti-inflammatory.');else if(cycle==='follicular')items.push('<b>Baseline:</b> Focus on whole-food nutrients. <b>Vitamin D:</b> If deficient. <b>Probiotics:</b> Gut health.');else if(cycle==='ovulatory')items.push('<b>Peak Energy:</b> Ensure adequate hydration/electrolytes. <b>Magnesium:</b> Supports energy & sleep.');else if(cycle==='luteal')items.push('<b>Magnesium:</b> May help PMS, sleep. <b>B-Vitamins (B6):</b> Mood support. <b>Calcium:</b> PMS support. <b>Omega-3:</b> Mood/inflammation.');return items;}


  /***** MAIN APP LOGIC *****/
  function recalculate() {
    const readiness = _calculateReadiness(state.answers, state.sleepLast);
    const macros = _calculateMacros(state);
    const hr = _calculateHR(state);
    const vo2 = _calculateVO2(state);
    const relationship = _calculateRelationship(state.relationshipAnswers); // NEW
    
    const goal = inferGoal(state.weightLb, state.goalWeightLb);
    const coldPlan = coldPlungePlanner({
      sex: state.sex, goal: goal, sessionType: state.sessionType,
      readiness: state.answers.readiness, soreness: state.answers.soreness, cycle: state.cycle
    });
    
    const breathPlan = breathingPlanner({
      stress: state.answers.stress, anxiety: state.answers.anxiety,
      readiness: state.answers.readiness, sleepDebt: readiness.sleepDebt
    });

    const scriptCtx = {
      stress: state.answers.stress >= 4, anxiety: state.answers.anxiety >= 4,
      moodLow: state.answers.mood <= 2, confidenceLow: state.answers.conf <= 2,
      distractionHigh: state.answers.distraction >= 4, supportLow: state.answers.support <= 2,
      driveLow: state.answers.drive <= 2, readinessHigh: state.answers.readiness >= 4,
      competitionDay: state.sessionType === 'competition', recoveryDay: state.sessionType === 'recovery',
      purposeLow: state.answers.purpose <= 2, calmLow: state.answers.calm <= 2, fatigueHigh: state.answers.fatigue >= 4,
    };
    const scripturePlan = scripturePlanner(scriptCtx);
    const talkPlan = selfTalkPlanner(state.sex, state.answers);
    const prayerPlan = nonRepeatingPick('prayer-' + todayKey, PRAYERS, 1);
    const plan = dayPlan({
      goal: goal, sessionType: state.sessionType,
      readiness: state.answers.readiness, soreness: state.answers.soreness, sleepDebt: readiness.sleepDebt
    });

    render({
      readiness, macros, hr, vo2, coldPlan, relationship,
      breathPlan, scripturePlan, talkPlan, prayerPlan, plan
    });
  }

  function render(results) {
    const { readiness, macros, hr, vo2, coldPlan, relationship, breathPlan, scripturePlan, talkPlan, prayerPlan, plan } = results;

    // Readiness
    updateText('readinessPill', readiness.pill);
    
    // *** NEW: Relationship ***
    updateText('relationshipPill', relationship.pill);
    els.relationshipFeedback.innerHTML = relationship.feedback;

    // Macros
    updateText('goalTag', macros.goal);
    updateHTML('bmr', macros.bmr, ' kcal');
    updateHTML('tdee', macros.tdee, ' kcal');
    updateHTML('target', macros.targetKcal, ' kcal');
    updateHTML('protModel', macros.protModel, ' g/kg');
    updateHTML('gP', macros.gP, 'g');
    updateHTML('gC', macros.gC, 'g');
    updateHTML('gF', macros.gF, 'g');
    updateHTML('gFiber', macros.gFiber, 'g');
    updateText('protNotes', macros.protNotes);

    // HR & Zones
    updateHTML('hrMax', hr.hrMax, ' bpm');
    updateHTML('hrRest', state.rhr ? hr.hrRest : `${r(hr.hrRest)} (est.)`, ' bpm');
    els.zonePrescription.innerHTML = hr.prescription;
    els.zoneTable.innerHTML = hr.zones.map(z => 
      `<div class="kpi"><small>${z.z} (${z.pct})</small><b>${z.bpm}</b></div>`
    ).join('');

    // VO2
    updateHTML('vo2max', vo2.vo2max, ' ml/kg/min');
    updateText('vo2class', vo2.classification);
    updateText('vo2note', vo2.vo2note);
    els.vo2target.innerHTML = vo2.target;

    // Cold Plunge
    updateText('coldYesNo', coldPlan.recommend ? 'Yes' : 'No');
    updateText('coldTiming', coldPlan.recommend ? coldPlan.timing : 'N/A');
    updateText('coldWhy', coldPlan.rationale);
    display(els.coldExtra, coldPlan.recommend);
    if (coldPlan.recommend) {
      const tempUnit = state.units === 'us' ? '°F' : '°C';
      const temp = state.units === 'us' ? coldPlan.tempF : coldPlan.tempC;
      updateText('coldTemp', `${temp} ${tempUnit}`);
      updateHTML('coldDur', coldPlan.durationMin, ' min');
    }
    
    // Day Plan
    els.planBlocks.innerHTML = plan.map(p => `<div><h3>${p.label}</h3><p>${p.text}</p></div>`).join('');

    // Breathing
    els.breathBlock.innerHTML = `<h3>${breathPlan.focus}</h3>` + breathPlan.items.map(b => 
      `<div class="verse"><b>${b.title} (${b.duration}):</b> ${b.detail}</div>`
    ).join('');
    
    // Scripture, Talk, Prayer
    els.scripture.innerHTML = scripturePlan.map(v => 
      `<div class="verse"><p>${v.txt}</p><small>— ${v.ref}</small></div>`
    ).join('');
    els.selfTalk.innerHTML = talkPlan.map(t => `<div class="verse"><p>${t}</p></div>`).join('');
    els.prayer.innerHTML = prayerPlan.map(p => `<div class="verse"><p>${p}</p></div>`).join('');
    
    // Cycle Supplements
    const supps = cycleSupplements(state.cycle);
    els.cycleSupp.innerHTML = supps.map(s => `<li>${s}</li>`).join('');
    display(els.cycleSuppCard, state.sex === 'female');

    // Hydration
    const hBase = state.weightLb / 2;
    const hExtra = (state.sessionMin / 30) * 12;
    const hTotal = hBase + hExtra;
    const isUS = state.units === 'us';
    const hDiv = isUS ? 128 : 33.814;
    const hLabel = isUS ? 'gal' : 'L';
    
    updateHTML('hBase', r(hBase / hDiv, 1), ` ${hLabel}`);
    updateHTML('hExtra', r(hExtra / hDiv, 1), ` ${hLabel}`);
    updateHTML('hTotal', r(hTotal / hDiv, 1), ` ${hLabel}`);
    updateHTML('hNa', r(state.sessionMin * 1.5, 0), ' mg (session)');

    // Sleep
    const sleepBase = state.sex === 'female' ? 8.5 : 7.8;
    const sleepNeed = clamp(sleepBase + (state.sessionMin / 60) * 0.2 - (state.sleepLast - sleepBase), 7.5, 9.5);
    updateHTML('sleepNeed', r(sleepNeed, 1));
    els.sleepBreath.textContent = breathPlan.focus === 'Downshift' ? 
      `5–10 min: ${breathPlan.items[0].title}` : 
      '5–10 min downshift breathing';
    els.sleepDeepDive.innerHTML = `<b>Sleep Focus:</b> Prioritize ${r(sleepNeed,1)} hours. Your readiness score was ${readiness.score}%. ${readiness.sleepDebt > 0 ? `You have ~${r(readiness.sleepDebt,1)}h sleep debt.` : 'No sleep debt detected.'}`;

    // Weekly Tracker
    updateHTML('wkZ2Goal', 150, ' min');
    updateHTML('wkZ5Goal', 15, ' min');
    updateText('wkDone', `Z2: ${state.weeklyZ2} / Z5: ${state.weeklyZ5}`);

    // Sticky Summary
    updateHTML('sumTarget', macros.targetKcal, ' kcal');
    updateText('sumPCF', `${macros.gP}/${macros.gC}/${macros.gF} g`);
    updateHTML('sumFiber', macros.gFiber, ' g');
    updateHTML('sumSleep', r(sleepNeed, 1), ' h');
    updateText('sumZone', hr.zoneSum);
    updateText('sumVo2', vo2.vo2Sum);
    updateText('sumWeek', `${state.weeklyZ2}/${state.weeklyZ5}m`);
    updateText('sumRelationship', relationship.summary); // NEW
    updateHTML('sumReadiness', readiness.score, '%'); // NEW
  }

  /***** EVENT LISTENERS *****/
  function handleInputChange(e) {
    const { id, value, type } = e.target;
    
    if (type === 'number') {
      state[id] = value ? Number(value) : null;
    } else {
      state[id] = value;
    }

    if (id === 'heightFt' || id === 'heightIn') {
      state.heightCm = r(cmFromFtIn(state.heightFt, state.heightIn), 1);
      els.heightCm.value = state.heightCm;
    }
    else if (id === 'heightCm') {
      const { ft, inch } = ftInFromCm(state.heightCm);
      state.heightFt = ft;
      state.heightIn = inch;
      els.heightFt.value = ft;
      els.heightIn.value = inch;
    }
    else if (id === 'weightLb') {
      state.weightKg = r(kgFromLbs(state.weightLb), 1);
      els.weightKg.value = state.weightKg;
    }
    else if (id === 'weightKg') {
      state.weightLb = r(lbsFromKg(state.weightKg), 1);
      els.weightLb.value = state.weightLb;
    }
    else if (id === 'goalWeightLb') {
      state.goalWeightKg = r(kgFromLbs(state.goalWeightLb), 1);
      els.goalWeightKg.value = state.goalWeightKg;
    }
    else if (id === 'goalWeightKg') {
      state.goalWeightLb = r(lbsFromKg(state.goalWeightKg), 1);
      els.goalWeightLb.value = state.goalWeightLb;
    }
    else if (id === 'sex') {
      els.cycleWrap.style.display = state.sex === 'female' ? 'grid' : 'none';
    }

    recalculateAndSave();
  }
  
  function handleUnitToggle() {
    state.units = state.units === 'us' ? 'metric' : 'us';
    toggleUnitViews(state.units);
    recalculateAndSave();
  }
  
  function handleWeeklyButton(type) {
    if (type === 'reset') {
      state.weeklyZ2 = 0;
      state.weeklyZ5 = 0;
    } else if (type === 'z2') {
      state.weeklyZ2 += 5;
    } else if (type === 'z5') {
      state.weeklyZ5 += 1;
    }
    recalculateAndSave();
  }

  function recalculateAndSave() {
    recalculate();
    saveState();
  }

  function exportPlan() {
    els.exportBtn.textContent = 'Printing...';
    window.print();
    setTimeout(() => { els.exportBtn.textContent = 'Print / Share'; }, 1000);
  }
  
  function copyPlan() {
    els.copyBtn.textContent = 'Copied!';
    setTimeout(() => { els.copyBtn.textContent = 'Copy Plan'; }, 1200);
  }
  
  function toggleIdeas() {
    const show = els.ideas.classList.toggle('hide');
    els.ideasBtn.textContent = show ? 'Meal Ideas' : 'Hide Ideas';
    if (!show && els.ideas.innerHTML === '') {
      els.ideas.innerHTML = Object.keys(MEALS).map(k =>
        `<h3>${k.charAt(0).toUpperCase() + k.slice(1)}</h3><ul>` +
        nonRepeatingPick('meals-' + k, MEALS[k], 4).map(m => `<li>${m}</li>`).join('') +
        '</ul>'
      ).join('');
    }
  }

  /***** INITIALIZATION *****/
  function init() {
    loadState();
    syncDomFromState();
    buildLikert();
    buildRelationshipLikert(); // NEW
    recalculate();
    
    const inputs = ['sex','age','rhr','heightFt','heightIn','heightCm','weightLb','goalWeightLb','weightKg','goalWeightKg','activity','sleepLast','sessionType','sessionMin','cycle','protEmphasis'];
    inputs.forEach(id => els[id]?.addEventListener('input', handleInputChange));
    
    els.unitsBtn.addEventListener('click', handleUnitToggle);
    els.exportBtn.addEventListener('click', exportPlan);
    els.copyBtn.addEventListener('click', copyPlan);
    els.ideasBtn.addEventListener('click', toggleIdeas);
    
    els.addZ2.addEventListener('click', () => handleWeeklyButton('z2'));
    els.addZ5.addEventListener('click', () => handleWeeklyButton('z5'));
    els.resetWeek.addEventListener('click', () => handleWeeklyButton('reset'));
  }

  init();

})();
</script>
</body>
</html>
